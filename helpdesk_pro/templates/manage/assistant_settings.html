{% extends "base.html" %}
{% block content %}

<style>
  .assistant-card {
    max-width: 960px;
    margin: 0 auto;
  }
  .assistant-provider-option {
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 0.75rem;
    padding: 1rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  .assistant-provider-option.active {
    border-color: #0d6efd;
    box-shadow: 0 0 0 2px rgba(13,110,253,0.15);
  }
  textarea.form-control {
    min-height: 120px;
  }
</style>

<div class="assistant-card">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="fa fa-robot"></i> {{ _('AI Assistant Widget') }}</h4>
    <a href="{{ url_for('manage.access') }}?lang={{ g.locale }}" class="btn btn-outline-secondary">
      <i class="fa fa-key"></i> {{ _('Access Control') }}
    </a>
  </div>

  <div class="alert alert-info shadow-sm">
    <i class="fa fa-info-circle"></i>
    {{ _('Configure the floating assistant widget. Use the Access page to limit visibility to specific roles.') }}
  </div>

  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="card shadow-sm">
      <div class="card-header">
        <strong>{{ _('Widget Appearance') }}</strong>
      </div>
      <div class="card-body">
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" role="switch" id="is_enabled" name="is_enabled" {% if config.is_enabled %}checked{% endif %}>
          <label class="form-check-label" for="is_enabled">
            {{ _('Enable assistant widget') }}
          </label>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">{{ _('Button label') }}</label>
            <input type="text" class="form-control" name="button_label" value="{{ config.button_label }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ _('Window title') }}</label>
            <input type="text" class="form-control" name="window_title" value="{{ config.window_title }}">
          </div>
          <div class="col-md-12">
            <label class="form-label">{{ _('Welcome message') }}</label>
            <textarea class="form-control" name="welcome_message">{{ config.welcome_message or '' }}</textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ _('Button position') }}</label>
            <select class="form-select" name="position">
              <option value="right" {% if config.position == 'right' %}selected{% endif %}>{{ _('Bottom right') }}</option>
              <option value="left" {% if config.position == 'left' %}selected{% endif %}>{{ _('Bottom left') }}</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-header">
        <strong>{{ _('Provider') }}</strong>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="assistant-provider-option {% if config.provider == 'chatgpt' %}active{% endif %}">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="provider" id="provider_chatgpt" value="chatgpt" {% if config.provider == 'chatgpt' %}checked{% endif %}>
                <label class="form-check-label fw-semibold" for="provider_chatgpt">
                  <i class="fa fa-brain text-primary"></i> {{ _('OpenAI ChatGPT API') }}
                </label>
              </div>
              <div class="mt-3">
                <label class="form-label">{{ _('API key') }}</label>
                <input type="password" class="form-control" name="openai_api_key" value="{{ config.openai_api_key or '' }}" placeholder="sk-***">
              </div>
              <div class="mt-3">
                <label class="form-label">{{ _('Model') }}</label>
                <input type="text" class="form-control" name="openai_model" value="{{ config.openai_model or 'gpt-3.5-turbo' }}">
              </div>
              <small class="text-muted d-block mt-2">
                {{ _('Requests are proxied through this server; the API key is stored in the database, so restrict access to administrators you trust.') }}
              </small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="assistant-provider-option {% if config.provider == 'webhook' %}active{% endif %}">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="provider" id="provider_webhook" value="webhook" {% if config.provider != 'chatgpt' %}checked{% endif %}>
                <label class="form-check-label fw-semibold" for="provider_webhook">
                  <i class="fa fa-diagram-project text-success"></i> {{ _('Custom webhook (n8n, etc.)') }}
                </label>
              </div>
              <div class="mt-3">
                <label class="form-label">{{ _('Webhook URL') }}</label>
                <input type="url" class="form-control" name="webhook_url" value="{{ config.webhook_url or '' }}" placeholder="https://flow.example.com/webhook/ai">
              </div>
              <div class="mt-3">
                <label class="form-label">{{ _('HTTP method') }}</label>
                <select class="form-select" name="webhook_method">
                  <option value="POST" {% if config.webhook_method == 'POST' %}selected{% endif %}>POST</option>
                  <option value="GET" {% if config.webhook_method == 'GET' %}selected{% endif %}>GET</option>
                </select>
              </div>
              <div class="mt-3">
                <label class="form-label">{{ _('Custom headers (JSON)') }}</label>
                <textarea class="form-control" name="webhook_headers" placeholder='{"Authorization": "Bearer ..."}'>{{ headers_pretty }}</textarea>
              </div>
              <small class="text-muted d-block mt-2">
                {{ _('The webhook receives JSON payloads with the current message, history, and user context. It must return JSON with a "reply" field.') }}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <div class="d-flex align-items-start gap-3">
          <i class="fa fa-shield-halved text-warning fa-2x"></i>
          <div>
            <strong>{{ _('Role visibility') }}</strong>
            <p class="mb-0 text-muted">
              {{ _('Use the Access Control page to choose which roles can see the assistant widget (entry: "AI Assistant Widget").') }}
            </p>
          </div>
        </div>
      </div>
      <div class="card-footer text-end">
        <button type="submit" class="btn btn-primary">
          <i class="fa fa-save me-1"></i> {{ _('Save Settings') }}
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  document.querySelectorAll('.assistant-provider-option input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', (event) => {
      document.querySelectorAll('.assistant-provider-option').forEach(card => card.classList.remove('active'));
      event.target.closest('.assistant-provider-option').classList.add('active');
    });
  });
</script>

{% endblock %}
