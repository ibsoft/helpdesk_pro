{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="mb-0"><i class="fa fa-key text-primary"></i> {{ _('API Keys') }}</h3>
  <a href="{{ url_for('manage.api_keys') }}" class="btn btn-outline-secondary btn-sm">
    <i class="fa fa-rotate"></i> {{ _('Refresh') }}
  </a>
</div>

{% if new_key_value %}
  <div class="alert alert-warning border-warning shadow-sm">
    <h5 class="alert-heading"><i class="fa fa-exclamation-triangle"></i> {{ _('New API key generated') }}</h5>
    <p class="mb-1">{{ _('Copy this key now. For security reasons it will not be shown again.') }}</p>
    <pre class="mb-0 bg-dark text-warning p-3 rounded small">{{ new_key_value }}</pre>
  </div>
{% endif %}

<div class="card shadow-sm mb-4">
  <div class="card-header bg-primary-subtle text-primary-emphasis">
    <strong><i class="fa fa-plus-circle"></i> {{ _('Create API Client') }}</strong>
  </div>
  <form method="post" class="card-body row g-3">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="action" value="create">
    <div class="col-md-4">
      <label class="form-label">{{ _('Integration name') }}</label>
      <input type="text" class="form-control" name="name" placeholder="{{ _('e.g. ServiceNow bridge') }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ _('Default user context') }}</label>
      <select class="form-select" name="default_user_id">
        <option value="">{{ _('None (API must supply actor)') }}</option>
        {% for user in users %}
          <option value="{{ user.id }}">{{ user.username }} ({{ user.role }})</option>
        {% endfor %}
      </select>
      <div class="form-text">{{ _('Used when requests omit created_by / updated_by.') }}</div>
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ _('Description (optional)') }}</label>
      <input type="text" class="form-control" name="description">
    </div>
    <div class="col-12 text-end">
      <button type="submit" class="btn btn-primary"><i class="fa fa-key"></i> {{ _('Generate Key') }}</button>
    </div>
  </form>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <strong><i class="fa fa-database"></i> {{ _('Existing API Clients') }}</strong>
    <span class="small text-muted">{{ clients|length }} {{ _('client(s) total') }}</span>
  </div>
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>{{ _('Name') }}</th>
          <th>{{ _('Prefix') }}</th>
          <th>{{ _('Default User') }}</th>
          <th>{{ _('Created') }}</th>
          <th>{{ _('Last used') }}</th>
          <th>{{ _('Status') }}</th>
          <th class="text-end">{{ _('Actions') }}</th>
        </tr>
      </thead>
      <tbody>
        {% if not clients %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              <i class="fa fa-circle-info"></i> {{ _('No API clients yet. Generate one using the form above.') }}
            </td>
          </tr>
        {% else %}
          {% for client in clients %}
            <tr>
              <td>
                <strong>{{ client.name }}</strong>
                {% if client.description %}
                  <div class="text-muted small">{{ client.description }}</div>
                {% endif %}
              </td>
              <td><code>{{ client.prefix }}</code></td>
              <td>
                {% if client.default_user %}
                  <span class="badge bg-primary-subtle text-primary-emphasis"><i class="fa fa-user"></i> {{ client.default_user }}</span>
                {% else %}
                  <span class="text-muted small">{{ _('None') }}</span>
                {% endif %}
              </td>
              <td class="small text-muted">{{ client.created_at.strftime('%Y-%m-%d %H:%M') if client.created_at else 'â€”' }}</td>
              <td class="small text-muted">
                {% if client.last_used_at %}
                  {{ client.last_used_at.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  <span class="text-muted">{{ _('Never') }}</span>
                {% endif %}
              </td>
              <td>
                {% if client.revoked_at %}
                  <span class="badge bg-danger"><i class="fa fa-ban"></i> {{ _('Revoked') }}</span>
                {% else %}
                  <span class="badge bg-success"><i class="fa fa-check"></i> {{ _('Active') }}</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="d-flex gap-1 justify-content-end flex-wrap">
                  <form method="post" class="d-inline-flex gap-1">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="update">
                    <input type="hidden" name="client_id" value="{{ client.id }}">
                    <input type="hidden" name="name" value="{{ client.name }}">
                    <input type="hidden" name="description" value="{{ client.description }}">
                    <input type="hidden" name="default_user_id" value="{{ client.default_user_id or '' }}">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editClientModal{{ client.id }}">
                      <i class="fa fa-pen"></i> {{ _('Edit') }}
                    </button>
                  </form>
                  <form method="post" onsubmit="return confirm('{{ _('Rotate key for this client? The previous key will stop working immediately.') }}');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="rotate">
                    <input type="hidden" name="client_id" value="{{ client.id }}">
                    <button type="submit" class="btn btn-outline-primary btn-sm">
                      <i class="fa fa-sync"></i> {{ _('Rotate') }}
                    </button>
                  </form>
                  {% if client.revoked_at %}
                    <form method="post" onsubmit="return confirm('{{ _('Generate a new key and reactivate this client?') }}');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <input type="hidden" name="action" value="rotate">
                      <input type="hidden" name="client_id" value="{{ client.id }}">
                      <button type="submit" class="btn btn-outline-success btn-sm">
                        <i class="fa fa-unlock"></i> {{ _('Reactivate') }}
                      </button>
                    </form>
                  {% else %}
                    <form method="post" onsubmit="return confirm('{{ _('Revoke this API key? Integration will lose access immediately.') }}');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <input type="hidden" name="action" value="revoke">
                      <input type="hidden" name="client_id" value="{{ client.id }}">
                      <button type="submit" class="btn btn-outline-warning btn-sm">
                        <i class="fa fa-ban"></i> {{ _('Revoke') }}
                      </button>
                    </form>
                  {% endif %}
                  <form method="post" onsubmit="return confirm('{{ _('Delete this API client? This cannot be undone.') }}');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="client_id" value="{{ client.id }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                      <i class="fa fa-trash"></i> {{ _('Delete') }}
                    </button>
                  </form>
                </div>
              </td>
            </tr>

            <div class="modal fade" id="editClientModal{{ client.id }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <form method="post" class="modal-content border-0 shadow-lg">
                  <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="fa fa-pen-to-square"></i> {{ _('Edit API Client') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
                  </div>
                  <div class="modal-body py-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="update">
                    <input type="hidden" name="client_id" value="{{ client.id }}">
                    <div class="mb-3">
                      <label class="form-label">{{ _('Name') }}</label>
                      <input type="text" class="form-control" name="name" value="{{ client.name }}">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">{{ _('Description') }}</label>
                      <input type="text" class="form-control" name="description" value="{{ client.description or '' }}">
                    </div>
                    <div class="mb-0">
                      <label class="form-label">{{ _('Default user context') }}</label>
                      <select class="form-select" name="default_user_id">
                        <option value="">{{ _('None') }}</option>
                        {% for user in users %}
                          <option value="{{ user.id }}" {% if client.default_user_id == user.id %}selected{% endif %}>{{ user.username }} ({{ user.role }})</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Save changes') }}</button>
                  </div>
                </form>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
