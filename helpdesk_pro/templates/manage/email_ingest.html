{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-3"><i class="fa fa-envelope-open-text me-2"></i>{{ _("Email to Ticket") }}</h1>
  <p class="text-muted">{{ _("Automatically convert incoming emails into Helpdesk tickets.") }}</p>

  <form method="post" class="card shadow-sm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3 form-check form-switch">
          <input class="form-check-input" type="checkbox" id="is_enabled" name="is_enabled" value="1" {% if config.is_enabled %}checked{% endif %}>
          <label class="form-check-label" for="is_enabled">{{ _("Enable polling service") }}</label>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="protocol">{{ _("Protocol") }}</label>
          <select class="form-select" id="protocol" name="protocol">
            <option value="imap" {% if config.protocol == "imap" %}selected{% endif %}>IMAP</option>
            <option value="pop3" {% if config.protocol == "pop3" %}selected{% endif %}>POP3</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="mailbox">{{ _("Mailbox / Folder") }}</label>
          <input class="form-control" id="mailbox" name="mailbox" value="{{ config.mailbox or 'INBOX' }}">
          <small class="text-muted">{{ _("For IMAP this is the folder to monitor (default INBOX).") }}</small>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="host">{{ _("Mail server host") }}</label>
          <input class="form-control" id="host" name="host" value="{{ config.host or '' }}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="port">{{ _("Port") }}</label>
          <input class="form-control" id="port" name="port" value="{{ config.port or '' }}" placeholder="{{ _('Auto') }}">
        </div>
        <div class="col-md-3 form-check form-switch">
          <input class="form-check-input" type="checkbox" id="use_ssl" name="use_ssl" value="1" {% if config.use_ssl %}checked{% endif %}>
          <label class="form-check-label" for="use_ssl">{{ _("Use SSL/TLS") }}</label>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="username">{{ _("Username") }}</label>
          <input class="form-control" id="username" name="username" value="{{ config.username or '' }}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="password">{{ _("Password") }}</label>
          <input class="form-control" type="password" id="password" name="password" value="{{ password_placeholder }}">
          <small class="text-muted">{{ _("Leave as *** to keep the stored password.") }}</small>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="poll_interval_seconds">{{ _("Poll interval (seconds)") }}</label>
          <input class="form-control" id="poll_interval_seconds" name="poll_interval_seconds" value="{{ config.poll_interval_seconds or 300 }}" min="30">
        </div>
        <div class="col-md-3">
          <label class="form-label" for="default_priority">{{ _("Default priority") }}</label>
          <input class="form-control" id="default_priority" name="default_priority" value="{{ config.default_priority or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label" for="default_department">{{ _("Default department") }}</label>
          <input class="form-control" id="default_department" name="default_department" value="{{ config.default_department or '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label" for="created_by_user_id">{{ _("Ticket creator") }}</label>
          <select class="form-select" name="created_by_user_id" id="created_by_user_id" required>
            <option value="">{{ _("Select user") }}</option>
            {% for user in users %}
            <option value="{{ user.id }}" {% if config.created_by_user_id == user.id %}selected{% endif %}>{{ user.username }} ({{ user.role|capitalize }})</option>
            {% endfor %}
          </select>
          <small class="text-muted">{{ _("Tickets will be created under this user's account.") }}</small>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="assign_to_user_id">{{ _("Assign to (optional)") }}</label>
          <select class="form-select" name="assign_to_user_id" id="assign_to_user_id">
            <option value="">{{ _("Do not auto-assign") }}</option>
            {% for user in users %}
            <option value="{{ user.id }}" {% if config.assign_to_user_id == user.id %}selected{% endif %}>{{ user.username }} ({{ user.role|capitalize }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <div class="card bg-body-tertiary border-0 shadow-sm">
            <div class="card-body">
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="subject_filter_enabled" name="subject_filter_enabled" value="1" {% if config.subject_filter_enabled %}checked{% endif %}>
                <label class="form-check-label" for="subject_filter_enabled">{{ _("Only create tickets when the email subject matches one of these patterns") }}</label>
              </div>
              <label class="form-label" for="subject_filter_patterns">{{ _("Subject patterns (one per line)") }}</label>
              <textarea class="form-control" id="subject_filter_patterns" name="subject_filter_patterns" rows="4" placeholder="[1234]\nInvoice *\nPROD-*" {% if not config.subject_filter_enabled %}disabled{% endif %}>{{ config.subject_filter_patterns or '' }}</textarea>
              <small class="text-muted d-block mt-2">
                {{ _("Use simple text, * wildcards, or prefix with regex: to run a regular expression. Patterns are compared case-insensitively.") }}
              </small>
              <div class="alert alert-info py-2 px-3 mt-3 mb-0">
                <strong class="d-block mb-1">{{ _("Sample patterns") }}</strong>
                <ul class="mb-0 ps-3">
                  <li><code>[1234]</code> — {{ _("only accept subjects that include the exact tag `[1234]`.") }}</li>
                  <li><code>[INV-*]</code> — {{ _("match subjects such as `[INV-001]` where the wildcard fills in the rest.") }}</li>
                  <li><code>Invoice *2024</code> — {{ _("allow any prefix but require the suffix `2024`.") }}</li>
                  <li><code>PROD-*</code> — {{ _("match any subject that starts with `PROD-`.") }}</li>
                  <li><code>regex:\[\d{4}\]</code> — {{ _("match subjects containing a four-digit code in square brackets (regular expression).") }}</li>
                </ul>
              </div>
              <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" id="subject_filter_delete_non_matching" name="subject_filter_delete_non_matching" value="1" {% if config.subject_filter_delete_non_matching %}checked{% endif %} {% if not config.subject_filter_enabled %}disabled{% endif %}>
                <label class="form-check-label" for="subject_filter_delete_non_matching">
                  {{ _("Delete emails that do not match any pattern (skipped emails will not remain unread).") }}
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4">
      <div class="row">
        <div class="col-md-6">
          <p class="mb-1"><strong>{{ _("Last run") }}:</strong>
            {% if config.last_run_at %}
              {{ config.last_run_at }}
            {% else %}
              {{ _("Never") }}
            {% endif %}
          </p>
          <p class="mb-0"><strong>{{ _("Last error") }}:</strong>
            {% if config.last_error %}
              <span class="text-danger">{{ config.last_error }}</span>
            {% else %}
              <span class="text-success">{{ _("None") }}</span>
            {% endif %}
          </p>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <button type="submit" name="action" value="save" class="btn btn-primary">
            <i class="fa fa-save me-1"></i>{{ _("Save settings") }}
          </button>
          <button type="submit" name="action" value="run" class="btn btn-outline-secondary">
            <i class="fa fa-play me-1"></i>{{ _("Run now") }}
          </button>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const toggle = document.getElementById("subject_filter_enabled");
  const textbox = document.getElementById("subject_filter_patterns");
  const deleteToggle = document.getElementById("subject_filter_delete_non_matching");
  if (!toggle || !textbox) return;
  const sync = () => {
    const enabled = toggle.checked;
    textbox.disabled = !enabled;
    if (deleteToggle) {
      deleteToggle.disabled = !enabled;
      if (!enabled) deleteToggle.checked = false;
    }
  };
  toggle.addEventListener("change", sync);
  sync();
});
</script>
{% endblock %}
