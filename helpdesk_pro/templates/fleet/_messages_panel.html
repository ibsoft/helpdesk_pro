<div class="card shadow-sm mb-4" id="messageFeed">
  <div class="card-body">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
      <div class="d-flex align-items-center gap-3">
        <div class="rounded-circle bg-primary-subtle text-primary d-flex align-items-center justify-content-center" style="width:48px;height:48px;">
          <i class="fa fa-clock-rotate-left fa-lg"></i>
        </div>
        <div>
          <h2 class="h5 mb-1">{{ _('Recent Telemetry') }}</h2>
          <small class="text-muted">
            {% if last_ingest_ts %}
              {{ _('Last ingest: %(time)s', time=format_ts(last_ingest_ts)) }}
            {% else %}
              {{ _('No telemetry received yet.') }}
            {% endif %}
          </small>
        </div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('fleet.host_detail', host_id=host.id, export='json', **filters) }}">
          <i class="fa fa-download"></i> {{ _('Export JSON') }}
        </a>
      </div>
    </div>

    {% set current_category = filters.category %}
    <div class="message-filter-panel card border-0 shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
          <div>
            <span class="text-muted small text-uppercase d-block mb-1">{{ _('Machine') }}</span>
            <div class="machine-pill text-truncate">
              <i class="fa fa-desktop me-1 text-primary"></i>{{ host.display_name or host.agent_id }}
            </div>
          </div>
          <small class="text-muted">{{ _('Use the controls below to narrow the message feed.') }}</small>
        </div>
        <div class="d-flex flex-wrap gap-2 mb-3 category-chip-row">
          <a class="chip-pill d-flex align-items-center gap-2 {{ 'active text-white' if not current_category else '' }} message-filter-link"
             href="{{ url_for('fleet.host_detail', host_id=host.id, subtype=filters.subtype, level=filters.level, q=filters.q, per_page=filters.per_page) }}">
            <i class="fa fa-layer-group"></i>
            <span>{{ _('All categories') }}</span>
            <span class="badge bg-dark-subtle text-dark">{{ pagination.total }}</span>
          </a>
          {% for pill in category_pills %}
            <a class="chip-pill d-flex align-items-center gap-2 {{ 'active text-white' if current_category == pill.raw else '' }} message-filter-link"
               href="{{ url_for('fleet.host_detail', host_id=host.id, category=pill.raw, subtype=filters.subtype, level=filters.level, q=filters.q, per_page=filters.per_page) }}">
              <i class="fa {{ pill.icon }}"></i>
              <span>{{ pill.label }}</span>
              <span class="badge bg-dark-subtle text-dark">{{ pill.count }}</span>
            </a>
          {% endfor %}
        </div>
        <form method="get" action="{{ url_for('fleet.host_detail', host_id=host.id) }}" class="filter-row message-filter-form">
          <div class="filter-field">
            <label class="form-label">{{ _('Category contains') }}</label>
            <input type="text" name="category" value="{{ filters.category }}" class="form-control" placeholder="event, host, inventory...">
          </div>
          <div class="filter-field">
            <label class="form-label">{{ _('Subtype contains') }}</label>
            <input type="text" name="subtype" value="{{ filters.subtype }}" class="form-control" placeholder="snapshot, record...">
          </div>
          <div class="filter-field" style="max-width: 140px;">
            <label class="form-label">{{ _('Level') }}</label>
            <input type="text" name="level" value="{{ filters.level }}" class="form-control" placeholder="error">
          </div>
          <div class="filter-field" style="max-width: 160px;">
            <label class="form-label">{{ _('Per page') }}</label>
            <input type="text" name="per_page" value="{{ filters.per_page or 25 }}" class="form-control" placeholder="25 or all">
          </div>
          <div class="filter-field flex-grow-1">
            <label class="form-label">{{ _('Search payload text') }}</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa fa-search"></i></span>
              <input type="text" name="q" value="{{ filters.q }}" class="form-control" placeholder="{{ _('log, cpu, service...') }}">
            </div>
          </div>
          <div class="filter-actions text-lg-end">
            <button class="btn btn-primary w-100 mb-2" type="submit"><i class="fa fa-filter me-1"></i> {{ _('Filter') }}</button>
            <a class="btn btn-outline-secondary w-100 message-filter-link" href="{{ url_for('fleet.host_detail', host_id=host.id) }}">{{ _('Clear') }}</a>
          </div>
        </form>
      </div>
    </div>

    {% if messages %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="messagesTable">
          <thead class="table-light text-uppercase small">
            <tr>
              <th class="text-muted">#</th>
              <th>{{ _('Time') }}</th>
              <th>{{ _('Machine') }}</th>
              <th>{{ _('Category') }}</th>
              <th>{{ _('Subtype') }}</th>
              <th>{{ _('Level') }}</th>
              <th>{{ _('Payload') }}</th>
              <th class="text-center">{{ _('Actions') }}</th>
            </tr>
          </thead>
          <tbody class="small">
            {% for message in messages %}
              <tr class="message-row" data-message-id="{{ message.id }}">
                <td class="text-muted">{{ message.id }}</td>
                <td>{{ format_ts(message.ts) }}</td>
                <td><span class="fw-semibold">{{ host.display_name or host.agent_id }}</span></td>
                <td>
                  <span class="badge bg-light text-primary border">{{ message.category or _('Uncategorized') }}</span>
                </td>
                <td>{{ message.subtype or _('—') }}</td>
                <td>
                  {% set lvl = (message.level or 'info') | lower %}
                  {% if 'crit' in lvl or 'error' in lvl %}
                    {% set badge_class = 'bg-danger-subtle text-danger-emphasis' %}
                  {% elif 'warn' in lvl %}
                    {% set badge_class = 'bg-warning-subtle text-warning-emphasis' %}
                  {% else %}
                    {% set badge_class = 'bg-secondary-subtle text-secondary-emphasis' %}
                  {% endif %}
                  <span class="badge text-uppercase {{ badge_class }}">{{ message.level or _('info') }}</span>
                </td>
                <td style="min-width:240px;">
                  <code class="text-danger small">{{ message.payload | tojson | truncate(120, True, '…') }}</code>
                </td>
                <td class="text-center">
                  <button class="btn btn-link btn-sm text-decoration-none message-payload-btn" data-message-id="{{ message.id }}">
                    <i class="fa fa-eye"></i> {{ _('Open') }}
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if not pagination.show_all %}
          <nav class="mt-3">
            <ul class="pagination pagination-sm mb-0">
              {% if pagination.has_prev %}
                <li class="page-item">
                  <a class="page-link message-filter-link" data-keep-page="true" href="{{ url_for('fleet.host_detail', host_id=host.id, page=pagination.prev_num, **filters) }}">&laquo;</a>
                </li>
              {% endif %}
              <li class="page-item disabled">
                <span class="page-link">{{ _('Page %(page)s of %(pages)s', page=pagination.page, pages=pagination.pages) }}</span>
              </li>
              {% if pagination.has_next %}
                <li class="page-item">
                  <a class="page-link message-filter-link" data-keep-page="true" href="{{ url_for('fleet.host_detail', host_id=host.id, page=pagination.next_num, **filters) }}">&raquo;</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        {% endif %}
        <p class="text-muted small mt-2 mb-0">
          {% if pagination.total %}
            {% if pagination.show_all %}
              {{ _('Showing all %(total)s messages', total=pagination.total) }}
            {% else %}
              {% set start_idx = ((pagination.page - 1) * pagination.per_page) + 1 %}
              {% set end_idx = pagination.page * pagination.per_page %}
              {% if end_idx > pagination.total %}
                {% set end_idx = pagination.total %}
              {% endif %}
              {{ _('Showing %(start)s-%(end)s of %(total)s messages', start=start_idx, end=end_idx, total=pagination.total) }}
            {% endif %}
          {% else %}
            {{ _('No messages to display.') }}
          {% endif %}
        </p>
        <div class="card border mt-3">
          <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-2">
              <div>
                <h3 class="h6 mb-1 d-flex align-items-center gap-2">
                  <i class="fa fa-broom text-primary"></i> {{ _('Purge Telemetry Messages') }}
                </h3>
                <small class="text-muted">{{ _('Remove messages older than the selected window for this host.') }}</small>
              </div>
            </div>
            <form method="post"
                  action="{{ url_for('fleet.purge_host_messages', host_id=host.id) }}"
                  id="messagePurgeForm"
                  class="row g-3 align-items-center">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="col-md-4">
                <label class="form-label mb-0">{{ _('Keep messages from') }}</label>
                <select class="form-select" name="scope" required>
                  <option value="day">{{ _('Last day') }}</option>
                  <option value="week">{{ _('Last week') }}</option>
                  <option value="month">{{ _('Last month') }}</option>
                  <option value="year">{{ _('Last year') }}</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-0 text-muted small">{{ _('Older records will be permanently deleted.') }}</label>
              </div>
              <div class="col-md-4 text-md-end">
                <button class="btn btn-outline-danger w-100">
                  <i class="fa fa-trash-can me-1"></i>{{ _('Purge Messages') }}
                </button>
              </div>
            </form>
            <div id="telemetryAlertRegion" class="mt-3"></div>
          </div>
        </div>
      </div>
    {% else %}
      <p class="text-muted mb-0">{{ _('No messages stored for this host yet.') }}</p>
    {% endif %}
  </div>
</div>
<script type="application/json" id="messagePayloadData">{{ message_payload_map | tojson }}</script>
