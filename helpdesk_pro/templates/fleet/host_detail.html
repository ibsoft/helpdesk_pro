{% extends "base.html" %}
{% block content %}
<style>
  .host-health-value {
    font-size: clamp(1.1rem, 1.5vw + 0.35rem, 1.75rem);
    line-height: 1.15;
  }
  .host-header {
    gap: 1.5rem;
  }
  .host-header small {
    display: block;
  }
  .host-header .header-actions {
    gap: 0.75rem;
  }
  .host-top-cards {
    align-items: stretch;
  }
  .latest-screenshot-card .card-body {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .screenshot-wrapper {
    position: relative;
    border-radius: 0.85rem;
    overflow: hidden;
    flex: 1 1 auto;
  }
  .screenshot-wrapper button {
    padding: 0;
    border: 0;
    width: 100%;
    background: transparent;
  }
  .screenshot-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .screenshot-wrapper .screenshot-fullscreen-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    pointer-events: none;
  }
</style>
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap host-header">
  <div>
    <h1 class="h4 mb-0 d-flex align-items-center gap-2 flex-wrap">
      <span><i class="fa fa-laptop-code me-2 text-primary"></i>{{ host.display_name or host.agent_id }}</span>
      {% if host_online %}
        <span class="badge bg-success-subtle text-success-emphasis">{{ _('Online') }}</span>
      {% else %}
        <span class="badge bg-secondary-subtle text-secondary-emphasis">{{ _('Offline') }}</span>
      {% endif %}
    </h1>
    <small class="text-muted">{{ host.os_family or _('Unknown OS') }} • {{ host.os_version or _('Version pending') }}</small>
  </div>
  <div class="d-flex flex-wrap header-actions">
    <a class="btn btn-outline-secondary" href="{{ url_for('fleet.dashboard') }}">
      <i class="fa fa-arrow-left"></i> {{ _('Back to Dashboard') }}
    </a>
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#hostMetaModal">
      <i class="fa fa-pen"></i> {{ _('Edit Metadata') }}
    </button>
    <a class="btn btn-primary" href="#remoteActionsCard">
      <i class="fa fa-rocket"></i> {{ _('Remote Actions') }}
    </a>
  </div>
</div>

<div class="row g-3 mb-4 host-top-cards">
  <div class="col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h2 class="h5">{{ _('System Health') }}</h2>
        {% if host.latest_state %}
          <div class="d-flex justify-content-between align-items-center mb-3">
            <small class="text-muted">{{ _('Latest telemetry captured at %(time)s', time=format_ts(host.latest_state.updated_at)) }}</small>
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#snapshotModal">
              <i class="fa fa-list"></i> {{ _('View raw payload') }}
            </button>
          </div>
          <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
            <div class="col">
              <div class="p-4 rounded-4 text-white shadow-sm h-100" style="background: linear-gradient(135deg,#ff512f,#dd2476);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-uppercase small fw-semibold opacity-75">{{ _('CPU Load') }}</span>
                  <i class="fa fa-microchip fa-2x opacity-75"></i>
                </div>
                <div class="host-health-value fw-semibold mb-0">
                  {% if health_cards.cpu is not none %}
                    {{ health_cards.cpu }}<span class="fs-5">%</span>
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col">
              <div class="p-4 rounded-4 text-white shadow-sm h-100" style="background: linear-gradient(135deg,#1f4037,#99f2c8);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-uppercase small fw-semibold opacity-75">{{ _('RAM Usage') }}</span>
                  <i class="fa fa-memory fa-2x opacity-75"></i>
                </div>
                <div class="host-health-value fw-semibold mb-0">
                  {% if health_cards.ram_pct is not none %}
                    {{ health_cards.ram_pct }}<span class="fs-5">%</span>
                  {% else %}
                    —
                  {% endif %}
                </div>
                {% if health_cards.ram.usedMB and health_cards.ram.totalMB %}
                  <small class="opacity-75">{{ health_cards.ram.usedMB }} / {{ health_cards.ram.totalMB }} MB</small>
                {% endif %}
              </div>
            </div>
            <div class="col">
              <div class="p-4 rounded-4 text-white shadow-sm h-100" style="background: linear-gradient(135deg,#f7971e,#ffd200);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-uppercase small fw-semibold opacity-75">{{ _('Disk Max') }}</span>
                  <i class="fa fa-hdd fa-2x opacity-75"></i>
                </div>
                <div class="host-health-value fw-semibold mb-0">
                  {% if health_cards.disk.maxUsedPct is not none %}
                    {{ health_cards.disk.maxUsedPct }}<span class="fs-5">%</span>
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col">
              <div class="p-4 rounded-4 text-white shadow-sm h-100" style="background: linear-gradient(135deg,#36d1dc,#5b86e5);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-uppercase small fw-semibold opacity-75">{{ _('Pending updates') }}</span>
                  <i class="fa fa-rotate fa-2x opacity-75"></i>
                </div>
                <div class="host-health-value fw-semibold mb-0">{{ health_cards.updates.pending or 0 }}</div>
                {% if health_cards.updates.lastCheck %}
                  <small class="opacity-75">{{ _('Last check: %(time)s', time=health_cards.updates.lastCheck) }}</small>
                {% endif %}
              </div>
            </div>
            <div class="col">
              <div class="p-4 rounded-4 text-white shadow-sm h-100" style="background: linear-gradient(135deg,#00b09b,#96c93d);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-uppercase small fw-semibold opacity-75">{{ _('Antivirus') }}</span>
                  <i class="fa fa-shield fa-2x opacity-75"></i>
                </div>
                <div class="h4 mb-0">
                  {% if health_cards.antivirus.enabled %}
                    <span class="badge bg-success-subtle text-success-emphasis">{{ _('Enabled') }}</span>
                  {% else %}
                    <span class="badge bg-danger-subtle text-danger-emphasis">{{ _('Disabled') }}</span>
                  {% endif %}
                </div>
                <small class="opacity-75">{{ _('Up to date') if health_cards.antivirus.upToDate else _('Outdated signatures') }}</small>
              </div>
            </div>
            <div class="col">
              <div class="p-4 rounded-4 text-white shadow-sm h-100" style="background: linear-gradient(135deg,#ee0979,#ff6a00);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="text-uppercase small fw-semibold opacity-75">{{ _('Errors (24h)') }}</span>
                  <i class="fa fa-triangle-exclamation fa-2x opacity-75"></i>
                </div>
                <div class="host-health-value fw-semibold mb-0">{{ health_cards.events.errors24h or 0 }}</div>
              </div>
            </div>
          </div>
        {% else %}
          <p class="text-muted mb-0">{{ _('No telemetry has been ingested yet for this host.') }}</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-4 latest-screenshot-card">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">{{ _('Latest Screenshot') }}</h2>
          {% if screenshot_data %}
            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#screenshotFullscreenModal">
              <i class="fa fa-expand"></i>
            </button>
          {% endif %}
        </div>
        {% if screenshot_data %}
          <div class="screenshot-wrapper mt-2">
            <button type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#screenshotFullscreenModal">
              <img src="{{ screenshot_data }}" alt="{{ _('Host screenshot') }}">
            </button>
          </div>
          <small class="text-muted">{{ _('Updated at %(time)s', time=host.latest_state.updated_at) }}</small>
        {% else %}
          <p class="text-muted mb-0">{{ _('Agent has not uploaded a screenshot yet.') }}</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if active_alerts %}
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h2 class="h5 mb-3">{{ _('Active Alerts') }}</h2>
      <div class="row g-3">
        {% for alert in active_alerts %}
          <div class="col-md-6 col-lg-4">
            <div class="p-3 border rounded h-100">
              <span class="badge bg-danger-subtle text-danger-emphasis text-uppercase small">{{ alert.rule_key }}</span>
              <p class="mt-2 mb-1">{{ alert.message }}</p>
              <small class="text-muted">{{ _('Triggered at %(time)s', time=alert.triggered_at) }}</small>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}

<div class="card shadow-sm mb-4" id="remoteActionsCard">
  <div class="card-body">
    <h2 class="h5 d-flex align-items-center gap-2 mb-3">
      <i class="fa fa-terminal text-primary"></i>{{ _('Remote Actions') }}
    </h2>
    <div class="row g-3">
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <h3 class="h6">{{ _('Quick Links') }}</h3>
          {% if primary_ip %}
            <div class="d-flex flex-column gap-2 mt-2">
              <a class="btn btn-outline-primary btn-sm" href="ssh://{{ primary_ip }}">{{ _('Open SSH') }}</a>
              <a class="btn btn-outline-info btn-sm" href="rdp://full%20address=s:{{ primary_ip }}">{{ _('Open RDP') }}</a>
              <a class="btn btn-outline-secondary btn-sm" href="vnc://{{ primary_ip }}">{{ _('Open VNC') }}</a>
            </div>
          {% else %}
            <p class="text-muted small mb-0">{{ _('No primary IP reported yet.') }}</p>
          {% endif %}
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <h3 class="h6">{{ _('Send Command') }}</h3>
          <form method="post" action="{{ url_for('fleet.create_remote_command', host_id=host.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <textarea class="form-control mb-2" name="command" rows="3" placeholder="sudo systemctl restart service"></textarea>
            <button class="btn btn-primary btn-sm w-100">{{ _('Queue Command') }}</button>
          </form>
          {% if remote_commands %}
            <hr>
            <ul class="list-unstyled small mb-0">
              {% for cmd in remote_commands %}
                <li class="mb-1">
                  <span class="badge bg-dark-subtle text-uppercase">{{ cmd.status }}</span>
                  <code>{{ cmd.command }}</code>
                  {% if cmd.response %}
                    <div class="text-muted">{{ cmd.response }}</div>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <h3 class="h6">{{ _('Upload File') }}</h3>
          <form method="post" action="{{ url_for('fleet.upload_remote_file', host_id=host.id) }}" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="file" name="file" class="form-control mb-2">
            <button class="btn btn-outline-primary btn-sm w-100">{{ _('Upload') }}</button>
          </form>
          {% if file_transfers %}
            <hr>
            <ul class="list-unstyled small mb-0">
              {% for transfer in file_transfers %}
                <li class="mb-1">
                  <i class="fa fa-file-arrow-up text-primary"></i> {{ transfer.filename }}
                  <span class="text-muted">({{ (transfer.size_bytes or 0) // 1024 }} KB)</span>
                  {% if transfer.consumed_at %}
                    <span class="badge bg-success-subtle text-success-emphasis">{{ _('Downloaded') }}</span>
                  {% else %}
                    <span class="badge bg-warning-subtle text-warning-emphasis">{{ _('Pending pickup') }}</span>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <h2 class="h5 mb-0">{{ _('Host Metadata') }}</h2>
      <span class="text-muted small">{{ _('Use the Edit Metadata button above to update details.') }}</span>
    </div>
    <div class="row g-3 small">
      <div class="col-md-4">
        <p class="text-muted text-uppercase fw-semibold mb-1">{{ _('Display Name') }}</p>
        <p class="mb-0">{{ host.display_name or host.agent_id }}</p>
      </div>
      <div class="col-md-4">
        <p class="text-muted text-uppercase fw-semibold mb-1">{{ _('Location') }}</p>
        <p class="mb-0">{{ host.location or _('Not specified') }}</p>
      </div>
      <div class="col-md-4">
        <p class="text-muted text-uppercase fw-semibold mb-1">{{ _('Operating System') }}</p>
        <p class="mb-0">
          {% if host.os_family %}
            {{ host.os_family }}{% if host.os_version %} <span class="text-muted">({{ host.os_version }})</span>{% endif %}
          {% else %}
            {{ _('Not specified') }}
          {% endif %}
        </p>
      </div>
      <div class="col-md-4">
        <p class="text-muted text-uppercase fw-semibold mb-1">{{ _('Coordinates') }}</p>
        <p class="mb-0">
          {% if host.latitude or host.longitude %}
            {{ host.latitude or '—' }}, {{ host.longitude or '—' }}
          {% else %}
            {{ _('Not set') }}
          {% endif %}
        </p>
      </div>
      <div class="col-md-4">
        <p class="text-muted text-uppercase fw-semibold mb-1">{{ _('Contact') }}</p>
        <p class="mb-0">{{ host.contact or _('Not assigned') }}</p>
      </div>
      <div class="col-md-4">
        <p class="text-muted text-uppercase fw-semibold mb-1">{{ _('Tags') }}</p>
        <p class="mb-0">{{ host.tags or _('None') }}</p>
      </div>
      <div class="col-md-4">
        <p class="text-muted text-uppercase fw-semibold mb-1">{{ _('Map Pin Icon') }}</p>
        <p class="mb-0">{{ host.map_pin_icon or _('Default') }}</p>
      </div>
      <div class="col-12">
        <p class="text-muted text-uppercase fw-semibold mb-1">{{ _('Notes') }}</p>
        {% if host.notes %}
          <div class="bg-light rounded p-2">{{ host.notes }}</div>
        {% else %}
          <p class="mb-0">{{ _('No notes captured yet.') }}</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
      <div class="d-flex align-items-center gap-3">
        <div class="rounded-circle bg-primary-subtle text-primary d-flex align-items-center justify-content-center" style="width:48px;height:48px;">
          <i class="fa fa-clock-rotate-left fa-lg"></i>
        </div>
        <div>
          <h2 class="h5 mb-1">{{ _('Recent Telemetry') }}</h2>
          <small class="text-muted">
            {% if last_ingest_ts %}
              {{ _('Last ingest: %(time)s', time=format_ts(last_ingest_ts)) }}
            {% else %}
              {{ _('No telemetry received yet.') }}
            {% endif %}
          </small>
        </div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('fleet.host_detail', host_id=host.id, export='json', **filters) }}">
          <i class="fa fa-download"></i> {{ _('Export JSON') }}
        </a>
      </div>
    </div>

    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
      <span class="text-muted small text-uppercase fw-semibold">{{ _('Categories') }}</span>
      <a class="badge rounded-pill {{ 'bg-primary text-white' if not filters.category else 'bg-light text-muted border' }}"
         href="{{ url_for('fleet.host_detail', host_id=host.id, start=filters.start, end=filters.end, subtype=filters.subtype, level=filters.level, q=filters.q, per_page=filters.per_page) }}">
        {{ _('All') }}
      </a>
      {% for item in category_counts %}
        <a class="badge rounded-pill d-flex align-items-center gap-2 {{ 'bg-primary text-white' if filters.category and filters.category == item.raw else 'bg-light text-muted border' }}"
           href="{{ url_for('fleet.host_detail', host_id=host.id, start=filters.start, end=filters.end, category=item.raw, subtype=filters.subtype, level=filters.level, q=filters.q, per_page=filters.per_page) }}">
          <span>{{ item.name }}</span>
          <span class="badge bg-dark-subtle text-dark">{{ item.count }}</span>
        </a>
      {% endfor %}
    </div>

    <form method="get" class="row g-2 align-items-end mb-3">
      <div class="col-md-3">
        <label class="form-label text-muted small text-uppercase">{{ _('Machine') }}</label>
        <div class="input-group">
          <span class="input-group-text"><i class="fa fa-desktop"></i></span>
          <input type="text" class="form-control" value="{{ host.display_name or host.agent_id }}" readonly>
        </div>
      </div>
      <div class="col-sm-6 col-md-3">
        <label class="form-label">{{ _('Start') }}</label>
        <input type="datetime-local" name="start" value="{{ filters.start }}" class="form-control">
      </div>
      <div class="col-sm-6 col-md-3">
        <label class="form-label">{{ _('End') }}</label>
        <input type="datetime-local" name="end" value="{{ filters.end }}" class="form-control">
      </div>
      <div class="col-sm-6 col-md-3">
        <label class="form-label">{{ _('Subtype') }}</label>
        <input type="text" name="subtype" value="{{ filters.subtype }}" class="form-control" placeholder="snapshot">
      </div>
      <div class="col-sm-6 col-md-3">
        <label class="form-label">{{ _('Level') }}</label>
        <input type="text" name="level" value="{{ filters.level }}" class="form-control" placeholder="error/info/warn">
      </div>
      <div class="col-sm-6 col-md-2">
        <label class="form-label">{{ _('Per page') }}</label>
        <input type="number" min="5" max="200" name="per_page" value="{{ filters.per_page or 25 }}" class="form-control">
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ _('Search payload') }}</label>
        <div class="input-group">
          <span class="input-group-text"><i class="fa fa-search"></i></span>
          <input type="text" name="q" value="{{ filters.q }}" class="form-control" placeholder="{{ _('log, cpu, service...') }}">
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label text-muted small text-uppercase d-block">{{ _('Category filter') }}</label>
        <input type="text" name="category" value="{{ filters.category }}" class="form-control" placeholder="{{ _('event, host...') }}">
      </div>
      <div class="col-md-2 ms-auto text-md-end">
        <button class="btn btn-primary w-100 mb-2"><i class="fa fa-filter me-1"></i>{{ _('Filter') }}</button>
        <a class="btn btn-outline-secondary w-100" href="{{ url_for('fleet.host_detail', host_id=host.id) }}">{{ _('Clear') }}</a>
      </div>
    </form>

    {% if messages %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light text-uppercase small">
            <tr>
              <th class="text-muted">#</th>
              <th>{{ _('Time') }}</th>
              <th>{{ _('Machine') }}</th>
              <th>{{ _('Category') }}</th>
              <th>{{ _('Subtype') }}</th>
              <th>{{ _('Level') }}</th>
              <th>{{ _('Payload') }}</th>
            </tr>
          </thead>
          <tbody class="small">
            {% for message in messages %}
              <tr>
                <td class="text-muted">{{ message.id }}</td>
                <td>{{ format_ts(message.ts) }}</td>
                <td><span class="fw-semibold">{{ host.display_name or host.agent_id }}</span></td>
                <td>
                  <span class="badge bg-light text-primary border">{{ message.category or _('Uncategorized') }}</span>
                </td>
                <td>{{ message.subtype or _('—') }}</td>
                <td>
                  {% set lvl = (message.level or 'info') | lower %}
                  {% if 'crit' in lvl or 'error' in lvl %}
                    {% set badge_class = 'bg-danger-subtle text-danger-emphasis' %}
                  {% elif 'warn' in lvl %}
                    {% set badge_class = 'bg-warning-subtle text-warning-emphasis' %}
                  {% else %}
                    {% set badge_class = 'bg-secondary-subtle text-secondary-emphasis' %}
                  {% endif %}
                  <span class="badge text-uppercase {{ badge_class }}">{{ message.level or _('info') }}</span>
                </td>
                <td style="min-width:240px;">
                  <code class="text-danger small">{{ message.payload | tojson | truncate(120, True, '…') }}</code>
                  <button class="btn btn-link btn-sm text-decoration-none message-payload-btn" data-message-id="{{ message.id }}">
                    <i class="fa fa-eye"></i> {{ _('Open') }}
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <nav class="mt-3">
          <ul class="pagination pagination-sm mb-0">
            {% if pagination.has_prev %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('fleet.host_detail', host_id=host.id, page=pagination.prev_num, **filters) }}">&laquo;</a>
              </li>
            {% endif %}
            <li class="page-item disabled">
              <span class="page-link">{{ _('Page %(page)s of %(pages)s', page=pagination.page, pages=pagination.pages) }}</span>
            </li>
            {% if pagination.has_next %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('fleet.host_detail', host_id=host.id, page=pagination.next_num, **filters) }}">&raquo;</a>
              </li>
            {% endif %}
          </ul>
        </nav>
        <p class="text-muted small mt-2 mb-0">
          {% if pagination.total %}
            {% set start_idx = ((pagination.page - 1) * pagination.per_page) + 1 %}
            {% set end_idx = pagination.page * pagination.per_page %}
            {% if end_idx > pagination.total %}
              {% set end_idx = pagination.total %}
            {% endif %}
            {{ _('Showing %(start)s-%(end)s of %(total)s messages', start=start_idx, end=end_idx, total=pagination.total) }}
          {% else %}
            {{ _('No messages to display.') }}
          {% endif %}
        </p>
      </div>
    {% else %}
      <p class="text-muted mb-0">{{ _('No messages stored for this host yet.') }}</p>
    {% endif %}
  </div>
</div>

<div class="modal fade" id="hostMetaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <form class="modal-content" method="post" action="{{ url_for('fleet.update_host', host_id=host.id) }}">
      <div class="modal-header modal-header-gradient text-white">
        <h5 class="modal-title"><i class="fa fa-pen me-2"></i>{{ _('Edit Host Metadata') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">{{ _('Display Name') }}</label>
            <input type="text" name="display_name" class="form-control" value="{{ host.display_name }}">
          </div>
          <div class="col-12">
            <label class="form-label">{{ _('Location / Address') }}</label>
            <input type="text" name="location" class="form-control" value="{{ host.location }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ _('Latitude') }}</label>
            <input type="text" name="latitude" class="form-control" value="{{ host.latitude }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ _('Longitude') }}</label>
            <input type="text" name="longitude" class="form-control" value="{{ host.longitude }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ _('Operating System') }}</label>
            {% set os_values = ['Windows','Linux','macOS','Other'] %}
            <select name="os_family" class="form-select">
              <option value="">{{ _('Auto-detected / Not set') }}</option>
              {% for opt in os_values %}
                <option value="{{ opt }}" {% if host.os_family == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ _('OS Version') }}</label>
            <input type="text" name="os_version" class="form-control" value="{{ host.os_version }}">
          </div>
          <div class="col-12">
            <label class="form-label">{{ _('Contact') }}</label>
            <input type="text" name="contact" class="form-control" value="{{ host.contact }}">
          </div>
          <div class="col-12">
            <label class="form-label">{{ _('Tags (comma separated)') }}</label>
            <input type="text" name="tags" class="form-control" value="{{ host.tags }}">
          </div>
          <div class="col-12">
            <label class="form-label">{{ _('Map Pin Icon (FontAwesome)') }}</label>
            <input type="text" name="host_pin_icon" class="form-control" value="{{ host.map_pin_icon }}">
          </div>
          <div class="col-12">
            <label class="form-label">{{ _('Notes') }}</label>
            <textarea name="notes" class="form-control" rows="3">{{ host.notes }}</textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button class="btn btn-primary"><i class="fa fa-save"></i> {{ _('Save changes') }}</button>
      </div>
    </form>
  </div>
</div>

{% if screenshot_data %}
  <div class="modal fade" id="screenshotFullscreenModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen" style="margin-top: var(--navbar-height);">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="fa fa-desktop me-2"></i>{{ _('Latest Screenshot') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0 bg-black text-center">
          <img src="{{ screenshot_data }}" alt="{{ _('Host screenshot') }}" class="img-fluid w-100">
        </div>
      </div>
    </div>
  </div>
{% endif %}

{% if host.latest_state %}
  <div class="modal fade" id="snapshotModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-database me-2"></i>{{ _('Latest Payload') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <pre class="small bg-light rounded p-3">{{ host.latest_state.snapshot | tojson(indent=2) }}</pre>
        </div>
      </div>
    </div>
  </div>
{% endif %}

<div class="modal fade" id="messagePayloadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header modal-header-gradient text-white">
        <h5 class="modal-title"><i class="fa fa-code me-2"></i>{{ _('Message Payload') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <pre class="small bg-light rounded p-3" id="messagePayloadBody"></pre>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
{{ super() if super() is defined }}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const map = {{ message_payload_map | tojson }};
    const modalEl = document.getElementById('messagePayloadModal');
    const payloadBody = document.getElementById('messagePayloadBody');
    document.querySelectorAll('.message-payload-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-message-id');
        const data = map[id];
        if (data) {
          payloadBody.textContent = JSON.stringify(data, null, 2);
        } else {
          payloadBody.textContent = '{{ _("Payload unavailable.") }}';
        }
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      });
    });
  });
</script>
{% endblock %}
{% endblock %}
