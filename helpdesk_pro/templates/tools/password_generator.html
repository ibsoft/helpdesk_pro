{% extends "base.html" %}
{% block content %}

<div class="row justify-content-center g-4">
  <div class="col-xl-8 col-lg-9 col-md-11 col-12">
    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
      <div class="card-body p-4 p-lg-5">
        <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-4 mb-4">
          <div class="flex-shrink-0">
            <div class="bg-danger-subtle text-danger rounded-4 p-4 d-flex align-items-center justify-content-center">
              <i class="fa fa-shield-halved fa-3x"></i>
            </div>
          </div>
          <div>
            <h2 class="fw-bold mb-2">{{ _('Password & PIN Studio') }}</h2>
            <p class="text-muted mb-3">
              {{ _('Craft ultra-strong passwords, memorable passphrases, and secure PIN codes in seconds. Toggle your style, fine-tune complexity, and copy the result with a single click.') }}
            </p>
            <div class="d-flex flex-wrap gap-2">
              <span class="badge rounded-pill text-bg-danger"><i class="fa fa-random me-1"></i>{{ _('Entropy rich') }}</span>
              <span class="badge rounded-pill text-bg-primary"><i class="fa fa-brain me-1"></i>{{ _('Memorable phrases') }}</span>
              <span class="badge rounded-pill text-bg-success"><i class="fa fa-mobile me-1"></i>{{ _('PIN friendly') }}</span>
            </div>
          </div>
        </div>

        <div class="password-panel rounded-4 p-3 p-lg-4">
          <div class="btn-group w-100 mb-4" role="group" aria-label="{{ _('Password type') }}">
            <input type="radio" class="btn-check" name="pwType" id="typeRandom" value="random" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="typeRandom"><i class="fa fa-shuffle me-2"></i>{{ _('Random') }}</label>

            <input type="radio" class="btn-check" name="pwType" id="typePhrase" value="phrase" autocomplete="off">
            <label class="btn btn-outline-primary" for="typePhrase"><i class="fa fa-feather me-2"></i>{{ _('Passphrase') }}</label>

            <input type="radio" class="btn-check" name="pwType" id="typePin" value="pin" autocomplete="off">
            <label class="btn btn-outline-primary" for="typePin"><i class="fa fa-hashtag me-2"></i>{{ _('PIN') }}</label>
          </div>

          <div id="randomOptions" class="generator-options">
            <h5 class="fw-semibold mb-3">{{ _('Customise your random password') }}</h5>
            <div class="row g-3 align-items-center mb-3">
              <label class="col-sm-4 col-form-label">{{ _('Characters') }}</label>
              <div class="col-sm-8">
                <div class="d-flex align-items-center gap-3">
                  <input type="range" class="form-range flex-grow-1" id="randomLength" min="8" max="64" value="20">
                  <span class="badge bg-primary-subtle text-primary" id="randomLengthLabel">20</span>
                </div>
              </div>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="randomUpper" checked>
                  <label class="form-check-label" for="randomUpper">{{ _('Uppercase (A-Z)') }}</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="randomLower" checked>
                  <label class="form-check-label" for="randomLower">{{ _('Lowercase (a-z)') }}</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="randomNumbers" checked>
                  <label class="form-check-label" for="randomNumbers">{{ _('Numbers (0-9)') }}</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="randomSymbols" checked>
                  <label class="form-check-label" for="randomSymbols">{{ _('Symbols (!@#$)') }}</label>
                </div>
              </div>
              <div class="col-md-8">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="randomAmbiguous">
                  <label class="form-check-label" for="randomAmbiguous">{{ _('Exclude ambiguous characters (O0, l1, etc.)') }}</label>
                </div>
              </div>
            </div>
          </div>

          <div id="phraseOptions" class="generator-options d-none">
            <h5 class="fw-semibold mb-3">{{ _('Craft an easy-to-remember passphrase') }}</h5>
            <div class="row g-3 align-items-center mb-3">
              <label class="col-sm-4 col-form-label">{{ _('Words') }}</label>
              <div class="col-sm-8">
                <div class="d-flex align-items-center gap-3">
                  <input type="range" class="form-range flex-grow-1" id="phraseWords" min="3" max="8" value="4">
                  <span class="badge bg-primary-subtle text-primary" id="phraseWordsLabel">4</span>
                </div>
              </div>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="phraseCapitalise" checked>
                  <label class="form-check-label" for="phraseCapitalise">{{ _('Capitalise words') }}</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="phraseSeparator">
                  <label class="form-check-label" for="phraseSeparator">{{ _('Use special separators') }}</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="phraseNumbers">
                  <label class="form-check-label" for="phraseNumbers">{{ _('Add number tail') }}</label>
                </div>
              </div>
            </div>
          </div>

          <div id="pinOptions" class="generator-options d-none">
            <h5 class="fw-semibold mb-3">{{ _('Generate a secure PIN') }}</h5>
            <div class="row g-3 align-items-center mb-3">
              <label class="col-sm-4 col-form-label">{{ _('Digits') }}</label>
              <div class="col-sm-8">
                <div class="d-flex align-items-center gap-3">
                  <input type="range" class="form-range flex-grow-1" id="pinLength" min="4" max="12" value="6">
                  <span class="badge bg-primary-subtle text-primary" id="pinLengthLabel">6</span>
                </div>
              </div>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="pinAllowRepeat">
              <label class="form-check-label" for="pinAllowRepeat">{{ _('Allow repeated digits') }}</label>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <h6 class="text-muted mb-2">{{ _('Generated credential') }}</h6>
          <div class="generated-output rounded-4 p-3 d-flex justify-content-between align-items-center shadow-sm border">
            <code id="generatedValue" class="fs-4 text-wrap"></code>
            <span class="badge rounded-pill text-bg-secondary" id="strengthLabel">{{ _('Strength') }}: –</span>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mt-4">
          <button class="btn btn-primary flex-grow-1 flex-lg-grow-0" id="copyGenerated"><i class="fa fa-copy me-2"></i>{{ _('Copy') }}</button>
          <button class="btn btn-outline-primary flex-grow-1 flex-lg-grow-0" id="refreshGenerated"><i class="fa fa-rotate me-2"></i>{{ _('Refresh') }}</button>
          <button class="btn btn-secondary flex-grow-1 flex-lg-grow-0" id="addToClipboard"><i class="fa fa-clipboard-list me-2"></i>{{ _('Add to session log') }}</button>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-4 col-lg-3 col-md-11 col-12">
    <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
      <div class="card-body p-4">
        <h5 class="fw-semibold mb-3 d-flex align-items-center gap-2"><i class="fa fa-list-check text-primary"></i>{{ _('Session clipboard') }}</h5>
        <p class="text-muted small mb-3">{{ _('Keep track of generated credentials. Nothing is stored server-side — clearing or leaving the page removes the list.') }}</p>
        <div class="d-flex justify-content-between gap-2 mb-3">
          <button class="btn btn-outline-secondary btn-sm" id="copyClipboard"><i class="fa fa-copy me-2"></i>{{ _('Copy list') }}</button>
          <button class="btn btn-outline-danger btn-sm" id="clearClipboard"><i class="fa fa-trash-can me-2"></i>{{ _('Clear list') }}</button>
        </div>
        <div id="clipboardList" class="clipboard-list rounded-4 p-3 bg-body-tertiary text-muted small"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .password-panel {
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.95) 0%, rgba(229, 231, 235, 0.85) 100%);
    border: 1px solid rgba(15, 23, 42, 0.08);
  }
  html[data-bs-theme="dark"] .password-panel {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.88) 0%, rgba(15, 23, 42, 0.75) 100%);
    border-color: rgba(148, 163, 184, 0.2);
  }
  .generated-output code {
    font-family: "Fira Code", "Courier New", monospace;
    font-weight: 600;
  }
  .clipboard-list {
    min-height: 180px;
    max-height: 420px;
    overflow-y: auto;
    border: 1px dashed rgba(59, 130, 246, 0.25);
  }
  .clipboard-item {
    background: rgba(59, 130, 246, 0.08);
    border-radius: 0.85rem;
    padding: 0.65rem 0.9rem;
    margin-bottom: 0.75rem;
    color: #1e293b;
  }
  html[data-bs-theme="dark"] .clipboard-item {
    background: rgba(59, 130, 246, 0.16);
    color: #e2e8f0;
  }
  .clipboard-item:last-child {
    margin-bottom: 0;
  }
  .clipboard-item strong {
    display: block;
  }
</style>

<script>
  (function() {
    const typeRadios = document.querySelectorAll("input[name='pwType']");
    const randomOptions = document.getElementById("randomOptions");
    const phraseOptions = document.getElementById("phraseOptions");
    const pinOptions = document.getElementById("pinOptions");
    const generatedValue = document.getElementById("generatedValue");
    const strengthLabel = document.getElementById("strengthLabel");
    const copyGenerated = document.getElementById("copyGenerated");
    const refreshGenerated = document.getElementById("refreshGenerated");
    const addToClipboard = document.getElementById("addToClipboard");
    const clipboardList = document.getElementById("clipboardList");
    const copyClipboard = document.getElementById("copyClipboard");
    const clearClipboard = document.getElementById("clearClipboard");

    const randomLengthSlider = document.getElementById("randomLength");
    const randomLengthLabel = document.getElementById("randomLengthLabel");
    const phraseWordsSlider = document.getElementById("phraseWords");
    const phraseWordsLabel = document.getElementById("phraseWordsLabel");
    const pinLengthSlider = document.getElementById("pinLength");
    const pinLengthLabel = document.getElementById("pinLengthLabel");

    const history = [];

    const WORD_BANK = [
      "arctic", "bridge", "cobalt", "dynamo", "ember", "fable", "galaxy", "harbor", "ion", "jungle", "kelvin", "lantern",
      "magnet", "nebula", "origami", "phoenix", "quantum", "rift", "solar", "tempest", "utopia", "vortex", "willow", "xenon",
      "yonder", "zenith", "anchor", "breeze", "cipher", "dew", "ember", "fluent", "glacier", "horizon", "ignite", "jade",
      "kinetic", "lilac", "mystic", "nova", "oak", "pulse", "quartz", "river", "summit", "tidal", "velvet", "whisper", "zephyr"
    ];
    const SEPARATORS = ["-", "_", ".", "~", "*", "+"];

    function toggleOptionPanels() {
      const selected = document.querySelector("input[name='pwType']:checked").value;
      randomOptions.classList.toggle("d-none", selected !== "random");
      phraseOptions.classList.toggle("d-none", selected !== "phrase");
      pinOptions.classList.toggle("d-none", selected !== "pin");
    }

    typeRadios.forEach(radio => radio.addEventListener("change", () => {
      toggleOptionPanels();
      generate();
    }));

    function calculateStrength(value) {
      const lengthScore = Math.min(value.length / 4, 10);
      let charset = 0;
      if (/[a-z]/.test(value)) charset += 26;
      if (/[A-Z]/.test(value)) charset += 26;
      if (/[0-9]/.test(value)) charset += 10;
      if (/[^A-Za-z0-9]/.test(value)) charset += 32;
      const entropy = Math.round(Math.log2(Math.pow(charset || 1, value.length)));
      let label = "{{ _('Weak') }}";
      let badge = "text-bg-danger";
      if (entropy > 80) {
        label = "{{ _('Excellent') }}";
        badge = "text-bg-success";
      } else if (entropy > 60) {
        label = "{{ _('Strong') }}";
        badge = "text-bg-primary";
      } else if (entropy > 40) {
        label = "{{ _('OK') }}";
        badge = "text-bg-warning";
      }
      strengthLabel.textContent = `{{ _('Strength') }}: ${label}`;
      strengthLabel.className = `badge rounded-pill ${badge}`;
    }

    function generateRandomPassword() {
      const includeUpper = document.getElementById("randomUpper").checked;
      const includeLower = document.getElementById("randomLower").checked;
      const includeNumbers = document.getElementById("randomNumbers").checked;
      const includeSymbols = document.getElementById("randomSymbols").checked;
      const excludeAmbiguous = document.getElementById("randomAmbiguous").checked;
      const length = parseInt(randomLengthSlider.value, 10);

      let chars = "";
      const upper = excludeAmbiguous ? "ABCDEFGHJKLMNPQRSTUVWXYZ" : "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const lower = excludeAmbiguous ? "abcdefghijkmnopqrstuvwxyz" : "abcdefghijklmnopqrstuvwxyz";
      const numbers = excludeAmbiguous ? "23456789" : "0123456789";
      const symbols = "!@#$%^&*()-_=+[]{}<>?/|~";

      if (includeUpper) chars += upper;
      if (includeLower) chars += lower;
      if (includeNumbers) chars += numbers;
      if (includeSymbols) chars += symbols;
      if (!chars) chars = lower;

      let password = "";
      for (let i = 0; i < length; i++) {
        const index = Math.floor(Math.random() * chars.length);
        password += chars.charAt(index);
      }
      return password;
    }

    function generatePassphrase() {
      const wordCount = parseInt(phraseWordsSlider.value, 10);
      const capitalise = document.getElementById("phraseCapitalise").checked;
      const useSeparator = document.getElementById("phraseSeparator").checked;
      const addNumber = document.getElementById("phraseNumbers").checked;

      const words = [];
      for (let i = 0; i < wordCount; i++) {
        const word = WORD_BANK[Math.floor(Math.random() * WORD_BANK.length)];
        words.push(capitalise ? word.charAt(0).toUpperCase() + word.slice(1) : word);
      }

      let separator = "";
      if (useSeparator) {
        separator = SEPARATORS[Math.floor(Math.random() * SEPARATORS.length)];
      } else {
        separator = " ";
      }

      let phrase = words.join(separator);
      if (addNumber) {
        phrase += separator.trim() ? separator : "";
        phrase += Math.floor(Math.random() * 90 + 10);
      }
      return phrase;
    }

    function generatePin() {
      const length = parseInt(pinLengthSlider.value, 10);
      const allowRepeat = document.getElementById("pinAllowRepeat").checked;
      let digits = "";
      const numbers = "0123456789";
      while (digits.length < length) {
        const digit = numbers[Math.floor(Math.random() * numbers.length)];
        if (allowRepeat || !digits.includes(digit)) {
          digits += digit;
        }
      }
      return digits;
    }

    function generate() {
      const selected = document.querySelector("input[name='pwType']:checked").value;
      let value = "";
      if (selected === "random") {
        value = generateRandomPassword();
      } else if (selected === "phrase") {
        value = generatePassphrase();
      } else {
        value = generatePin();
      }
      generatedValue.textContent = value;
      calculateStrength(value);
      return value;
    }

    randomLengthSlider.addEventListener("input", () => {
      randomLengthLabel.textContent = randomLengthSlider.value;
    });
    phraseWordsSlider.addEventListener("input", () => {
      phraseWordsLabel.textContent = phraseWordsSlider.value;
    });
    pinLengthSlider.addEventListener("input", () => {
      pinLengthLabel.textContent = pinLengthSlider.value;
    });

    document.querySelectorAll("#randomOptions input, #phraseOptions input, #pinOptions input").forEach(input => {
      input.addEventListener("change", generate);
    });

    copyGenerated.addEventListener("click", () => {
      const value = generatedValue.textContent;
      if (!value) return;
      navigator.clipboard.writeText(value)
        .then(() => showToast("{{ _('Value copied to clipboard.') }}", "success"))
        .catch(() => showToast("{{ _('Unable to copy value.') }}", "danger"));
    });

    refreshGenerated.addEventListener("click", generate);

    addToClipboard.addEventListener("click", () => {
      const value = generatedValue.textContent;
      if (!value) {
        showToast("{{ _('Generate a value first.') }}", "warning");
        return;
      }
      const type = document.querySelector("input[name='pwType']:checked").value;
      const entry = {
        type,
        value,
        timestamp: new Date().toLocaleTimeString(),
      };
      history.unshift(entry);
      renderHistory();
      showToast("{{ _('Saved to session clipboard.') }}", "success");
    });

    function renderHistory() {
      clipboardList.innerHTML = "";
      if (!history.length) {
        clipboardList.innerHTML = `<div class="text-center opacity-75">{{ _('No entries yet.') }}</div>`;
        return;
      }
      history.slice(0, 20).forEach(item => {
        const div = document.createElement("div");
        div.className = "clipboard-item";
        const labelMap = {
          random: "{{ _('Password') }}",
          phrase: "{{ _('Passphrase') }}",
          pin: "{{ _('PIN') }}",
        };
        div.innerHTML = `
          <strong>${labelMap[item.type]} — ${item.timestamp}</strong>
          <code>${item.value}</code>
        `;
        clipboardList.appendChild(div);
      });
    }

    copyClipboard.addEventListener("click", () => {
      if (!history.length) {
        showToast("{{ _('Clipboard is empty.') }}", "warning");
        return;
      }
      const text = history.map(item => `${item.type.toUpperCase()}: ${item.value}`).join("\\n");
      navigator.clipboard.writeText(text)
        .then(() => showToast("{{ _('Session clipboard copied.') }}", "success"))
        .catch(() => showToast("{{ _('Unable to copy clipboard.') }}", "danger"));
    });

    clearClipboard.addEventListener("click", () => {
      history.length = 0;
      renderHistory();
      showToast("{{ _('Session clipboard cleared.') }}", "info");
    });

    toggleOptionPanels();
    renderHistory();
    generate();
  })();
</script>

{% endblock %}
