{% extends "base.html" %}
{% block content %}

<style>
  .host-summary-card {
    border-radius: 0.85rem;
    border: 1px solid transparent;
    transition: background 0.35s ease, color 0.35s ease, border-color 0.35s ease;
    overflow: hidden;
  }
  html[data-bs-theme="light"] body .host-summary-card {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(30, 64, 175, 0.12) 60%, rgba(76, 29, 149, 0.14) 100%);
    color: #1f2937;
    border-color: rgba(59, 130, 246, 0.18);
  }
  html[data-bs-theme="dark"] body .host-summary-card {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(17, 24, 39, 0.78) 55%, rgba(30, 41, 59, 0.72) 100%);
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.32);
    backdrop-filter: blur(12px);
  }
  .host-summary-card .metric {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .host-summary-card .metric-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 1rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.9rem;
    box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.08);
  }
  html[data-bs-theme="dark"] body .host-summary-card .metric-pill {
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
  }
  .datatable-nowrap th,
  .datatable-nowrap td {
    white-space: nowrap;
  }
  .dataTables_wrapper .dataTables_scroll {
    overflow: auto;
  }
  .badge-soft {
    border-radius: 999px;
    padding: 0.25rem 0.7rem;
    font-size: 0.75rem;
  }
  .notes-cell {
    max-width: 260px;
  }
  .device-chip {
    border-radius: 999px;
    padding: 0.2rem 0.65rem;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }
  .btn-readonly {
    opacity: 0.55;
  }
</style>

{% set module_access = module_access if module_access is defined else 'write' %}
{% set can_manage_networks = can_manage_networks if can_manage_networks is defined else (current_user.is_authenticated and current_user.role == 'admin') %}

<div class="card host-summary-card border-0 shadow-sm mb-3">
  <div class="card-body py-3">
    <div class="d-flex flex-wrap align-items-center gap-4">
      <div class="metric">
        <span class="metric-pill bg-primary-subtle text-primary-emphasis">
          <i class="fa fa-network-wired"></i> {{ network.name }}
        </span>
        <span class="metric-label">{{ _('Network') }}</span>
      </div>
      <div class="metric">
        <span class="metric-pill bg-info-subtle text-info-emphasis">
          <i class="fa fa-diagram-project"></i> {{ network.cidr }}
        </span>
        <span class="metric-label">{{ _('CIDR') }}</span>
      </div>
      <div class="metric">
        <span class="metric-pill bg-success-subtle text-success-emphasis">
          <i class="fa fa-users"></i> {{ total_hosts }}
        </span>
        <span class="metric-label">{{ _('Hosts Managed') }}</span>
      </div>
      <div class="metric">
        <span class="metric-pill bg-warning-subtle text-warning-emphasis">
          <i class="fa fa-database"></i> {{ network.host_capacity }}
        </span>
        <span class="metric-label">{{ _('Capacity') }}</span>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="fa fa-desktop"></i> {{ _('Hosts in') }} {{ network.cidr }}</h4>
  <div class="d-flex gap-2">
    <a href="{{ url_for('networks.network_maps') }}?lang={{ g.locale }}" class="btn btn-outline-secondary">
      <i class="fa fa-arrow-left"></i> {{ _('Back to Networks') }}
    </a>
    {% if can_generate and can_manage_networks %}
    <form id="generate-hosts-form" action="{{ url_for('networks.generate_hosts', network_id=network.id) }}" method="post" class="d-inline">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-primary">
        <i class="fa fa-magic me-1"></i>{{ _('Generate Hosts') }}
      </button>
    </form>
    {% elif can_generate %}
    <button type="button" class="btn btn-primary btn-readonly" data-readonly="true" title="{{ _('Read-only access') }}">
      <i class="fa fa-magic me-1"></i>{{ _('Generate Hosts') }}
    </button>
    {% endif %}
  </div>
</div>

<table id="hostTable" class="table table-striped table-hover align-middle w-100 datatable-nowrap">
  <thead class="table-dark">
    <tr>
      <th>{{ _('IP Address') }}</th>
      <th>{{ _('Hostname') }}</th>
      <th>{{ _('MAC Address') }}</th>
      <th>{{ _('Device Type') }}</th>
      <th>{{ _('Assigned To') }}</th>
      <th>{{ _('Reserved') }}</th>
      <th>{{ _('Description') }}</th>
      <th>{{ _('Actions') }}</th>
    </tr>
  </thead>
  <tbody>
    {% for host in hosts %}
    <tr data-host='{{ host.as_dict()|tojson }}'>
      <td class="fw-semibold">{{ host.ip_address }}</td>
      <td>{{ host.hostname or '—' }}</td>
      <td>{{ host.mac_address or '—' }}</td>
      <td>
        {% if host.device_type %}
          <span class="device-chip bg-body-tertiary text-body">
            <i class="fa fa-microchip"></i>{{ _(host.device_type) }}
          </span>
        {% else %}
          —
        {% endif %}
      </td>
      <td>{{ host.assigned_to or '—' }}</td>
      <td>
        {% if host.is_reserved %}
          <span class="badge-soft bg-danger-subtle text-danger-emphasis">{{ _('Reserved') }}</span>
        {% else %}
          <span class="badge-soft bg-success-subtle text-success-emphasis">{{ _('Available') }}</span>
        {% endif %}
      </td>
      <td class="text-truncate notes-cell">{{ host.description or '—' }}</td>
      <td class="text-nowrap">
        <button type="button"
                class="btn btn-sm btn-outline-primary edit-host-btn {% if not can_manage_networks %}btn-readonly{% endif %}"
                data-update-url="{{ url_for('networks.update_host', network_id=network.id, host_id=host.id) }}"
                {% if not can_manage_networks %}data-readonly="true"{% endif %}>
          <i class="fa fa-edit"></i>
        </button>
        <button type="button"
                class="btn btn-sm btn-outline-danger delete-host-btn ms-1 {% if not can_manage_networks %}btn-readonly{% endif %}"
                data-delete-url="{{ url_for('networks.delete_host', network_id=network.id, host_id=host.id) }}"
                data-ip="{{ host.ip_address }}"
                {% if not can_manage_networks %}data-readonly="true"{% endif %}>
          <i class="fa fa-trash"></i>
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% if can_manage_networks %}
<!-- Edit Host Modal -->
<div class="modal fade" id="hostEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="host-edit-form" action="#" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-pen-to-square me-2"></i>{{ _('Edit Host') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">{{ _('IP Address') }}</label>
            <input name="ip_address" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">{{ _('Hostname') }}</label>
            <input name="hostname" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">{{ _('MAC Address') }}</label>
            <input name="mac_address" class="form-control" placeholder="AA:BB:CC:DD:EE:FF">
          </div>
          <div class="mb-3">
            <label class="form-label">{{ _('Device Type') }}</label>
            <select name="device_type" class="form-select">
              <option value="">{{ _('Select...') }}</option>
              <option value="Server">{{ _('Server') }}</option>
              <option value="Printer">{{ _('Printer') }}</option>
              <option value="Workstation">{{ _('Workstation') }}</option>
              <option value="Network">{{ _('Network Device') }}</option>
              <option value="IoT">{{ _('IoT Device') }}</option>
              <option value="VoIP">{{ _('VoIP / Telephony') }}</option>
              <option value="Camera">{{ _('Camera / CCTV') }}</option>
              <option value="Other">{{ _('Other') }}</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">{{ _('Assigned To (User / Asset)') }}</label>
            <input name="assigned_to" class="form-control">
          </div>
          <div class="mb-3 form-check">
            <input class="form-check-input" type="checkbox" name="is_reserved" id="hostReserved">
            <label class="form-check-label" for="hostReserved">{{ _('Reserve this IP address') }}</label>
          </div>
          <div class="mb-3">
            <label class="form-label">{{ _('Notes') }}</label>
            <textarea name="description" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-save"></i> {{ _('Update') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Host Modal -->
<div class="modal fade" id="hostDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="host-delete-form" action="#" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-trash me-2"></i>{{ _('Delete Host') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">{{ _('Are you sure you want to delete host') }} <strong id="host-delete-ip"></strong>?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-danger">
            <i class="fa fa-trash"></i> {{ _('Delete') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
$(function() {
  const moduleAccessValue = "{{ module_access|default('write') }}";
  const canManage = moduleAccessValue === "write" && {{ 'true' if can_manage_networks else 'false' }};
  const hostTable = $('#hostTable').DataTable({
    order: [[0, 'asc']],
    pageLength: 50,
    language: { url: "{{ url_for('static', filename='datatables/' + g.locale + '.json') }}" },
    scrollX: true,
    scrollCollapse: true,
    autoWidth: false,
    dom: "<'row mb-2'<'col-md-6 d-flex align-items-center gap-2'lB><'col-md-6 text-end'f>>" +
         "<'row'<'col-sm-12'tr>>" +
         "<'row mt-3'<'col-12'Q>>" +
         "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
    buttons: [
      { extend: 'excelHtml5', text: '<i class=\"fa fa-file-excel\"></i> {{ _("Excel") }}', className: 'btn btn-success btn-sm mx-1' },
      { extend: 'print', text: '<i class=\"fa fa-print\"></i> {{ _("Print") }}', className: 'btn btn-secondary btn-sm mx-1' },
      { extend: 'searchBuilder', text: '<i class=\"fa fa-filter\"></i> {{ _("Advanced Filters") }}', className: 'btn btn-secondary btn-sm mx-1' }
    ],
    searchBuilder: {
      columns: [0,1,2,3,4,5,6]
    }
  });

  function submitForm($form, modalId) {
    const submitBtn = $form.find('button[type="submit"]');
    const originalHtml = submitBtn.html();
    submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {{ _("Saving...") }}');

    if (!canManage) {
      submitBtn.prop('disabled', false).html(originalHtml);
      showToast('{{ _("Read-only access. Changes cannot be saved.") }}', 'info');
      return;
    }

    $.ajax({
      url: $form.attr('action'),
      type: 'POST',
      data: $form.serialize(),
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(res) {
        if (!res || res.success === false) {
          const msg = (res && res.message) ? res.message : '❌ {{ _("Unexpected error while saving.") }}';
          const category = (res && res.category) ? res.category : 'danger';
          showToast(msg, category);
          submitBtn.prop('disabled', false).html(originalHtml);
          return;
        }
        if (modalId) {
          const modalEl = document.getElementById(modalId);
          if (modalEl) {
            const instance = bootstrap.Modal.getInstance(modalEl);
            if (instance) instance.hide();
          }
        }
        showToast(res.message || '{{ _("Operation completed successfully") }}', res.category || 'success');
        setTimeout(() => window.location.reload(), 400);
      },
      error: function(xhr) {
        const data = xhr.responseJSON || {};
        const msg = data.message || '❌ {{ _("Unexpected error while saving.") }}';
        const category = data.category || 'danger';
        showToast(msg, category);
        submitBtn.prop('disabled', false).html(originalHtml);
      }
    });
  }

  $('#host-edit-form').on('submit', function(e) {
    e.preventDefault();
    submitForm($(this), 'hostEditModal');
  });

  $('#host-delete-form').on('submit', function(e) {
    e.preventDefault();
    submitForm($(this), 'hostDeleteModal');
  });

  $(document).on('click', '.edit-host-btn', function() {
    if (!canManage) {
      showToast('{{ _("You have read-only access to Network Maps.") }}', 'info');
      return;
    }
    const btn = $(this);
    const row = btn.closest('tr');
    const payloadStr = row.attr('data-host');
    if (!payloadStr) return;
    let payload = {};
    try {
      payload = JSON.parse(payloadStr);
    } catch (err) {
      console.error('Failed to parse host payload', err);
      return;
    }
    const form = $('#host-edit-form');
    form.attr('action', btn.data('update-url'));
    form.find('[name="ip_address"]').val(payload.ip_address);
    form.find('[name="hostname"]').val(payload.hostname);
    form.find('[name="mac_address"]').val(payload.mac_address);
    form.find('[name="device_type"]').val(payload.device_type);
    form.find('[name="assigned_to"]').val(payload.assigned_to);
    form.find('[name="description"]').val(payload.description);
    form.find('[name="is_reserved"]').prop('checked', payload.is_reserved === true);
    const modal = new bootstrap.Modal(document.getElementById('hostEditModal'));
    modal.show();
  });

  $(document).on('click', '.delete-host-btn', function() {
    if (!canManage) {
      showToast('{{ _("You have read-only access to Network Maps.") }}', 'info');
      return;
    }
    const btn = $(this);
    const modalEl = document.getElementById('hostDeleteModal');
    const modal = new bootstrap.Modal(modalEl);
    $('#host-delete-form').attr('action', btn.data('delete-url'));
    $('#host-delete-ip').text(btn.data('ip'));
    modal.show();
  });

  $(document).on('click', '[data-readonly="true"]', function(e) {
    e.preventDefault();
    showToast('{{ _("You have read-only access to Network Maps.") }}', 'info');
  });
});
</script>
{% endblock %}
