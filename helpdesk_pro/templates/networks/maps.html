{% extends "base.html" %}
{% block content %}

<style>
  .network-summary-card {
    border-radius: 0.85rem;
    border: 1px solid transparent;
    transition: background 0.35s ease, color 0.35s ease, border-color 0.35s ease;
    overflow: hidden;
  }
  html[data-bs-theme="light"] body .network-summary-card {
    background: linear-gradient(135deg, rgba(13, 110, 253, 0.08) 0%, rgba(102, 16, 242, 0.12) 55%, rgba(79, 70, 229, 0.14) 100%);
    color: #1f2937;
    border-color: rgba(13, 110, 253, 0.18);
  }
  html[data-bs-theme="dark"] body .network-summary-card {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.78) 0%, rgba(17, 24, 39, 0.75) 55%, rgba(30, 41, 59, 0.7) 100%);
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.32);
    backdrop-filter: blur(12px);
  }
  .network-summary-card .metric {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .network-summary-card .metric-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 1rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.95rem;
    box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.08);
  }
  html[data-bs-theme="dark"] body .network-summary-card .metric-pill {
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
  }
  .network-summary-card .metric-label {
    text-transform: uppercase;
    font-size: 0.68rem;
    letter-spacing: 0.08em;
    opacity: 0.75;
  }
  .network-summary-card .divider {
    width: 1px;
    height: 36px;
    background: rgba(148, 163, 184, 0.35);
  }
  @media (max-width: 767px) {
    .network-summary-card .divider {
      display: none;
    }
  }

  .datatable-nowrap th,
  .datatable-nowrap td {
    white-space: nowrap;
  }
  .dataTables_wrapper .dataTables_scroll {
    overflow: auto;
  }
  .badge-soft {
    border-radius: 999px;
    padding: 0.25rem 0.7rem;
    font-size: 0.75rem;
  }
  .notes-cell {
    max-width: 280px;
  }
</style>

{% set total_networks = networks|length %}
{% set can_manage_networks = current_user.is_authenticated and current_user.role == 'admin' %}

<div class="card network-summary-card border-0 shadow-sm mb-3">
  <div class="card-body py-3">
    <div class="d-flex flex-wrap align-items-center gap-4">
      <div class="metric">
        <span class="metric-pill bg-primary-subtle text-primary-emphasis">
          <i class="fa fa-network-wired"></i> {{ total_networks }}
        </span>
        <span class="metric-label">{{ _('Total Networks') }}</span>
      </div>
      <div class="divider d-none d-md-block"></div>
      <div class="metric">
        <span class="metric-pill bg-success-subtle text-success-emphasis">
          <i class="fa fa-users"></i> {{ total_hosts }}
        </span>
        <span class="metric-label">{{ _('Aggregate Host Capacity') }}</span>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="fa fa-sitemap"></i> {{ _('Network Maps') }}</h4>
  {% if can_manage_networks %}
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#networkCreateModal">
      <i class="fa fa-plus"></i> {{ _('Add Network') }}
    </button>
  {% endif %}
</div>

<table id="networkTable" class="table table-striped table-hover align-middle w-100 datatable-nowrap">
  <thead class="table-dark">
    <tr>
      <th>{{ _('Name') }}</th>
      <th>{{ _('CIDR') }}</th>
      <th>{{ _('Network') }}</th>
      <th>{{ _('Broadcast') }}</th>
      <th>{{ _('Hosts') }}</th>
      <th>{{ _('Gateway') }}</th>
      <th>{{ _('Site') }}</th>
      <th>{{ _('VLAN') }}</th>
      <th>{{ _('Description') }}</th>
      <th>{{ _('Notes') }}</th>
      <th>{{ _('Actions') }}</th>
    </tr>
  </thead>
  <tbody>
    {% for net in networks %}
    <tr data-id="{{ net.id }}" data-network='{{ net.as_dict()|tojson }}'>
      <td class="fw-semibold">{{ net.name }}</td>
      <td>{{ net.cidr }}</td>
      <td>{{ net.network_address }}</td>
      <td>{{ net.broadcast_address }}</td>
      <td>
        <span class="badge-soft bg-info-subtle text-info-emphasis">
          {{ net.host_capacity }}
        </span>
      </td>
      <td>{{ net.gateway or '—' }}</td>
      <td>{{ net.site or '—' }}</td>
      <td>{{ net.vlan or '—' }}</td>
      <td class="text-truncate" style="max-width: 220px;">{{ net.description or '—' }}</td>
      <td class="text-truncate notes-cell">{{ net.notes or '—' }}</td>
      <td class="text-nowrap">
        <a href="{{ url_for('networks.network_hosts', network_id=net.id) }}?lang={{ g.locale }}" class="btn btn-sm btn-outline-info">
          <i class="fa fa-eye"></i>
        </a>
        {% if can_manage_networks %}
          <button type="button"
                  class="btn btn-sm btn-outline-primary edit-network-btn"
                  data-id="{{ net.id }}"
                  data-update-url="{{ url_for('networks.update_network', network_id=net.id) }}">
            <i class="fa fa-edit"></i>
          </button>
          <button type="button"
                  class="btn btn-sm btn-outline-danger delete-network-btn ms-1"
                  data-id="{{ net.id }}"
                  data-delete-url="{{ url_for('networks.delete_network', network_id=net.id) }}"
                  data-name="{{ net.name }}">
            <i class="fa fa-trash"></i>
          </button>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Create Modal -->
{% if can_manage_networks %}
<div class="modal fade" id="networkCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form id="network-create-form" action="{{ url_for('networks.create_network') }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-plus-circle me-2"></i>{{ _('New Network') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ _('Name') }}</label>
              <input name="name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Network (CIDR)') }}</label>
              <input name="cidr" class="form-control" placeholder="192.168.10.0/24" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Site / Location') }}</label>
              <input name="site" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('VLAN') }}</label>
              <input name="vlan" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Gateway') }}</label>
              <input name="gateway" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">{{ _('Description') }}</label>
              <textarea name="description" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">{{ _('Notes') }}</label>
              <textarea name="notes" class="form-control" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-success">
            <i class="fa fa-save"></i> {{ _('Save') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- Edit Modal -->
<div class="modal fade" id="networkEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form id="network-edit-form" action="#" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-pen-to-square me-2"></i>{{ _('Edit Network') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ _('Name') }}</label>
              <input name="name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Network (CIDR)') }}</label>
              <input name="cidr" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Site / Location') }}</label>
              <input name="site" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('VLAN') }}</label>
              <input name="vlan" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Gateway') }}</label>
              <input name="gateway" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">{{ _('Description') }}</label>
              <textarea name="description" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">{{ _('Notes') }}</label>
              <textarea name="notes" class="form-control" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-save"></i> {{ _('Update') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="networkDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="network-delete-form" action="#" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-trash me-2"></i>{{ _('Delete Network') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">{{ _('Are you sure you want to delete') }} <strong id="network-delete-name"></strong>?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-danger">
            <i class="fa fa-trash"></i> {{ _('Delete') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Host Preview Modal -->
<div class="modal fade" id="networkHostPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header modal-header-gradient text-white">
        <h5 class="modal-title" id="network-host-preview-title">
          <i class="fa fa-list-ol me-2"></i>{{ _('Network Hosts') }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="network-host-preview-meta" class="small text-muted mb-3"></div>
        <div id="network-host-preview-body" class="d-flex flex-wrap gap-2">
          <!-- Populated dynamically -->
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(function() {
  const networkTable = $('#networkTable').DataTable({
    order: [[0, 'asc']],
    pageLength: 25,
    language: { url: "{{ url_for('static', filename='datatables/' + g.locale + '.json') }}" },
    scrollX: true,
    scrollCollapse: true,
    autoWidth: false,
    dom: "<'row mb-2'<'col-md-6 d-flex align-items-center gap-2'lB><'col-md-6 text-end'f>>" +
         "<'row'<'col-sm-12'tr>>" +
         "<'row mt-3'<'col-12'Q>>" +
         "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
    buttons: [
      { extend: 'excelHtml5', text: '<i class=\"fa fa-file-excel\"></i> {{ _("Excel") }}', className: 'btn btn-success btn-sm mx-1' },
      { extend: 'print', text: '<i class=\"fa fa-print\"></i> {{ _("Print") }}', className: 'btn btn-secondary btn-sm mx-1' },
      { extend: 'searchBuilder', text: '<i class=\"fa fa-filter\"></i> {{ _("Advanced Filters") }}', className: 'btn btn-secondary btn-sm mx-1' }
    ],
    searchBuilder: {
      columns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
    }
  });

  function submitForm($form, modalId) {
    const submitBtn = $form.find('button[type="submit"]');
    const originalHtml = submitBtn.html();
    submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {{ _("Saving...") }}');

    $.ajax({
      url: $form.attr('action'),
      type: 'POST',
      data: $form.serialize(),
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(res) {
        if (!res || res.success === false) {
          const msg = (res && res.message) ? res.message : '❌ {{ _("Unexpected error while saving.") }}';
          const category = (res && res.category) ? res.category : 'danger';
          showToast(msg, category);
          submitBtn.prop('disabled', false).html(originalHtml);
          return;
        }
        if (modalId) {
          const modalEl = document.getElementById(modalId);
          if (modalEl) {
            const instance = bootstrap.Modal.getInstance(modalEl);
            if (instance) instance.hide();
          }
        }
        showToast(res.message || '{{ _("Operation completed successfully") }}', res.category || 'success');
        setTimeout(() => window.location.reload(), 400);
      },
      error: function(xhr) {
        const data = xhr.responseJSON || {};
        const msg = data.message || '❌ {{ _("Unexpected error while saving.") }}';
        const category = data.category || 'danger';
        showToast(msg, category);
        submitBtn.prop('disabled', false).html(originalHtml);
      }
    });
  }

  $('#network-create-form').on('submit', function(e) {
    e.preventDefault();
    submitForm($(this), 'networkCreateModal');
  });

  $('#network-edit-form').on('submit', function(e) {
    e.preventDefault();
    submitForm($(this), 'networkEditModal');
  });

  $('#network-delete-form').on('submit', function(e) {
    e.preventDefault();
    submitForm($(this), 'networkDeleteModal');
  });

  const networkCreateModal = document.getElementById('networkCreateModal');
  if (networkCreateModal) {
    networkCreateModal.addEventListener('hidden.bs.modal', function() {
      const form = this.querySelector('form');
      if (form) form.reset();
    });
  }

  function populateNetworkForm(data, updateUrl) {
    const form = $('#network-edit-form');
    form.attr('action', updateUrl);
    form.find('[name="name"]').val(data.name);
    form.find('[name="cidr"]').val(data.cidr);
    form.find('[name="site"]').val(data.site);
    form.find('[name="vlan"]').val(data.vlan);
    form.find('[name="gateway"]').val(data.gateway);
    form.find('[name="description"]').val(data.description);
    form.find('[name="notes"]').val(data.notes);
  }

  $(document).on('click', '.edit-network-btn', function() {
    const btn = $(this);
    const row = btn.closest('tr');
    const updateUrl = btn.data('update-url');
    const payloadStr = row.attr('data-network');
    if (!payloadStr) return;
    let payload = {};
    try {
      payload = JSON.parse(payloadStr);
    } catch (err) {
      console.error('Failed to parse network payload', err);
      return;
    }
    populateNetworkForm(payload, updateUrl);
    const modal = new bootstrap.Modal(document.getElementById('networkEditModal'));
    modal.show();
  });

  $(document).on('click', '.delete-network-btn', function() {
    const btn = $(this);
    const modalEl = document.getElementById('networkDeleteModal');
    if (!modalEl) return;
    const modal = new bootstrap.Modal(modalEl);
    $('#network-delete-form').attr('action', btn.data('delete-url'));
    $('#network-delete-form').data('id', btn.data('id'));
    $('#network-delete-name').text(btn.data('name'));
    modal.show();
  });

  $('#networkTable tbody').on('dblclick', 'tr', function() {
    const networkId = $(this).data('id');
    const payloadStr = $(this).attr('data-network');
    if (!networkId) return;

    const modalEl = document.getElementById('networkHostPreviewModal');
    if (!modalEl) return;

    const modal = new bootstrap.Modal(modalEl);
    const $body = $('#network-host-preview-body');
    const $meta = $('#network-host-preview-meta');
    const $title = $('#network-host-preview-title');

    let payload = {};
    if (payloadStr) {
      try {
        payload = JSON.parse(payloadStr);
      } catch (err) {
        console.error('Failed to parse network payload', err);
      }
    }

    $title.text(`${payload.name || '{{ _("Network Hosts") }}'}`);
    $meta.text('');
    $body
      .removeClass('justify-content-center')
      .html('<div class="w-100 text-center py-4"><i class="fa fa-spinner fa-spin fa-2x"></i></div>');

    modal.show();

    fetch(`/networks/maps/${networkId}/hosts.json`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
    })
      .then(resp => resp.json())
      .then(data => {
        if (!data || data.success === false) {
          const message = (data && data.message) ? data.message : '{{ _("Unable to load host list.") }}';
          $body.addClass('justify-content-center').html(`<div class="alert alert-danger w-100 mb-0">${message}</div>`);
          showToast(message, (data && data.category) || 'danger');
          return;
        }

        const hosts = Array.isArray(data.hosts) ? data.hosts : [];
        const capacity = data.capacity ?? hosts.length;
        const truncated = !!data.truncated;
        const reservedCount = hosts.filter(item => item && item.reserved === true).length;

        $title.text(`${data.network?.name || payload.name || '{{ _("Network Hosts") }}'}`);
        const countText = `${hosts.length} {{ _('addresses listed') }}`;
        const capacityText = capacity ? ` / ${capacity} {{ _('capacity') }}` : '';
        const reservedText = reservedCount ? ` · ${reservedCount} {{ _('reserved') }}` : '';
        $meta.text(`${countText}${capacityText}${reservedText}${truncated ? ' · {{ _("Partial list") }}' : ''}`);

        if (!hosts.length) {
          $body.addClass('justify-content-center').html('<div class="alert alert-warning w-100 mb-0">{{ _("No IP addresses available for this network yet.") }}</div>');
          return;
        }

        const chips = hosts.map(item => {
          const ip = typeof item === 'string' ? item : item.ip;
          const reserved = typeof item === 'object' && item ? item.reserved === true : false;
          const badgeClass = reserved ? 'bg-danger-subtle text-danger-emphasis' : 'bg-secondary-subtle text-secondary-emphasis';
          const icon = reserved ? '<i class="fa fa-lock me-1"></i>' : '<i class="fa fa-circle me-1 text-muted"></i>';
          return `<span class="badge rounded-pill ${badgeClass} px-3 py-2 d-flex align-items-center gap-1">${icon}<span>${ip}</span></span>`;
        });
        $body.removeClass('justify-content-center').html(chips.join(''));

        if (truncated) {
          $body.append('<div class="alert alert-info w-100 mt-3 mb-0">{{ _("Showing a partial list. Generate hosts for the full set.") }}</div>');
        }
      })
      .catch(() => {
        const message = '{{ _("Failed to load host list.") }}';
        $body.addClass('justify-content-center').html(`<div class="alert alert-danger w-100 mb-0">${message}</div>`);
        showToast(message, 'danger');
      });
  });
});
</script>
{% endblock %}
