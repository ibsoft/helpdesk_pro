{% extends "base.html" %}
{% block content %}

<style>
  .chat-container{display:flex;flex-direction:column;flex:1 1 auto;min-height:0;height:100%}
  .chat-messages{flex:1;overflow-y:auto;padding:1rem;background:rgba(15,23,42,.02);border-radius:.75rem;display:flex;flex-direction:column}
  html[data-bs-theme="dark"] body .chat-messages{background:rgba(15,23,42,.4)}
  .chat-bubble{display:inline-flex;flex-direction:column;align-items:flex-start;padding:.9rem 1.1rem;border-radius:1rem;margin-bottom:.75rem;position:relative;width:fit-content;max-width:min(80%,520px);min-width:3.25rem;gap:.4rem;word-break:break-word;overflow-wrap:anywhere;border:1px solid rgba(15,23,42,.08);background:rgba(255,255,255,.9);color:#0f172a}
  html[data-bs-theme="dark"] body .chat-bubble{background:rgba(30,41,59,.85);border-color:rgba(226,232,240,.15);color:#e2e8f0}
  .chat-bubble.me{margin-left:auto;background:rgba(224,247,250,.95);color:#0f172a;border:1px solid rgba(14,165,233,.25);box-shadow:0 6px 14px rgba(14,165,233,.15)}
  html[data-bs-theme="dark"] body .chat-bubble.me{background:rgba(30,64,175,.35);color:#e0f2fe;border-color:rgba(125,211,252,.4);box-shadow:0 6px 14px rgba(15,23,42,.6)}
  .chat-bubble.them{margin-right:auto;background:rgba(248,250,252,.85);color:#0f172a;border-color:rgba(148,163,184,.4)}
  html[data-bs-theme="dark"] body .chat-bubble.them{background:rgba(30,41,59,.9);color:#e2e8f0;border-color:rgba(71,85,105,.8)}
  .chat-bubble.assistant{border-color:rgba(59,130,246,.5);box-shadow:0 10px 30px rgba(59,130,246,.15);background:linear-gradient(135deg,rgba(219,234,254,.85),rgba(224,231,255,.9));color:#0f172a}
  html[data-bs-theme="dark"] body .chat-bubble.assistant{background:linear-gradient(135deg,rgba(30,64,175,.6),rgba(79,70,229,.5));color:#eef2ff}
  .chat-bubble.pending-message{opacity:.8}
  .chat-meta{font-size:.75rem;opacity:.7;margin-top:.35rem}
  .conversation-item{cursor:pointer;border-radius:.85rem;padding:.75rem;transition:background .2s ease,transform .2s ease}
  .conversation-item.active{background:rgba(14,165,233,.15);color:#075985;box-shadow:0 10px 20px rgba(14,165,233,.15)}
  .conversation-item:hover{background:rgba(13,110,253,.1)}
  html[data-bs-theme="dark"] body .conversation-item:hover{background:rgba(59,130,246,.2)}
  html[data-bs-theme="dark"] body .conversation-item.active{background:rgba(37,99,235,.35);color:#e0f2fe}
  .favorite-star{cursor:pointer;transition:transform .2s ease}
  .favorite-star.favorited{color:#f59e0b}
  .favorite-star:hover{transform:scale(1.1)}
  .message-attachment{margin-top:.5rem;display:inline-flex;align-items:center;gap:.35rem;padding:.4rem .6rem;background:rgba(255,255,255,.2);border-radius:.6rem}
  html[data-bs-theme="dark"] body .message-attachment{background:rgba(15,23,42,.45)}
  html, body{height:100%;overflow:hidden}
  .chat-users-list{flex:1 1 auto;overflow-y:auto;min-height:0}
  .col-sidebar-right .card-body.chat-users-list{overflow-y:auto;max-height:calc(100vh - var(--navbar-height) - var(--footer-height) - 8rem)}
  .collab-page{
    display:flex;
    flex-direction:column;
    gap:1rem;
    min-height:calc(100vh - var(--navbar-height) - var(--footer-height));
    height:calc(100vh - var(--navbar-height) - var(--footer-height));
    box-sizing:border-box;
    padding-bottom:2rem;
  }
  .collab-grid{
    flex:1 1 auto;
    display:flex;
    min-height:0;
    overflow:hidden;
    height:100%;
  }
  .collab-grid .row{
    flex:1 1 auto;
    display:flex;
    flex-wrap:nowrap;
    min-height:0;
    height:100%;
  }
  .collab-grid .row>[class*="col-"]{display:flex;flex-direction:column;min-height:0}
  .collab-grid .card{flex:1 1 auto;display:flex;flex-direction:column;min-height:0;overflow:hidden}
  .conversation-list{flex:1 1 auto;overflow-y:auto;min-height:0}
  @media (max-width: 991.98px){
    .collab-page{min-height:auto;height:auto;max-height:none;overflow:visible}
    .collab-grid{flex-direction:column}
    .collab-grid .row{flex-wrap:wrap}
    .collab-grid .row>[class*="col-"]{min-height:auto}
    .collab-grid .card{min-height:auto}
    .conversation-list,.chat-users-list{max-height:360px}
    .chat-container{max-height:none}
    .col-chat .chat-messages{max-height:none}
  }
  .typing-indicator{display:flex;align-items:center;gap:.5rem;font-size:.85rem;color:rgba(15,23,42,.75)}
  html[data-bs-theme="dark"] body .typing-indicator{color:rgba(226,232,240,.8)}
  .typing-dots{display:inline-flex;align-items:center;gap:.3rem}
  .typing-dots span{width:6px;height:6px;border-radius:50%;background-color:currentColor;opacity:.35;animation:typingBounce 1.2s infinite ease-in-out}
  .typing-dots span:nth-child(2){animation-delay:.2s}
  .typing-dots span:nth-child(3){animation-delay:.4s}
  @keyframes typingBounce{0%,60%,100%{transform:translateY(0);opacity:.35}30%{transform:translateY(-4px);opacity:.9}}
  .chat-youtube iframe{border:0;border-radius:.85rem;width:100%;height:100%}
  .chat-youtube{width:260px;max-width:min(90vw,480px)}
  .collab-summary-card{border-radius:.9rem;border:1px solid rgba(148,163,184,.25);background:linear-gradient(135deg,rgba(248,250,252,.95) 0%,rgba(219,234,254,.9) 55%,rgba(224,231,255,.88) 100%);color:#0f172a}
  html[data-bs-theme="dark"] body .collab-summary-card{background:linear-gradient(135deg,rgba(15,23,42,.82) 0%,rgba(17,24,39,.78) 55%,rgba(30,41,59,.74) 100%);border-color:rgba(148,163,184,.35);color:#e2e8f0;backdrop-filter:blur(12px)}
  .collab-summary-card .card-body{padding:.65rem 1rem}
  .collab-summary-card .collab-metric{display:flex;align-items:center;gap:.65rem;text-align:center}
  .collab-summary-card .collab-metric-count{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .75rem;border-radius:999px;font-weight:600;font-size:.85rem;box-shadow:inset 0 0 0 1px rgba(15,23,42,.08)}
  html[data-bs-theme="dark"] body .collab-summary-card .collab-metric-count{box-shadow:inset 0 0 0 1px rgba(226,232,240,.15)}
  .collab-summary-card .collab-metric-label{text-transform:uppercase;font-size:.68rem;letter-spacing:.08em;opacity:.75;white-space:nowrap}
  html[data-bs-theme="dark"] body .collab-summary-card .collab-metric-label{opacity:.85}
  .collab-summary-card .collab-divider{width:1px;height:36px;background:rgba(148,163,184,.36)}
  @media (max-width: 767px){.collab-summary-card .collab-divider{display:none}}
  .assistant-thinking{display:flex;justify-content:flex-start;margin:1rem 0}
  .assistant-thinking .chat-bubble{margin:0}
  .assistant-dots{display:flex;gap:.35rem}
  .assistant-dots span{width:8px;height:8px;border-radius:50%;background-color:currentColor;animation:typingBounce 1.2s infinite ease-in-out}
  .assistant-dots span:nth-child(2){animation-delay:.2s}
  .assistant-dots span:nth-child(3){animation-delay:.4s}
  .send-icon{display:inline-flex;align-items:center;gap:.35rem}
  .assistant-thinking .fa-robot{color:#fb923c;font-size:1.2rem}
  html[data-bs-theme="dark"] body .assistant-thinking .fa-robot{color:#fbbf24}
  .emoji-picker{position:absolute;bottom:70px;right:0;background:linear-gradient(135deg,rgba(255,255,255,.98),rgba(248,250,252,.95));border:1px solid rgba(148,163,184,.4);box-shadow:0 20px 40px rgba(15,23,42,.15);border-radius:.75rem;padding:.5rem;display:flex;flex-wrap:wrap;gap:.35rem;max-width:320px;z-index:5}
  html[data-bs-theme="dark"] body .emoji-picker{background:linear-gradient(135deg,rgba(30,41,59,.95),rgba(15,23,42,.92));border-color:rgba(226,232,240,.2);box-shadow:0 18px 36px rgba(15,23,42,.8)}
  .emoji-picker button{border:none;background:transparent;font-size:1.25rem;line-height:1;padding:.35rem;cursor:pointer;transition:transform .15s ease}
  .emoji-picker button:hover{transform:scale(1.2)}
  .chat-accent-btn{background:linear-gradient(135deg,#f8b4d9,#f97316);color:#1f2937;border:none;box-shadow:0 6px 16px rgba(249,115,22,.35)}
  .chat-accent-btn:hover{color:#1f2937;opacity:.9}
  .chat-container .card-footer{position:relative}
  .copy-btn{position:absolute;top:6px;right:6px;border:none;background:rgba(255,255,255,.7);color:#0f172a;font-size:.85rem;line-height:1;padding:.2rem .4rem;border-radius:.5rem;opacity:0;transition:opacity .2s ease}
  .chat-bubble:hover .copy-btn{opacity:1}
  html[data-bs-theme="dark"] body .copy-btn{background:rgba(15,23,42,.6);color:#e2e8f0}
  .chat-input{background:rgba(248,231,237,.9);border-color:rgba(249,115,22,.35);box-shadow:inset 0 0 0 1px rgba(249,115,22,.2);color:#0f172a}
  .chat-input:focus{background:rgba(255,247,250,.95);border-color:#f97316;box-shadow:0 0 0 .2rem rgba(249,115,22,.15)}
  html[data-bs-theme="dark"] body .chat-input{background:rgba(47,29,82,.65);border-color:rgba(249,115,22,.4);color:#fdf2f8}
  html[data-bs-theme="dark"] body .chat-input:focus{background:rgba(52,23,72,.8);border-color:#fb7185;box-shadow:0 0 0 .2rem rgba(249,115,22,.25)}
</style>

{% set stats = collab_stats %}
<div class="collab-page" id="collabRoot"
  data-general-id="{{ general_conversation.id }}"
  data-typing-endpoint-tpl="{{ url_for('collab.api_conversation_typing', conversation_id=0) }}"
  data-get-messages-url-tpl="{{ url_for('collab.api_get_messages', conversation_id=0) }}"
  data-post-message-url-tpl="{{ url_for('collab.api_post_message', conversation_id=0) }}"
  data-conversations-url="{{ url_for('collab.api_conversations') }}"
  data-unread-url="{{ url_for('collab.api_unread_count') }}"
  data-direct-url="{{ url_for('collab.api_direct_conversation') }}"
  data-toggle-fav-url-tpl="{{ url_for('collab.api_toggle_favorite', target_id=0) }}"
  data-delete-convo-url-tpl="{{ url_for('collab.api_delete_conversation', conversation_id=0) }}"
  {% if current_user.role == 'admin' %}data-purge-url="{{ url_for('collab.api_purge_conversation', conversation_id=general_conversation.id) }}"{% endif %}
  data-text-is-typing="{{ _('is typing') }}"
  data-text-are-typing="{{ _('are typing') }}"
  data-text-someone-typing="{{ _('Someone is typing') }}"
  data-text-message-empty="{{ _('Message cannot be empty.') }}"
  data-text-send-failed="{{ _('Send failed') }}"
  data-text-unable-open="{{ _('Unable to open conversation') }}"
  data-text-general-cleared="{{ _('General chat cleared.') }}"
  data-text-unable-purge="{{ _('Unable to purge general chat.') }}"
  data-text-unable-delete="{{ _('Unable to delete conversation') }}"
  data-text-general-chat="{{ _('General Chat') }}"
  data-text-everyone="{{ _('Everyone in the organization') }}"
  data-text-direct="{{ _('Direct conversation') }}"
  data-text-sending="{{ _('Sending...') }}"
  data-ai-conversation="{{ ai_conversation.id if ai_conversation else 0 }}"
  data-ai-aliases="{{ ai_aliases|join('|') }}"
  data-ai-display="{{ _('AI Assistant') }}"
  data-ai-username="{{ ai_user.username }}"
  data-text-ai-subtitle="{{ _('Ask anything - AI can read your docs!') }}"
  data-text-ai-thinking="{{ _('AI Assistant is thinking...') }}"
  data-text-copy="{{ _('Copy message') }}"
  data-text-copied="{{ _('Copied!') }}"
  data-text-copy-failed="{{ _('Unable to copy message') }}"
  data-csrf-token="{{ csrf_token() }}"
>
  <div class="card collab-summary-card border-0 shadow-sm">
    <div class="card-body py-3">
      <div class="d-flex flex-wrap align-items-center justify-content-left gap-4">
        <div class="collab-metric">
          <span class="collab-metric-count bg-primary-subtle text-primary-emphasis">
            <i class="fa fa-comments"></i> {{ stats.total }}
          </span>
          <span class="collab-metric-label">{{ _('Total Conversations') }}</span>
        </div>
        <div class="collab-divider d-none d-md-block"></div>
        <div class="collab-metric">
          <span class="collab-metric-count bg-success-subtle text-success-emphasis">
            <i class="fa fa-user"></i> {{ stats.direct }}
          </span>
          <span class="collab-metric-label">{{ _('Direct Messages') }}</span>
        </div>
        <div class="collab-metric">
          <span class="collab-metric-count bg-info-subtle text-info-emphasis">
            <i class="fa fa-users"></i> {{ stats.channels }}
          </span>
          <span class="collab-metric-label">{{ _('Team Channels') }}</span>
        </div>
        <div class="collab-metric">
          <span class="collab-metric-count bg-warning-subtle text-warning-emphasis">
            <i class="fa fa-bell"></i> {{ stats.unread }}
          </span>
          <span class="collab-metric-label">{{ _('Unread') }}</span>
        </div>
        <div class="collab-metric">
          <span class="collab-metric-count bg-secondary-subtle text-secondary-emphasis">
            <i class="fa fa-calendar"></i> {{ stats.today }}
          </span>
          <span class="collab-metric-label">{{ _('Messages Today') }}</span>
        </div>
        <div class="collab-metric">
          <span class="collab-metric-count bg-danger-subtle text-danger-emphasis">
            <i class="fa fa-star"></i> {{ stats.favorites }}
          </span>
          <span class="collab-metric-label">{{ _('Favorites') }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="collab-grid">
    <div class="row g-3 flex-grow-1">
      <div class="col-lg-2 col-md-3 col-sidebar-left">
        <div class="card shadow-sm h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fa fa-comments"></i> {{ _('Conversations') }}</span>
            <button class="btn btn-sm btn-outline-primary" id="refreshConvos"><i class="fa fa-rotate"></i></button>
          </div>
          <div class="card-body conversation-list flex-grow-1">
            {% for convo in conversations %}
              <div class="conversation-item {% if convo.id == general_conversation.id %}active{% endif %}" data-convo="{{ convo.id }}" data-ai="{{ 'true' if convo.is_ai else 'false' }}">
                <div class="d-flex justify-content-between align-items-center conversation-header">
                  <strong>{% if convo.is_ai %}{{ _('AI Assistant') }}{% else %}{{ convo.label }}{% endif %}</strong>
                  <div class="d-flex align-items-center gap-2 conv-actions">
                    {% if convo.unread %}
                      <span class="badge bg-danger unread-badge">{{ convo.unread }}</span>
                    {% endif %}
                    {% if convo.can_delete %}
                      <button type="button" class="btn btn-sm btn-outline-danger convo-delete" data-convo="{{ convo.id }}"><i class="fa fa-trash"></i></button>
                    {% endif %}
                  </div>
                </div>
                {% if convo.last_message.text %}
                  <div class="small text-muted text-truncate">{{ convo.last_message.text }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-lg-8 col-md-6 col-chat">
        <div class="card shadow-sm chat-container">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0" id="chatTitle">{{ _('General Chat') }}</h6>
              <small class="text-muted" id="chatSubtitle">{{ _('Everyone in the organization') }}</small>
            </div>
            <div class="d-flex gap-2">
              {% if current_user.role == 'admin' %}
                <button class="btn btn-sm btn-outline-danger d-none" id="purgeGeneralBtn" data-convo="{{ general_conversation.id }}" title="{{ _('Purge General Chat') }}">
                  <i class="fa fa-broom"></i>
                </button>
              {% endif %}
              <button class="btn btn-sm btn-outline-secondary" id="toggleAutoScroll"><i class="fa fa-arrows-down-to-line"></i></button>
            </div>
          </div>
          <div class="chat-messages" id="chatMessages" data-conversation="{{ general_conversation.id }}">
            <div class="text-center text-muted mt-5" id="messagesPlaceholder">
              <i class="fa fa-comments fa-2x"></i>
              <p>{{ _('Select or start a conversation to view messages.') }}</p>
            </div>
          </div>
          <div class="card-footer">
            <div class="typing-indicator d-none mb-2" id="typingIndicator">
              <span id="typingLabel"></span>
              <span class="typing-dots" aria-hidden="true">
                <span></span><span></span><span></span>
              </span>
            </div>
            <form id="chatForm" enctype="multipart/form-data">
              <div class="input-group">
                <input type="hidden" name="conversation_id" id="conversationId" value="{{ general_conversation.id }}">
                <textarea class="form-control chat-input" name="body" id="messageBody" rows="1" placeholder="{{ _('Type your message...') }}"></textarea>
                <button class="btn chat-accent-btn" type="button" id="attachButton"><i class="fa fa-paperclip"></i></button>
                <input type="file" class="d-none" id="messageAttachment" name="attachment">
                <button class="btn chat-accent-btn" type="button" id="emojiButton" title="{{ _('Insert emoji') }}">ðŸ˜Š</button>
                <button class="btn btn-primary" type="submit">
                  <span class="send-icon"><i class="fa fa-paper-plane"></i> {{ _('Send') }}</span>
                  <span class="spinner-border spinner-border-sm d-none" id="sendSpinner" role="status" aria-hidden="true"></span>
                </button>
              </div>
              <div id="attachmentPreview" class="small text-muted mt-1 d-none"></div>
              <div id="emojiPicker" class="emoji-picker d-none" aria-hidden="true"></div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-2 col-md-3 col-sidebar-right">
        <div class="card shadow-sm h-100">
          <div class="card-header"><i class="fa fa-users"></i> {{ _('People') }}</div>
          <div class="card-body chat-users-list flex-grow-1">
            {% for user in users %}
              {% set is_ai_user = ai_user and user.id == ai_user.id %}
              <div class="d-flex justify-content-between align-items-center border-bottom py-2 user-entry" data-user="{{ user.id }}" data-ai="{{ 'true' if is_ai_user else 'false' }}">
                <div>
                  <strong>{% if is_ai_user %}{{ _('AI Assistant') }}{% else %}{{ user.username }}{% endif %}</strong>
                  {% if is_ai_user %}
                    <div class="small text-muted">{{ _(' @AI') }}</div>
                  {% elif user.role %}
                    <div class="small text-muted">{{ _(user.role|capitalize) }}</div>
                  {% endif %}
                </div>
                <div class="d-flex align-items-center gap-2">
                  {% if not is_ai_user %}
                    <i class="fa fa-star favorite-star {% if user.id in favorites %}favorited{% endif %}" data-user="{{ user.id }}"></i>
                  {% endif %}
                  <button class="btn btn-sm btn-outline-primary start-direct" data-user="{{ user.id }}"><i class="fa fa-comments"></i></button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(function () {
  const root = document.getElementById('collabRoot');
  const D = root.dataset;
  const parseIntSafe = (v, def=0) => { const n = parseInt(v,10); return Number.isFinite(n) ? n : def; };
  const csrfToken = D.csrfToken || (document.querySelector('input[name="csrf_token"]') || {}).value || '';
  let aiConversationId = parseIntSafe(D.aiConversation);
  const aiAliases = (D.aiAliases || '').split('|').map(v=>v.trim().toLowerCase()).filter(Boolean);
  const aiDisplayName = D.aiDisplay || 'AI Assistant';
  const txtAiSubtitle = D.textAiSubtitle || 'Ask anything - AI can read your docs!';
  const txtAiThinking = D.textAiThinking || 'AI Assistant is thinking...';
  const txtCopy = D.textCopy || 'Copy message';
  const txtCopied = D.textCopied || 'Copied!';
  const txtCopyFailed = D.textCopyFailed || 'Unable to copy message';

  $.ajaxSetup({
    beforeSend: function(xhr, settings){
      if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && csrfToken){
        xhr.setRequestHeader('X-CSRFToken', csrfToken);
      }
    }
  });

  let currentConversationId = parseIntSafe(D.generalId);
  let currentConversationIsAi = currentConversationId === aiConversationId;
  let autoScroll = true;
  let pollingInterval = null;
  let pendingDeleteId = null;
  let lastMessagesSignature = null;
  let typingCooldownUntil = 0;
  let typingResetTimer = null;
  let pendingAssistantReply = false;

  const $messages = $('#chatMessages');
  const $conversationId = $('#conversationId');
  const $placeholder = $('#messagesPlaceholder');
  const $typingIndicator = $('#typingIndicator');
  const $typingLabel = $('#typingLabel');
  const $purgeButton = $('#purgeGeneralBtn');
  const $sendSpinner = $('#sendSpinner');
  const $emojiPicker = $('#emojiPicker');
  const $emojiButton = $('#emojiButton');
  const $messageBody = $('#messageBody');

  const $assistantThinking = $('<div>').attr('id','assistantThinking').addClass('assistant-thinking d-none');
  const $assistantBubble = $('<div>').addClass('chat-bubble them assistant');
  const $assistantHeader = $('<div>').addClass('fw-semibold d-flex align-items-center gap-2')
    .append($('<i>').addClass('fa fa-robot fa-spin'))
    .append($('<span>').text(txtAiThinking));
  const $assistantDots = $('<div>').addClass('assistant-dots').attr('aria-hidden','true');
  $assistantDots.append($('<span>')).append($('<span>')).append($('<span>'));
  $assistantBubble.append($assistantHeader).append($assistantDots);
  $assistantThinking.append($assistantBubble);
  $messages.append($assistantThinking);

  const generalConversationId = parseIntSafe(D.generalId);
  const typingEndpointTemplate = D.typingEndpointTpl || '';
  const urlGetMessagesTpl = D.getMessagesUrlTpl || '';
  const urlPostMessageTpl = D.postMessageUrlTpl || '';
  const urlConversations = D.conversationsUrl || '';
  const urlUnread = D.unreadUrl || '';
  const urlDirect = D.directUrl || '';
  const urlToggleFavTpl = D.toggleFavUrlTpl || '';
  const urlDeleteConvoTpl = D.deleteConvoUrlTpl || '';
  const purgeGeneralUrl = D.purgeUrl || null;

  const typingSingleText = D.textIsTyping || 'is typing';
  const typingPluralText = D.textAreTyping || 'are typing';
  const typingFallbackText = D.textSomeoneTyping || 'Someone is typing';
  const purgeSuccessText = D.textGeneralCleared || 'General chat cleared.';
  const purgeErrorText = D.textUnablePurge || 'Unable to purge general chat.';
  const txtMsgEmpty = D.textMessageEmpty || 'Message cannot be empty.';
  const txtSendFailed = D.textSendFailed || 'Send failed';
  const txtUnableOpen = D.textUnableOpen || 'Unable to open conversation';
  const txtUnableDelete = D.textUnableDelete || 'Unable to delete conversation';
  const txtGeneralChat = D.textGeneralChat || 'General Chat';
  const txtEveryone = D.textEveryone || 'Everyone in the organization';
  const txtDirect = D.textDirect || 'Direct conversation';
  const txtSending = D.textSending || 'Sending...';

  const urlTpl = (tpl, id) => (tpl || '').replace('0', String(id));
  const includesAiAlias = (text)=>{
    if (!text) return false;
    const lowered = String(text).toLowerCase();
    return aiAliases.some(alias=>alias && lowered.includes(alias));
  };

  function scrollToBottom(force=false){
    if (autoScroll || force) $messages.stop().animate({ scrollTop: $messages[0].scrollHeight }, 400);
  }
  const typingEndpoint = (convoId) => urlTpl(typingEndpointTemplate, convoId);

  const emojiList = ['ðŸ˜€','ðŸ˜','ðŸ˜‚','ðŸ¤£','ðŸ˜Š','ðŸ˜','ðŸ˜˜','ðŸ˜Ž','ðŸ¤“','ðŸ˜‡','ðŸ™ƒ','ðŸ˜œ','ðŸ¤©','ðŸ¥³','ðŸ¤ ','ðŸ˜¤','ðŸ˜±','ðŸ˜´','ðŸ¤–','ðŸ‘¾','ðŸ’¡','ðŸ”¥','ðŸŒˆ','â­','âš¡','ðŸ’¥','ðŸ’¯','ðŸ€','ðŸŒ¸','ðŸ•','â˜•','ðŸ©','âš½','ðŸŽ¯','ðŸŽ‰','ðŸš€','âœˆï¸','ðŸ› ï¸','ðŸ’»','ðŸ“±','ðŸ“Ž','ðŸ“','ðŸ§ ','â¤ï¸'];
  function buildEmojiPicker(){
    if ($emojiPicker.data('built')) return;
    emojiList.forEach(emoji=>{
      const btn = $('<button>', { type: 'button', 'aria-label': emoji }).text(emoji).addClass('emoji-option');
      $emojiPicker.append(btn);
    });
    $emojiPicker.data('built', true);
  }

  function toggleEmojiPicker(state){
    buildEmojiPicker();
    const show = typeof state === 'boolean' ? state : $emojiPicker.hasClass('d-none');
    if (show){
      $emojiPicker.removeClass('d-none');
      $emojiPicker.attr('aria-hidden', 'false');
    } else {
      $emojiPicker.addClass('d-none');
      $emojiPicker.attr('aria-hidden', 'true');
    }
  }

  function insertEmoji(emoji){
    const el = $messageBody.get(0);
    if (!el) return;
    const start = el.selectionStart ?? el.value.length;
    const end = el.selectionEnd ?? el.value.length;
    const value = el.value;
    el.value = value.slice(0, start) + emoji + value.slice(end);
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.focus();
    const pos = start + emoji.length;
    el.setSelectionRange(pos, pos);
  }

  function fallbackCopy(text){
    const temp = $('<textarea>').css({position:'absolute',left:'-9999px',top:'0'}).val(text);
    $('body').append(temp);
    temp[0].select();
    try{
      const success = document.execCommand('copy');
      showToast(success ? txtCopied : txtCopyFailed, success ? 'success' : 'warning');
    } catch (err){
      showToast(txtCopyFailed, 'warning');
    }
    temp.remove();
  }

  function copyTextToClipboard(text){
    if (!text) return;
    const content = text;
    if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(content)
        .then(()=>showToast(txtCopied, 'success'))
        .catch(()=>fallbackCopy(content));
    } else {
      fallbackCopy(content);
    }
  }

  function attachCopyButton($bubble, text){
    const clean = (text || '').trim();
    const fallback = $bubble.clone().children().map(function(){
      const $child = $(this);
      if ($child.hasClass('chat-meta') || $child.hasClass('copy-btn')) return '';
      return $child.text();
    }).get().join(' ').trim();
    const content = clean || fallback;
    if (!content) return;
    const btn = $('<button>', { type: 'button', title: txtCopy }).addClass('copy-btn');
    btn.append($('<i>').addClass('fa fa-copy'));
    btn.on('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      copyTextToClipboard(content);
    });
    $bubble.append(btn);
  }

  function addLocalMessage(text){
    const bubble = $('<div>').addClass('chat-bubble me pending-message');
    bubble.append($('<div>').addClass('chat-body').text(text));
    bubble.append($('<div>').addClass('chat-meta').text(txtSending));
    attachCopyButton(bubble, text);
    $messages.append(bubble);
    scrollToBottom(true);
    return bubble;
  }

  function toggleAssistantThinking(state){
    if (state){
      $assistantThinking.appendTo($messages);
      $assistantThinking.removeClass('d-none');
      scrollToBottom(true);
    } else {
      $assistantThinking.addClass('d-none');
    }
  }

  function setSending(state){
    const $submit = $('#chatForm button[type="submit"]');
    $submit.prop('disabled', state);
    $sendSpinner.toggleClass('d-none', !state);
  }

  function createYoutubeEmbed(youtubeId, url){
    if (!youtubeId) return null;
    const embedUrl = `https://www.youtube.com/embed/${youtubeId}`;
    const iframe = $('<iframe>', {
      src: embedUrl,
      allow: 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share',
      allowfullscreen: true,
      loading: 'lazy',
      title: 'YouTube video player',
    });
    if (url) iframe.attr('data-source', url);
    return $('<div>').addClass('ratio ratio-16x9 chat-youtube mt-2').append(iframe);
  }

  function renderAttachment(container, attachment){
    if (!attachment) return;
    if (attachment.is_image){
      const img = $('<img>').addClass('img-fluid rounded chat-image').attr('src', attachment.url).attr('alt', attachment.original).attr('data-full', attachment.url);
      container.append($('<div class="mt-2">').append(img));
      return;
    }
    if (attachment.youtube_id){
      const embed = createYoutubeEmbed(attachment.youtube_id, attachment.url);
      if (embed) { container.append(embed); return; }
    }
    if (attachment.youtube_thumb){
      const link = $('<a>').attr('href', attachment.url).attr('target', '_blank').addClass('d-inline-block mt-2');
      link.append($('<img>').addClass('img-fluid rounded').attr('src', attachment.youtube_thumb).attr('alt', attachment.original));
      container.append(link);
    } else {
      const link = $('<a>').attr('href', attachment.url).attr('target', '_blank').addClass('message-attachment mt-2');
      link.html('<i class="fa fa-paperclip"></i> ' + attachment.original);
      container.append(link);
    }
  }

  function extractYoutube(text){
    if (!text) return null;
    const m = text.match(/https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/);
    return m ? { id: m[1], url: m[0], thumb: `https://img.youtube.com/vi/${m[1]}/hqdefault.jpg` } : null;
  }

  function linkify(text){
    if (!text) return '';
    return text.replace(/(https?:\/\/[\w\-._~:\/?#[\]@!$&'()*+,;=%]+)/g,'<a href="$1" target="_blank">$1</a>').replace(/\n/g,'<br>');
  }

  function renderMessages(messages){
    const signature = messages.length ? messages.map(m=>m.id).join('|') : 'empty';
    if (signature === lastMessagesSignature) return;
    lastMessagesSignature = signature;

    if (!messages.length){
      $messages.find('.chat-bubble').remove();
      $placeholder.removeClass('d-none');
      return;
    }

    $placeholder.addClass('d-none');
    const frag = $(document.createDocumentFragment());
    let awaitingAssistant = false;
    messages.forEach(msg=>{
      const bubble = $('<div>').addClass('chat-bubble').addClass(msg.isMine ? 'me' : 'them');
      if (msg.isAssistant){
        bubble.addClass('assistant');
        bubble.prepend($('<div>').addClass('fw-semibold').text(aiDisplayName));
      }
      let yt = null;
      if (msg.body){
        bubble.append($('<div>').addClass('chat-body').html(linkify(msg.body)));
        yt = extractYoutube(msg.body);
      }
      renderAttachment(bubble, msg.attachment);
      if (!msg.attachment && yt){
        const embed = createYoutubeEmbed(yt.id, yt.url);
        if (embed) bubble.append(embed);
      }
      const plainText = msg.body || '';
      attachCopyButton(bubble, plainText);
      if (!msg.isAssistant && includesAiAlias(plainText)){
        awaitingAssistant = true;
      }
      if (msg.isAssistant){
        awaitingAssistant = false;
      }
      bubble.append($('<div>').addClass('chat-meta').text(`${msg.sender_name} â€¢ ${new Date(msg.created_at).toLocaleString()}`));
      frag.append(bubble);
    });
    $messages.children('.chat-bubble').remove();
    $messages.append(frag);
    if (pendingAssistantReply && messages.some(m=>m.isAssistant)){
      pendingAssistantReply = false;
      toggleAssistantThinking(false);
    }
    if (awaitingAssistant){
      pendingAssistantReply = true;
      toggleAssistantThinking(true);
    } else if (!pendingAssistantReply){
      toggleAssistantThinking(false);
    }
    scrollToBottom(true);
  }

  function renderTypingIndicator(users){
    const list = Array.isArray(users) ? users : [];
    if (!list.length){ $typingIndicator.addClass('d-none'); $typingLabel.text(''); return; }
    const names = list.map(p=>p.name||p.username||'').filter(Boolean);
    const label = names.length ? `${names.join(', ')} ${names.length>1?typingPluralText:typingSingleText}` : typingFallbackText;
    $typingLabel.text(label);
    $typingIndicator.removeClass('d-none');
  }

  function notifyTyping(){
    const now = Date.now();
    if (now < typingCooldownUntil) return;
    typingCooldownUntil = now + 2000;
    $.post(typingEndpoint(currentConversationId));
    if (typingResetTimer) clearTimeout(typingResetTimer);
    typingResetTimer = setTimeout(()=>{ typingCooldownUntil = 0; typingResetTimer = null; }, 4000);
  }

  function loadMessages(convoId){
    $.ajax({
      url: urlTpl(urlGetMessagesTpl, convoId),
      data: { _: Date.now() },
      dataType: 'json',
      cache: false
    }).done(resp=>{
      if (resp.success){
        renderMessages(resp.messages);
        renderTypingIndicator(resp.typing_users||[]);
        updateUnreadCount();
      } else {
        renderTypingIndicator([]);
      }
    }).fail(()=>renderTypingIndicator([]));
  }

  function refreshConversations(){
    $.getJSON(urlConversations, resp=>{
      const list = $('.conversation-list');
      const existing = new Set();
      let latestAiId = 0;
      resp.forEach(convo=>{
        existing.add(convo.id);
        let item = list.find(`.conversation-item[data-convo="${convo.id}"]`);
        if (!item.length){
          item = $('<div>').addClass('conversation-item').attr('data-convo', convo.id);
          const header = $('<div>').addClass('d-flex justify-content-between align-items-center conversation-header');
          const titleWrap = $('<div>').addClass('d-flex align-items-center gap-2 flex-grow-1 convo-title').append($('<strong>'));
          const actionsWrap = $('<div>').addClass('d-flex align-items-center gap-2 conv-actions');
          header.append(titleWrap, actionsWrap);
          item.append(header).append($('<div>').addClass('small text-muted text-truncate last-message'));
          list.append(item);
        }
        item.toggleClass('active', convo.id==currentConversationId);
        item.attr('data-ai', convo.is_ai ? 'true' : 'false');
        const convLabel = convo.is_ai ? aiDisplayName : (convo.label || '');
        if (convo.is_ai) latestAiId = convo.id;
        item.find('strong').text(convLabel);
        item.find('.convo-title').toggleClass('pe-0', !convo.can_delete).toggleClass('pe-2', convo.can_delete);
        const actions = item.find('.conv-actions').empty();
        if (convo.unread) actions.append($('<span>').addClass('badge bg-danger unread-badge').text(convo.unread));
        if (convo.can_delete){
          const btn = $('<button>').attr('type','button').addClass('btn btn-sm btn-outline-danger convo-delete').attr('data-convo', convo.id).append($('<i>').addClass('fa fa-trash'));
          actions.append(btn);
        }
        if (convo.last_message && convo.last_message.text) item.find('.last-message').text(convo.last_message.text).removeClass('d-none'); else item.find('.last-message').addClass('d-none');
      });
      list.find('.conversation-item').each(function(){
        const id = Number($(this).data('convo'));
        if (!existing.has(id)) $(this).remove();
      });
      aiConversationId = latestAiId;
    });
  }

  function updateUnreadCount(){
    $.getJSON(urlUnread, resp=>{
      const count = resp.unread||0;
      const badge = $('#collab-nav-badge');
      if (count>0) badge.removeClass('d-none').text(count>99?'99+':count); else badge.addClass('d-none');
    });
  }

  function switchConversation(convoId, label){
    currentConversationId = convoId;
    $conversationId.val(convoId);
    $('.conversation-item').removeClass('active');
    const $item = $(`.conversation-item[data-convo="${convoId}"]`).addClass('active');
    const aiFlag = $item.data('ai');
    currentConversationIsAi = convoId===aiConversationId || aiFlag===true || aiFlag==='true';
    const displayLabel = label || (currentConversationIsAi ? aiDisplayName : txtGeneralChat);
    $('#chatTitle').text(displayLabel);
    const isGeneral = convoId==generalConversationId;
    if (currentConversationIsAi){
      $('#chatSubtitle').text(txtAiSubtitle);
    } else {
      $('#chatSubtitle').text(isGeneral?txtEveryone:txtDirect);
    }
    pendingAssistantReply = false;
    toggleAssistantThinking(false);
    if ($purgeButton.length) $purgeButton.toggleClass('d-none', !isGeneral);
    lastMessagesSignature = null;
    renderTypingIndicator([]);
    if (typingResetTimer){ clearTimeout(typingResetTimer); typingResetTimer=null; }
    typingCooldownUntil = 0;
    loadMessages(convoId);
  }

  $('.conversation-list').on('click','.conversation-item',function(){
    switchConversation($(this).data('convo'), $(this).find('strong').text());
  });

  $('#chatForm').on('submit', function(e){
    e.preventDefault();
    const formData = new FormData(this);
    if (csrfToken && !formData.has('csrf_token')){
      formData.append('csrf_token', csrfToken);
    }
    const att = formData.get('attachment');
    if (!formData.get('body') && !(att && att.name)){ showToast(txtMsgEmpty, 'warning'); return; }
    const textValue = ($('#messageBody').val() || '').trim();
    let localBubble = null;
    if (textValue){
      localBubble = addLocalMessage(textValue);
    }
    const expectsAssistant = textValue && (currentConversationIsAi || includesAiAlias(textValue));
    if (expectsAssistant){
      pendingAssistantReply = true;
      toggleAssistantThinking(true);
    }
    setSending(true);
    $.ajax({
      url: urlTpl(urlPostMessageTpl, currentConversationId),
      method:'POST',
      data: formData,
      processData:false,
      contentType:false
    }).done(resp=>{
      if (resp.success){
        if (localBubble){ localBubble.remove(); localBubble=null; }
        $('#messageBody').val(''); $('#messageAttachment').val(''); $('#attachmentPreview').addClass('d-none').empty();
        if (typingResetTimer){ clearTimeout(typingResetTimer); typingResetTimer=null; }
        typingCooldownUntil=0;
        loadMessages(currentConversationId);
        refreshConversations();
        if (resp.assistant_error){
          pendingAssistantReply = false;
          toggleAssistantThinking(false);
          showToast(resp.assistant_error, 'warning');
        } else if (resp.assistant_invoked){
          pendingAssistantReply = true;
          toggleAssistantThinking(true);
        } else if (pendingAssistantReply){
          pendingAssistantReply = false;
          toggleAssistantThinking(false);
        }
      } else {
        if (localBubble) localBubble.remove();
        showToast(resp.message || txtSendFailed, 'danger');
        pendingAssistantReply = false;
        toggleAssistantThinking(false);
      }
    }).fail(()=>{
      if (localBubble) localBubble.remove();
      pendingAssistantReply = false;
      toggleAssistantThinking(false);
    }).always(()=>setSending(false));
  });

  $('#attachButton').on('click', ()=>$('#messageAttachment').click());
  $('#messageAttachment').on('change', function(){
    const f = this.files[0];
    if (f) $('#attachmentPreview').removeClass('d-none').text(f.name); else $('#attachmentPreview').addClass('d-none').empty();
  });
  $emojiButton.on('click', function(e){
    e.preventDefault();
    const shouldShow = $emojiPicker.hasClass('d-none');
    toggleEmojiPicker(!shouldShow ? false : true);
  });
  $emojiPicker.on('click', '.emoji-option', function(){
    insertEmoji($(this).text());
    toggleEmojiPicker(false);
  });
  $(document).on('click', function(event){
    if (!$emojiPicker.length) return;
    const $target = $(event.target);
    if ($target.closest('#emojiPicker').length || $target.closest('#emojiButton').length) return;
    toggleEmojiPicker(false);
  });
  $('#messageBody').on('input', function(){ if ($(this).val().trim()) notifyTyping(); });
  $('#messageBody').on('keydown', function(e){ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('#chatForm').submit(); } });

  $messages.on('dblclick','.chat-image',function(){
    const src = $(this).data('full') || $(this).attr('src');
    $('#imageModalImg').attr('src', src);
    $('#imageModalDownload').attr('href', src);
    new bootstrap.Modal(document.getElementById('imageModal')).show();
  });

  $('.start-direct').on('click', function(){
    const userId = $(this).data('user');
    $.ajax({
      url: urlDirect,
      method:'POST',
      contentType:'application/json',
      data: JSON.stringify({ user_id: userId })
    }).done(resp=>{
      if (resp.success){
        refreshConversations();
        switchConversation(resp.conversation.id, resp.conversation.label);
      } else {
        showToast(resp.message || txtUnableOpen, 'danger');
      }
    });
  });

  $('.favorite-star').on('click', function(){
    const $star = $(this), userId = $star.data('user');
    $.ajax({ url: urlTpl(urlToggleFavTpl, userId), method:'POST' })
      .done(resp=>{ if (resp.success) $star.toggleClass('favorited', resp.favorited); });
  });

  $('#refreshConvos').on('click', ()=>refreshConversations());
  $('#toggleAutoScroll').on('click', function(){ autoScroll = !autoScroll; $(this).toggleClass('btn-outline-secondary btn-secondary'); });

  if (purgeGeneralUrl){
    $(document).on('click','#purgeGeneralBtn',()=>new bootstrap.Modal(document.getElementById('purgeGeneralModal')).show());
    $(document).on('click','#confirmPurgeGeneral', function(){
      const $btn = $(this).prop('disabled', true);
      $.post(purgeGeneralUrl)
        .done(resp=>{
          if (resp.success){
            showToast(purgeSuccessText, 'success');
            if (currentConversationId===generalConversationId){
              lastMessagesSignature=null;
              renderMessages([]); renderTypingIndicator([]); loadMessages(currentConversationId);
            } else updateUnreadCount();
            refreshConversations();
          } else showToast(resp.message || purgeErrorText, 'danger');
        })
        .fail(()=>showToast(purgeErrorText,'danger'))
        .always(()=>{
          $btn.prop('disabled', false);
          const modal = bootstrap.Modal.getInstance(document.getElementById('purgeGeneralModal'));
          if (modal) modal.hide();
        });
    });
  }

  $('.conversation-list').on('click', '.convo-delete, .convo-delete *', function(e){
    e.preventDefault(); e.stopPropagation();
    pendingDeleteId = $(this).closest('.convo-delete').data('convo');
    new bootstrap.Modal(document.getElementById('deleteConvoModal')).show();
  });

  $(document).on('click','#confirmDeleteConvo', function(){
    if (!pendingDeleteId) return;
    $.post(urlTpl(urlDeleteConvoTpl, pendingDeleteId))
      .done(resp=>{
        if (resp.success){
          if (pendingDeleteId==currentConversationId) switchConversation(generalConversationId, txtGeneralChat);
          refreshConversations();
        } else showToast(resp.message || txtUnableDelete, 'danger');
      })
      .fail(()=>showToast(txtUnableDelete,'danger'))
      .always(()=>{
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConvoModal'));
        if (modal) modal.hide();
        pendingDeleteId = null;
      });
  });

  function startPolling(){
    loadMessages(currentConversationId); refreshConversations(); updateUnreadCount();
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(()=>{ loadMessages(currentConversationId); refreshConversations(); updateUnreadCount(); }, 8000);
  }

  switchConversation(currentConversationId, $('.conversation-item.active strong').text() || null);
  startPolling();
})();
</script>

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark">
      <div class="modal-header border-0">
        <h5 class="modal-title text-white"><i class="fa fa-image"></i> {{ _('Preview') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" alt="preview" class="img-fluid rounded shadow" id="imageModalImg">
        <div class="mt-3">
          <a href="" download class="btn btn-outline-light" id="imageModalDownload"><i class="fa fa-download"></i> {{ _('Download') }}</a>
        </div>
      </div>
    </div>
  </div>
</div>

{% if current_user.role == 'admin' %}
<div class="modal fade" id="purgeGeneralModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa fa-broom text-danger"></i> {{ _('Purge General Chat') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {{ _('This will permanently delete all messages in the General chat for everyone. This action cannot be undone.') }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirmPurgeGeneral">{{ _('Purge') }}</button>
      </div>
    </div>
  </div>
    </div>
  </div>
</div>
{% endif %}

<div class="modal fade" id="deleteConvoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa fa-trash text-danger"></i> {{ _('Delete Conversation') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {{ _('Are you sure you want to delete this conversation? This action cannot be undone.') }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteConvo">{{ _('Delete') }}</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
