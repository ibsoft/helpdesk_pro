{% extends "base.html" %}
{% block content %}

<style>
  .chat-container{display:flex;flex-direction:column;flex:1 1 auto;min-height:0;height:100%}
  .chat-messages{flex:1;overflow-y:auto;padding:1rem;background:rgba(15,23,42,.02);border-radius:.75rem;display:flex;flex-direction:column}
  html[data-bs-theme="dark"] body .chat-messages{background:rgba(15,23,42,.4)}
  .chat-bubble{display:inline-flex;flex-direction:column;align-items:flex-start;padding:.75rem 1rem;border-radius:1rem;margin-bottom:.75rem;position:relative;width:fit-content;max-width:min(80%,520px);min-width:3.25rem;gap:.5rem;word-break:break-word;overflow-wrap:anywhere}
  .chat-bubble.me{margin-left:auto;background:linear-gradient(135deg,#0ea5e9,#2563eb);color:#fff}
  .chat-bubble.them{margin-right:auto;background:linear-gradient(135deg,#f1f5f9,#e2e8f0);color:#1e293b}
  html[data-bs-theme="dark"] body .chat-bubble.them{background:linear-gradient(135deg,rgba(30,41,59,.95),rgba(51,65,85,.95));color:#e2e8f0}
  .chat-meta{font-size:.75rem;opacity:.7;margin-top:.35rem}
  .conversation-item{cursor:pointer;border-radius:.75rem;padding:.75rem;transition:background .2s ease}
  .conversation-item.active{background:linear-gradient(135deg,#0d6efd,#6610f2);color:#1f1f28}
  .conversation-item:hover{background:rgba(13,110,253,.1)}
  html[data-bs-theme="dark"] body .conversation-item:hover{background:rgba(59,130,246,.2)}
  .favorite-star{cursor:pointer;transition:transform .2s ease}
  .favorite-star.favorited{color:#f59e0b}
  .favorite-star:hover{transform:scale(1.1)}
  .message-attachment{margin-top:.5rem;display:inline-flex;align-items:center;gap:.35rem;padding:.4rem .6rem;background:rgba(255,255,255,.2);border-radius:.6rem}
  html[data-bs-theme="dark"] body .message-attachment{background:rgba(15,23,42,.45)}
  .chat-users-list{flex:1 1 auto;overflow-y:auto;min-height:0}
  .collab-page{display:flex;flex-direction:column;gap:1rem;min-height:calc(100vh - 130px);height:calc(100vh - 130px)}
  .collab-grid{flex:1 1 auto;display:flex;min-height:0}
  .collab-grid .row{flex:1 1 auto;display:flex;flex-wrap:nowrap;min-height:0}
  .collab-grid .row>[class*="col-"]{display:flex;flex-direction:column;min-height:0}
  .collab-grid .card{flex:1 1 auto;display:flex;flex-direction:column;min-height:0}
  .conversation-list{flex:1 1 auto;overflow-y:auto;min-height:0}
  @media (max-width: 991.98px){
    .collab-page{min-height:auto;height:auto}
    .collab-grid{flex-direction:column}
    .collab-grid .row{flex-wrap:wrap}
    .collab-grid .row>[class*="col-"]{min-height:auto}
    .collab-grid .card{min-height:auto}
    .conversation-list,.chat-users-list{max-height:360px}
  }
  .typing-indicator{display:flex;align-items:center;gap:.5rem;font-size:.85rem;color:rgba(15,23,42,.75)}
  html[data-bs-theme="dark"] body .typing-indicator{color:rgba(226,232,240,.8)}
  .typing-dots{display:inline-flex;align-items:center;gap:.3rem}
  .typing-dots span{width:6px;height:6px;border-radius:50%;background-color:currentColor;opacity:.35;animation:typingBounce 1.2s infinite ease-in-out}
  .typing-dots span:nth-child(2){animation-delay:.2s}
  .typing-dots span:nth-child(3){animation-delay:.4s}
  @keyframes typingBounce{0%,60%,100%{transform:translateY(0);opacity:.35}30%{transform:translateY(-4px);opacity:.9}}
  .chat-youtube iframe{border:0;border-radius:.85rem;width:100%;height:100%}
  .chat-youtube{width:260px;max-width:min(90vw,480px)}
  .collab-summary-card{border-radius:.9rem;border:1px solid rgba(148,163,184,.25);background:linear-gradient(135deg,rgba(248,250,252,.95) 0%,rgba(219,234,254,.9) 55%,rgba(224,231,255,.88) 100%);color:#0f172a}
  html[data-bs-theme="dark"] body .collab-summary-card{background:linear-gradient(135deg,rgba(15,23,42,.82) 0%,rgba(17,24,39,.78) 55%,rgba(30,41,59,.74) 100%);border-color:rgba(148,163,184,.35);color:#e2e8f0;backdrop-filter:blur(12px)}
  .collab-summary-card .collab-metric{display:flex;align-items:center;gap:.75rem;text-align:center}
  .collab-summary-card .collab-metric-count{display:inline-flex;align-items:center;gap:.5rem;padding:.4rem 1rem;border-radius:999px;font-weight:600;font-size:.95rem;box-shadow:inset 0 0 0 1px rgba(15,23,42,.08)}
  html[data-bs-theme="dark"] body .collab-summary-card .collab-metric-count{box-shadow:inset 0 0 0 1px rgba(226,232,240,.15)}
  .collab-summary-card .collab-metric-label{text-transform:uppercase;font-size:.68rem;letter-spacing:.08em;opacity:.75;white-space:nowrap}
  html[data-bs-theme="dark"] body .collab-summary-card .collab-metric-label{opacity:.85}
  .collab-summary-card .collab-divider{width:1px;height:36px;background:rgba(148,163,184,.36)}
  @media (max-width: 767px){.collab-summary-card .collab-divider{display:none}}
</style>

{% set stats = collab_stats %}
<div class="collab-page" id="collabRoot"
  data-general-id="{{ general_conversation.id }}"
  data-typing-endpoint-tpl="{{ url_for('collab.api_conversation_typing', conversation_id=0) }}"
  data-get-messages-url-tpl="{{ url_for('collab.api_get_messages', conversation_id=0) }}"
  data-post-message-url-tpl="{{ url_for('collab.api_post_message', conversation_id=0) }}"
  data-conversations-url="{{ url_for('collab.api_conversations') }}"
  data-unread-url="{{ url_for('collab.api_unread_count') }}"
  data-direct-url="{{ url_for('collab.api_direct_conversation') }}"
  data-toggle-fav-url-tpl="{{ url_for('collab.api_toggle_favorite', target_id=0) }}"
  data-delete-convo-url-tpl="{{ url_for('collab.api_delete_conversation', conversation_id=0) }}"
  {% if current_user.role == 'admin' %}data-purge-url="{{ url_for('collab.api_purge_conversation', conversation_id=general_conversation.id) }}"{% endif %}
  data-text-is-typing="{{ _('is typing') }}"
  data-text-are-typing="{{ _('are typing') }}"
  data-text-someone-typing="{{ _('Someone is typing') }}"
  data-text-message-empty="{{ _('Message cannot be empty.') }}"
  data-text-send-failed="{{ _('Send failed') }}"
  data-text-unable-open="{{ _('Unable to open conversation') }}"
  data-text-general-cleared="{{ _('General chat cleared.') }}"
  data-text-unable-purge="{{ _('Unable to purge general chat.') }}"
  data-text-unable-delete="{{ _('Unable to delete conversation') }}"
  data-text-general-chat="{{ _('General Chat') }}"
  data-text-everyone="{{ _('Everyone in the organization') }}"
  data-text-direct="{{ _('Direct conversation') }}"
  data-csrf-token="{{ csrf_token() }}"
>
  <div class="card collab-summary-card border-0 shadow-sm">
    <div class="card-body py-3">
      <div class="d-flex flex-wrap align-items-center justify-content-left gap-4">
        <div class="collab-metric">
          <span class="collab-metric-count bg-primary-subtle text-primary-emphasis">
            <i class="fa fa-comments"></i> {{ stats.total }}
          </span>
          <span class="collab-metric-label">{{ _('Total Conversations') }}</span>
        </div>
        <div class="collab-divider d-none d-md-block"></div>
        <div class="collab-metric">
          <span class="collab-metric-count bg-success-subtle text-success-emphasis">
            <i class="fa fa-user"></i> {{ stats.direct }}
          </span>
          <span class="collab-metric-label">{{ _('Direct Messages') }}</span>
        </div>
        <div class="collab-metric">
          <span class="collab-metric-count bg-info-subtle text-info-emphasis">
            <i class="fa fa-users"></i> {{ stats.channels }}
          </span>
          <span class="collab-metric-label">{{ _('Team Channels') }}</span>
        </div>
        <div class="collab-metric">
          <span class="collab-metric-count bg-warning-subtle text-warning-emphasis">
            <i class="fa fa-bell"></i> {{ stats.unread }}
          </span>
          <span class="collab-metric-label">{{ _('Unread') }}</span>
        </div>
        <div class="collab-metric">
          <span class="collab-metric-count bg-secondary-subtle text-secondary-emphasis">
            <i class="fa fa-calendar"></i> {{ stats.today }}
          </span>
          <span class="collab-metric-label">{{ _('Messages Today') }}</span>
        </div>
        <div class="collab-metric">
          <span class="collab-metric-count bg-danger-subtle text-danger-emphasis">
            <i class="fa fa-star"></i> {{ stats.favorites }}
          </span>
          <span class="collab-metric-label">{{ _('Favorites') }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="collab-grid">
    <div class="row g-3 flex-grow-1">
      <div class="col-lg-2 col-md-3">
        <div class="card shadow-sm h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fa fa-comments"></i> {{ _('Conversations') }}</span>
            <button class="btn btn-sm btn-outline-primary" id="refreshConvos"><i class="fa fa-rotate"></i></button>
          </div>
          <div class="card-body conversation-list flex-grow-1">
            {% for convo in conversations %}
              <div class="conversation-item {% if convo.id == general_conversation.id %}active{% endif %}" data-convo="{{ convo.id }}">
                <div class="d-flex justify-content-between align-items-center conversation-header">
                  <strong>{{ convo.label }}</strong>
                  <div class="d-flex align-items-center gap-2 conv-actions">
                    {% if convo.unread %}
                      <span class="badge bg-danger unread-badge">{{ convo.unread }}</span>
                    {% endif %}
                    {% if convo.can_delete %}
                      <button type="button" class="btn btn-sm btn-outline-danger convo-delete" data-convo="{{ convo.id }}"><i class="fa fa-trash"></i></button>
                    {% endif %}
                  </div>
                </div>
                {% if convo.last_message.text %}
                  <div class="small text-muted text-truncate">{{ convo.last_message.text }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-lg-8 col-md-6">
        <div class="card shadow-sm chat-container">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0" id="chatTitle">{{ _('General Chat') }}</h6>
              <small class="text-muted" id="chatSubtitle">{{ _('Everyone in the organization') }}</small>
            </div>
            <div class="d-flex gap-2">
              {% if current_user.role == 'admin' %}
                <button class="btn btn-sm btn-outline-danger d-none" id="purgeGeneralBtn" data-convo="{{ general_conversation.id }}" title="{{ _('Purge General Chat') }}">
                  <i class="fa fa-broom"></i>
                </button>
              {% endif %}
              <button class="btn btn-sm btn-outline-secondary" id="toggleAutoScroll"><i class="fa fa-arrows-down-to-line"></i></button>
            </div>
          </div>
          <div class="chat-messages" id="chatMessages" data-conversation="{{ general_conversation.id }}">
            <div class="text-center text-muted mt-5" id="messagesPlaceholder">
              <i class="fa fa-comments fa-2x"></i>
              <p>{{ _('Select or start a conversation to view messages.') }}</p>
            </div>
          </div>
          <div class="card-footer">
            <div class="typing-indicator d-none mb-2" id="typingIndicator">
              <span id="typingLabel"></span>
              <span class="typing-dots" aria-hidden="true">
                <span></span><span></span><span></span>
              </span>
            </div>
            <form id="chatForm" enctype="multipart/form-data">
              <div class="input-group">
                <input type="hidden" name="conversation_id" id="conversationId" value="{{ general_conversation.id }}">
                <textarea class="form-control" name="body" id="messageBody" rows="1" placeholder="{{ _('Type your message...') }}"></textarea>
                <button class="btn btn-outline-secondary" type="button" id="attachButton"><i class="fa fa-paperclip"></i></button>
                <input type="file" class="d-none" id="messageAttachment" name="attachment">
                <button class="btn btn-primary" type="submit"><i class="fa fa-paper-plane"></i></button>
              </div>
              <div id="attachmentPreview" class="small text-muted mt-1 d-none"></div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-2 col-md-3">
        <div class="card shadow-sm h-100">
          <div class="card-header"><i class="fa fa-users"></i> {{ _('People') }}</div>
          <div class="card-body chat-users-list flex-grow-1">
            {% for user in users %}
              <div class="d-flex justify-content-between align-items-center border-bottom py-2 user-entry" data-user="{{ user.id }}">
                <div>
                  <strong>{{ user.username }}</strong>
                  {% if user.role %}<div class="small text-muted">{{ _(user.role|capitalize) }}</div>{% endif %}
                </div>
                <div class="d-flex align-items-center gap-2">
                  <i class="fa fa-star favorite-star {% if user.id in favorites %}favorited{% endif %}" data-user="{{ user.id }}"></i>
                  <button class="btn btn-sm btn-outline-primary start-direct" data-user="{{ user.id }}"><i class="fa fa-comments"></i></button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(function () {
  const root = document.getElementById('collabRoot');
  const D = root.dataset;
  const parseIntSafe = (v, def=0) => { const n = parseInt(v,10); return Number.isFinite(n) ? n : def; };
  const csrfToken = D.csrfToken || (document.querySelector('input[name="csrf_token"]') || {}).value || '';

  $.ajaxSetup({
    beforeSend: function(xhr, settings){
      if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && csrfToken){
        xhr.setRequestHeader('X-CSRFToken', csrfToken);
      }
    }
  });

  let currentConversationId = parseIntSafe(D.generalId);
  let autoScroll = true;
  let pollingInterval = null;
  let pendingDeleteId = null;
  let lastMessagesSignature = null;
  let typingCooldownUntil = 0;
  let typingResetTimer = null;

  const $messages = $('#chatMessages');
  const $conversationId = $('#conversationId');
  const $placeholder = $('#messagesPlaceholder');
  const $typingIndicator = $('#typingIndicator');
  const $typingLabel = $('#typingLabel');
  const $purgeButton = $('#purgeGeneralBtn');

  const generalConversationId = parseIntSafe(D.generalId);
  const typingEndpointTemplate = D.typingEndpointTpl || '';
  const urlGetMessagesTpl = D.getMessagesUrlTpl || '';
  const urlPostMessageTpl = D.postMessageUrlTpl || '';
  const urlConversations = D.conversationsUrl || '';
  const urlUnread = D.unreadUrl || '';
  const urlDirect = D.directUrl || '';
  const urlToggleFavTpl = D.toggleFavUrlTpl || '';
  const urlDeleteConvoTpl = D.deleteConvoUrlTpl || '';
  const purgeGeneralUrl = D.purgeUrl || null;

  const typingSingleText = D.textIsTyping || 'is typing';
  const typingPluralText = D.textAreTyping || 'are typing';
  const typingFallbackText = D.textSomeoneTyping || 'Someone is typing';
  const purgeSuccessText = D.textGeneralCleared || 'General chat cleared.';
  const purgeErrorText = D.textUnablePurge || 'Unable to purge general chat.';
  const txtMsgEmpty = D.textMessageEmpty || 'Message cannot be empty.';
  const txtSendFailed = D.textSendFailed || 'Send failed';
  const txtUnableOpen = D.textUnableOpen || 'Unable to open conversation';
  const txtUnableDelete = D.textUnableDelete || 'Unable to delete conversation';
  const txtGeneralChat = D.textGeneralChat || 'General Chat';
  const txtEveryone = D.textEveryone || 'Everyone in the organization';
  const txtDirect = D.textDirect || 'Direct conversation';

  const urlTpl = (tpl, id) => (tpl || '').replace('0', String(id));

  function scrollToBottom(force=false){
    if (autoScroll || force) $messages.stop().animate({ scrollTop: $messages[0].scrollHeight }, 400);
  }
  const typingEndpoint = (convoId) => urlTpl(typingEndpointTemplate, convoId);

  function createYoutubeEmbed(youtubeId, url){
    if (!youtubeId) return null;
    const embedUrl = `https://www.youtube.com/embed/${youtubeId}`;
    const iframe = $('<iframe>', {
      src: embedUrl,
      allow: 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share',
      allowfullscreen: true,
      loading: 'lazy',
      title: 'YouTube video player',
    });
    if (url) iframe.attr('data-source', url);
    return $('<div>').addClass('ratio ratio-16x9 chat-youtube mt-2').append(iframe);
  }

  function renderAttachment(container, attachment){
    if (!attachment) return;
    if (attachment.is_image){
      const img = $('<img>').addClass('img-fluid rounded chat-image').attr('src', attachment.url).attr('alt', attachment.original).attr('data-full', attachment.url);
      container.append($('<div class="mt-2">').append(img));
      return;
    }
    if (attachment.youtube_id){
      const embed = createYoutubeEmbed(attachment.youtube_id, attachment.url);
      if (embed) { container.append(embed); return; }
    }
    if (attachment.youtube_thumb){
      const link = $('<a>').attr('href', attachment.url).attr('target', '_blank').addClass('d-inline-block mt-2');
      link.append($('<img>').addClass('img-fluid rounded').attr('src', attachment.youtube_thumb).attr('alt', attachment.original));
      container.append(link);
    } else {
      const link = $('<a>').attr('href', attachment.url).attr('target', '_blank').addClass('message-attachment mt-2');
      link.html('<i class="fa fa-paperclip"></i> ' + attachment.original);
      container.append(link);
    }
  }

  function extractYoutube(text){
    if (!text) return null;
    const m = text.match(/https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/);
    return m ? { id: m[1], url: m[0], thumb: `https://img.youtube.com/vi/${m[1]}/hqdefault.jpg` } : null;
  }

  function linkify(text){
    if (!text) return '';
    return text.replace(/(https?:\/\/[\w\-._~:\/?#[\]@!$&'()*+,;=%]+)/g,'<a href="$1" target="_blank">$1</a>').replace(/\n/g,'<br>');
  }

  function renderMessages(messages){
    const signature = messages.length ? messages.map(m=>m.id).join('|') : 'empty';
    if (signature === lastMessagesSignature) return;
    lastMessagesSignature = signature;

    if (!messages.length){
      $messages.find('.chat-bubble').remove();
      $placeholder.removeClass('d-none');
      return;
    }

    $placeholder.addClass('d-none');
    const frag = $(document.createDocumentFragment());
    messages.forEach(msg=>{
      const bubble = $('<div>').addClass('chat-bubble').addClass(msg.isMine ? 'me' : 'them');
      let yt = null;
      if (msg.body){
        bubble.append($('<div>').addClass('chat-body').html(linkify(msg.body)));
        yt = extractYoutube(msg.body);
      }
      renderAttachment(bubble, msg.attachment);
      if (!msg.attachment && yt){
        const embed = createYoutubeEmbed(yt.id, yt.url);
        if (embed) bubble.append(embed);
      }
      bubble.append($('<div>').addClass('chat-meta').text(`${msg.sender_name} â€¢ ${new Date(msg.created_at).toLocaleString()}`));
      frag.append(bubble);
    });
    $messages.find('.chat-bubble').remove();
    $messages.append(frag);
    scrollToBottom(true);
  }

  function renderTypingIndicator(users){
    const list = Array.isArray(users) ? users : [];
    if (!list.length){ $typingIndicator.addClass('d-none'); $typingLabel.text(''); return; }
    const names = list.map(p=>p.name||p.username||'').filter(Boolean);
    const label = names.length ? `${names.join(', ')} ${names.length>1?typingPluralText:typingSingleText}` : typingFallbackText;
    $typingLabel.text(label);
    $typingIndicator.removeClass('d-none');
  }

  function notifyTyping(){
    const now = Date.now();
    if (now < typingCooldownUntil) return;
    typingCooldownUntil = now + 2000;
    $.post(typingEndpoint(currentConversationId));
    if (typingResetTimer) clearTimeout(typingResetTimer);
    typingResetTimer = setTimeout(()=>{ typingCooldownUntil = 0; typingResetTimer = null; }, 4000);
  }

  function loadMessages(convoId){
    $.ajax({
      url: urlTpl(urlGetMessagesTpl, convoId),
      data: { _: Date.now() },
      dataType: 'json',
      cache: false
    }).done(resp=>{
      if (resp.success){
        renderMessages(resp.messages);
        renderTypingIndicator(resp.typing_users||[]);
        updateUnreadCount();
      } else {
        renderTypingIndicator([]);
      }
    }).fail(()=>renderTypingIndicator([]));
  }

  function refreshConversations(){
    $.getJSON(urlConversations, resp=>{
      const list = $('.conversation-list');
      const existing = new Set();
      resp.forEach(convo=>{
        existing.add(convo.id);
        let item = list.find(`.conversation-item[data-convo="${convo.id}"]`);
        if (!item.length){
          item = $('<div>').addClass('conversation-item').attr('data-convo', convo.id);
          const header = $('<div>').addClass('d-flex justify-content-between align-items-center conversation-header');
          const titleWrap = $('<div>').addClass('d-flex align-items-center gap-2 flex-grow-1 convo-title').append($('<strong>'));
          const actionsWrap = $('<div>').addClass('d-flex align-items-center gap-2 conv-actions');
          header.append(titleWrap, actionsWrap);
          item.append(header).append($('<div>').addClass('small text-muted text-truncate last-message'));
          list.append(item);
        }
        item.toggleClass('active', convo.id==currentConversationId);
        item.find('strong').text(convo.label);
        item.find('.convo-title').toggleClass('pe-0', !convo.can_delete).toggleClass('pe-2', convo.can_delete);
        const actions = item.find('.conv-actions').empty();
        if (convo.unread) actions.append($('<span>').addClass('badge bg-danger unread-badge').text(convo.unread));
        if (convo.can_delete){
          const btn = $('<button>').attr('type','button').addClass('btn btn-sm btn-outline-danger convo-delete').attr('data-convo', convo.id).append($('<i>').addClass('fa fa-trash'));
          actions.append(btn);
        }
        if (convo.last_message && convo.last_message.text) item.find('.last-message').text(convo.last_message.text).removeClass('d-none'); else item.find('.last-message').addClass('d-none');
      });
      list.find('.conversation-item').each(function(){
        const id = Number($(this).data('convo'));
        if (!existing.has(id)) $(this).remove();
      });
    });
  }

  function updateUnreadCount(){
    $.getJSON(urlUnread, resp=>{
      const count = resp.unread||0;
      const badge = $('#collab-nav-badge');
      if (count>0) badge.removeClass('d-none').text(count>99?'99+':count); else badge.addClass('d-none');
    });
  }

  function switchConversation(convoId, label){
    currentConversationId = convoId;
    $conversationId.val(convoId);
    $('.conversation-item').removeClass('active');
    $(`.conversation-item[data-convo="${convoId}"]`).addClass('active');
    $('#chatTitle').text(label||txtGeneralChat);
    const isGeneral = convoId==generalConversationId;
    $('#chatSubtitle').text(isGeneral?txtEveryone:txtDirect);
    if ($purgeButton.length) $purgeButton.toggleClass('d-none', !isGeneral);
    lastMessagesSignature = null;
    renderTypingIndicator([]);
    if (typingResetTimer){ clearTimeout(typingResetTimer); typingResetTimer=null; }
    typingCooldownUntil = 0;
    loadMessages(convoId);
  }

  $('.conversation-list').on('click','.conversation-item',function(){
    switchConversation($(this).data('convo'), $(this).find('strong').text());
  });

  $('#chatForm').on('submit', function(e){
    e.preventDefault();
    const formData = new FormData(this);
    if (csrfToken && !formData.has('csrf_token')){
      formData.append('csrf_token', csrfToken);
    }
    const att = formData.get('attachment');
    if (!formData.get('body') && !(att && att.name)){ showToast(txtMsgEmpty, 'warning'); return; }
    $.ajax({
      url: urlTpl(urlPostMessageTpl, currentConversationId),
      method:'POST',
      data: formData,
      processData:false,
      contentType:false
    }).done(resp=>{
      if (resp.success){
        $('#messageBody').val(''); $('#messageAttachment').val(''); $('#attachmentPreview').addClass('d-none').empty();
        if (typingResetTimer){ clearTimeout(typingResetTimer); typingResetTimer=null; }
        typingCooldownUntil=0;
        loadMessages(currentConversationId);
        refreshConversations();
      } else {
        showToast(resp.message || txtSendFailed, 'danger');
      }
    });
  });

  $('#attachButton').on('click', ()=>$('#messageAttachment').click());
  $('#messageAttachment').on('change', function(){
    const f = this.files[0];
    if (f) $('#attachmentPreview').removeClass('d-none').text(f.name); else $('#attachmentPreview').addClass('d-none').empty();
  });

  $('#messageBody').on('input', function(){ if ($(this).val().trim()) notifyTyping(); });
  $('#messageBody').on('keydown', function(e){ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('#chatForm').submit(); } });

  $messages.on('dblclick','.chat-image',function(){
    const src = $(this).data('full') || $(this).attr('src');
    $('#imageModalImg').attr('src', src);
    $('#imageModalDownload').attr('href', src);
    new bootstrap.Modal(document.getElementById('imageModal')).show();
  });

  $('.start-direct').on('click', function(){
    const userId = $(this).data('user');
    $.ajax({
      url: urlDirect,
      method:'POST',
      contentType:'application/json',
      data: JSON.stringify({ user_id: userId })
    }).done(resp=>{
      if (resp.success){
        refreshConversations();
        switchConversation(resp.conversation.id, resp.conversation.label);
      } else {
        showToast(resp.message || txtUnableOpen, 'danger');
      }
    });
  });

  $('.favorite-star').on('click', function(){
    const $star = $(this), userId = $star.data('user');
    $.ajax({ url: urlTpl(urlToggleFavTpl, userId), method:'POST' })
      .done(resp=>{ if (resp.success) $star.toggleClass('favorited', resp.favorited); });
  });

  $('#refreshConvos').on('click', ()=>refreshConversations());
  $('#toggleAutoScroll').on('click', function(){ autoScroll = !autoScroll; $(this).toggleClass('btn-outline-secondary btn-secondary'); });

  if (purgeGeneralUrl){
    $(document).on('click','#purgeGeneralBtn',()=>new bootstrap.Modal(document.getElementById('purgeGeneralModal')).show());
    $(document).on('click','#confirmPurgeGeneral', function(){
      const $btn = $(this).prop('disabled', true);
      $.post(purgeGeneralUrl)
        .done(resp=>{
          if (resp.success){
            showToast(purgeSuccessText, 'success');
            if (currentConversationId===generalConversationId){
              lastMessagesSignature=null;
              renderMessages([]); renderTypingIndicator([]); loadMessages(currentConversationId);
            } else updateUnreadCount();
            refreshConversations();
          } else showToast(resp.message || purgeErrorText, 'danger');
        })
        .fail(()=>showToast(purgeErrorText,'danger'))
        .always(()=>{
          $btn.prop('disabled', false);
          const modal = bootstrap.Modal.getInstance(document.getElementById('purgeGeneralModal'));
          if (modal) modal.hide();
        });
    });
  }

  $('.conversation-list').on('click', '.convo-delete, .convo-delete *', function(e){
    e.preventDefault(); e.stopPropagation();
    pendingDeleteId = $(this).closest('.convo-delete').data('convo');
    new bootstrap.Modal(document.getElementById('deleteConvoModal')).show();
  });

  $(document).on('click','#confirmDeleteConvo', function(){
    if (!pendingDeleteId) return;
    $.post(urlTpl(urlDeleteConvoTpl, pendingDeleteId))
      .done(resp=>{
        if (resp.success){
          if (pendingDeleteId==currentConversationId) switchConversation(generalConversationId, txtGeneralChat);
          refreshConversations();
        } else showToast(resp.message || txtUnableDelete, 'danger');
      })
      .fail(()=>showToast(txtUnableDelete,'danger'))
      .always(()=>{
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConvoModal'));
        if (modal) modal.hide();
        pendingDeleteId = null;
      });
  });

  function startPolling(){
    loadMessages(currentConversationId); refreshConversations(); updateUnreadCount();
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(()=>{ loadMessages(currentConversationId); refreshConversations(); updateUnreadCount(); }, 8000);
  }

  switchConversation(currentConversationId, $('.conversation-item.active strong').text() || null);
  startPolling();
})();
</script>

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark">
      <div class="modal-header border-0">
        <h5 class="modal-title text-white"><i class="fa fa-image"></i> {{ _('Preview') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" alt="preview" class="img-fluid rounded shadow" id="imageModalImg">
        <div class="mt-3">
          <a href="" download class="btn btn-outline-light" id="imageModalDownload"><i class="fa fa-download"></i> {{ _('Download') }}</a>
        </div>
      </div>
    </div>
  </div>
</div>

{% if current_user.role == 'admin' %}
<div class="modal fade" id="purgeGeneralModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa fa-broom text-danger"></i> {{ _('Purge General Chat') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {{ _('This will permanently delete all messages in the General chat for everyone. This action cannot be undone.') }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirmPurgeGeneral">{{ _('Purge') }}</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="modal fade" id="deleteConvoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa fa-trash text-danger"></i> {{ _('Delete Conversation') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {{ _('Are you sure you want to delete this conversation? This action cannot be undone.') }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteConvo">{{ _('Delete') }}</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
