{% extends "base.html" %}
{% block content %}

<style>
  .modal-header-gradient {
    background: linear-gradient(135deg, #111827 0%, #0d6efd 60%, #6610f2 100%);
    border-bottom: none;
  }
  .modal-header-gradient .modal-title {
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .modal-header-gradient .btn-close {
    filter: invert(1);
  }

  .status-summary-card {
    border: 1px solid transparent;
    border-radius: 0.85rem;
    transition: background 0.35s ease, color 0.35s ease, border-color 0.35s ease;
    overflow: hidden;
  }
  body[data-bs-theme="light"] .status-summary-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.92) 0%, rgba(248, 250, 252, 0.9) 50%, rgba(226, 232, 240, 0.85) 100%);
    color: #1e293b;
    border-color: rgba(148, 163, 184, 0.25);
    --status-divider-color: rgba(148, 163, 184, 0.35);
    --status-label-color: rgba(71, 85, 105, 0.75);
    --status-total-bg: rgba(13, 110, 253, 0.18);
    --status-total-fg: #0d47a1;
    --status-open-bg: rgba(16, 185, 129, 0.18);
    --status-open-fg: #047857;
    --status-progress-bg: rgba(245, 158, 11, 0.2);
    --status-progress-fg: #b45309;
    --status-closed-bg: rgba(100, 116, 139, 0.22);
    --status-closed-fg: #374151;
  }
  body[data-bs-theme="dark"] .status-summary-card {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.75) 0%, rgba(17, 24, 39, 0.72) 50%, rgba(30, 41, 59, 0.68) 100%);
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.28);
    backdrop-filter: blur(12px);
    --status-divider-color: rgba(148, 163, 184, 0.35);
    --status-label-color: rgba(203, 213, 225, 0.75);
    --status-total-bg: rgba(59, 130, 246, 0.28);
    --status-total-fg: #dbeafe;
    --status-open-bg: rgba(34, 197, 94, 0.28);
    --status-open-fg: #bbf7d0;
    --status-progress-bg: rgba(251, 191, 36, 0.34);
    --status-progress-fg: #fef3c7;
    --status-closed-bg: rgba(148, 163, 184, 0.35);
    --status-closed-fg: #e2e8f0;
  }
  .status-summary-card .status-divider {
    width: 1px;
    height: 32px;
    background: var(--status-divider-color);
    transition: background 0.35s ease;
  }
  .status-summary-card .status-block {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .status-summary-card .status-count {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.85rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.85rem;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
    transition: background 0.35s ease, color 0.35s ease;
  }
  .status-summary-card .status-label {
    text-transform: uppercase;
    font-size: 0.65rem;
    letter-spacing: 0.08em;
    font-weight: 600;
    color: var(--status-label-color);
    transition: color 0.35s ease;
  }
  .status-summary-card .status-count i {
    font-size: 0.85rem;
  }
  .status-summary-card .status-count.total {
    background: var(--status-total-bg);
    color: var(--status-total-fg);
  }
  .status-summary-card .status-count.open {
    background: var(--status-open-bg);
    color: var(--status-open-fg);
  }
  .status-summary-card .status-count.progress {
    background: var(--status-progress-bg);
    color: var(--status-progress-fg);
  }
  .status-summary-card .status-count.closed {
    background: var(--status-closed-bg);
    color: var(--status-closed-fg);
  }
  @media (max-width: 767px) {
    .status-summary-card .status-divider {
      display: none;
    }
  }

  .dt-searchBuilder {
    background: rgba(15, 23, 42, 0.02);
    border-radius: 0.85rem;
    padding: 1rem 1.25rem;
    border: 1px solid rgba(148, 163, 184, 0.2);
  }
  body[data-bs-theme="dark"] .dt-searchBuilder {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(148, 163, 184, 0.35);
  }
  .dt-searchBuilder button.btn {
    border-radius: 0.5rem;
    color: #0f172a;
  }
  body[data-bs-theme="dark"] .dt-searchBuilder button.btn,
  body[data-bs-theme="light"] .dt-searchBuilder .btn-outline-secondary,
  body[data-bs-theme="light"] .dt-searchBuilder .btn-outline-primary,
  body[data-bs-theme="light"] .dt-searchBuilder .btn-outline-info {
    color: #f8fafc;
  }
  .dt-searchBuilder .dtsb-titleRow {
    margin-bottom: 0.75rem;
  }
  .dt-searchBuilder .dtsb-title {
    font-weight: 600;
    letter-spacing: 0.04em;
  }
</style>

{% set total_tickets = tickets|length %}
{% set open_count = tickets|selectattr('status', 'equalto', 'Open')|list|length %}
{% set progress_count = tickets|selectattr('status', 'equalto', 'In Progress')|list|length %}
{% set closed_count = tickets|selectattr('status', 'equalto', 'Closed')|list|length %}

<div class="card status-summary-card border-0 shadow-sm mb-3">
  <div class="card-body py-3">
    <div class="d-flex flex-wrap align-items-center gap-4">
      <div class="status-block">
        <span class="status-count total">
          <i class="fa fa-layer-group"></i>{{ total_tickets }}
        </span>
        <span class="status-label">{{ _('Total Tickets') }}</span>
      </div>
      <div class="status-divider d-none d-md-block"></div>
      <div class="status-block">
        <span class="status-count open">
          <i class="fa fa-door-open"></i>{{ open_count }}
        </span>
        <span class="status-label">{{ _('Open') }}</span>
      </div>
      <div class="status-block">
        <span class="status-count progress">
          <i class="fa fa-spinner"></i>{{ progress_count }}
        </span>
        <span class="status-label">{{ _('In Progress') }}</span>
      </div>
      <div class="status-block">
        <span class="status-count closed">
          <i class="fa fa-check"></i>{{ closed_count }}
        </span>
        <span class="status-label">{{ _('Closed') }}</span>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4><i class="fa fa-ticket-alt"></i> {{ _('Tickets') }}</h4>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
    <i class="fa fa-plus"></i> {{ _('New Ticket') }}
  </button>
</div>

<table id="ticketsTable" class="table table-striped table-hover align-middle w-100">
  <thead class="table-dark">
    <tr>
      <th>{{ _('ID') }}</th>
      <th>{{ _('Subject') }}</th>
      <th>{{ _('Description') }}</th>
      <th>{{ _('Priority') }}</th>
      <th>{{ _('Status') }}</th>
      <th>{{ _('Created By') }}</th>
      <th>{{ _('Assigned To') }}</th>
      <th>{{ _('Created') }}</th>
      <th>{{ _('Closed') }}</th>
      <th>{{ _('Actions') }}</th>
    </tr>
  </thead>
  <tbody>
    {% for t in tickets %}
    <tr id="ticket-row-{{ t.id }}" data-ticket-id="{{ t.id }}">
      <td>{{ t.id }}</td>
      <td>{{ t.subject }}</td>
      <td class="text-truncate" style="max-width:250px;">{{ t.description }}</td>

      <td>
        {% if t.priority == 'Low' %}
          <span class="badge bg-success">{{ _('Low') }}</span>
        {% elif t.priority == 'Medium' %}
          <span class="badge bg-info text-dark">{{ _('Medium') }}</span>
        {% elif t.priority == 'High' %}
          <span class="badge bg-warning text-dark">{{ _('High') }}</span>
        {% elif t.priority == 'Critical' %}
          <span class="badge bg-danger">{{ _('Critical') }}</span>
        {% endif %}
      </td>

      <td>
        {% if t.status == 'Open' %}
          <span class="badge bg-success">{{ _('Open') }}</span>
        {% elif t.status == 'In Progress' %}
          <span class="badge bg-warning text-dark">{{ _('In Progress') }}</span>
        {% elif t.status == 'Closed' %}
          <span class="badge bg-secondary">{{ _('Closed') }}</span>
        {% endif %}
      </td>

      <td>{{ t.creator.username if t.creator else '—' }}</td>
      <td>{{ t.assignee.username if t.assignee else '—' }}</td>

      <td data-order="{{ t.created_at_local.isoformat() if t.created_at_local else '' }}"
          data-search="{{ t.created_at_local.isoformat() if t.created_at_local else '' }}">
        {{ t.created_at_local.strftime('%Y-%m-%d %H:%M') if t.created_at_local else '—' }}
      </td>
      <td data-order="{{ t.closed_at_local.isoformat() if t.closed_at_local else '' }}"
          data-search="{{ t.closed_at_local.isoformat() if t.closed_at_local else '' }}">
        {{ t.closed_at_local.strftime('%Y-%m-%d %H:%M') if t.closed_at_local else '—' }}
      </td>

      <td class="text-nowrap">
        <i class="fa fa-comments{% if t.comments|length == 0 %} text-muted{% else %} text-primary{% endif %}" 
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="{% if t.comments|length == 0 %}{{ _('No comments') }}{% else %}{{ t.comments|length }} {{ _('comment(s) exist') }}{% endif %}"></i>

        <i class="fa fa-paperclip ms-2{% if t.attachments|length == 0 %} text-muted{% else %} text-success{% endif %}" 
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="{% if t.attachments|length == 0 %}{{ _('No attachments') }}{% else %}{{ t.attachments|length }} {{ _('attachment(s) exist') }}{% endif %}"></i>

        <a href="#" class="btn btn-sm btn-outline-info view-ticket-btn ms-2" data-id="{{ t.id }}" title="{{ _('View') }}">
          <i class="fa fa-eye"></i>
        </a>

        <button type="button" class="btn btn-sm btn-outline-primary edit-ticket-btn" data-id="{{ t.id }}" title="{{ _('Edit') }}">
          <i class="fa fa-edit"></i>
        </button>

        <button type="button" class="btn btn-sm btn-outline-danger delete-ticket-btn" data-id="{{ t.id }}" title="{{ _('Delete') }}">
          <i class="fa fa-trash"></i>
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Add Modal -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form class="ajax-form" id="new-ticket-form" action="{{ url_for('tickets.create_ticket') }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title d-flex align-items-center gap-2">
            <i class="fa fa-plus"></i> <span>{{ _('New Ticket') }}</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">{{ _('Subject') }}</label>
          <input name="subject" class="form-control mb-2" required>

          <label class="form-label">{{ _('Description') }}</label>
          <textarea name="description" class="form-control mb-2" rows="3" required></textarea>

          <label class="form-label">{{ _('Priority') }}</label>
          <select name="priority" class="form-select mb-2">
            <option value="Low">{{ _('Low') }}</option>
            <option value="Medium">{{ _('Medium') }}</option>
            <option value="High">{{ _('High') }}</option>
            <option value="Critical">{{ _('Critical') }}</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success"><i class="fa fa-check"></i> {{ _('Create') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Modal Container -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content fancy-modal">
      <div id="editModalContent">
        <!-- Dynamic content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fa fa-trash"></i> {{ _('Confirm Delete') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">{{ _('Are you sure you want to delete this ticket?') }}</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger"><i class="fa fa-trash"></i> {{ _('Delete') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- DataTables + Buttons -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
$(function() {
  // Initialize DataTable
  const table = $('#ticketsTable').DataTable({
    order: [[0, 'desc']],
    pageLength: 10,
    language: { url: "{{ url_for('static', filename='datatables/' + g.locale + '.json') }}" },
    dom: "<'row mb-2'<'col-md-6 d-flex align-items-center gap-2'lB><'col-md-6 text-end'f>>" +
         "<'row'<'col-sm-12'tr>>" +
         "<'row mt-3'<'col-12'Q>>" +
         "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
    buttons: [
      { extend: 'excelHtml5', text: '<i class=\"fa fa-file-excel\"></i> {{ _("Excel") }}', className: 'btn btn-success btn-sm mx-1' },
      { extend: 'print', text: '<i class=\"fa fa-print\"></i> {{ _("Print") }}', className: 'btn btn-secondary btn-sm mx-1' },
      { extend: 'searchBuilder', text: '<i class=\"fa fa-filter\"></i> {{ _("Advanced Filters") }}', className: 'btn btn-secondary btn-sm mx-1' }
    ],
    columnDefs: [
      { targets: [7, 8], type: 'date', searchBuilderType: 'date' }
    ],
    searchBuilder: {
      columns: [0, 1, 3, 4, 5, 6, 7, 8],
      depthLimit: 3
    }
  });

  // Initialize tooltips
  $('[data-bs-toggle="tooltip"]').tooltip();

  // Double-click row to open view modal
  $('#ticketsTable tbody').on('dblclick', 'tr', function() {
    const row = table.row(this);
    if (!row.node()) return;
    const $row = $(row.node());
    const ticketId = $row.data('ticket-id');
    if (!ticketId) return;

    $.get(`/tickets/${ticketId}/view`, function(html) {
      $('body').append(html);
      const modal = new bootstrap.Modal(document.getElementById('ticketViewModal'));
      modal.show();
      $('#ticketViewModal').on('hidden.bs.modal', () => $('#ticketViewModal').remove());
    });
  });

  // Reset new ticket form when modal is shown
  $('#addModal').on('show.bs.modal', function() {
    const form = $('#new-ticket-form');
    form[0].reset(); // Reset all form fields
    
    // Reset select to first option
    form.find('select[name="priority"]').val('Low');
    
    // Clear any validation states
    form.find('.is-invalid').removeClass('is-invalid');
    form.find('.invalid-feedback').remove();
  });

  // Also reset form when modal is hidden (as a backup)
  $('#addModal').on('hidden.bs.modal', function() {
    $('#new-ticket-form')[0].reset();
  });

  let ticketToDelete = null;

  // Delete ticket handler
  $(document).on('click', '.delete-ticket-btn', function() {
    ticketToDelete = $(this).data('id');
    $('#deleteConfirmModal').modal('show');
  });

  $('#confirmDeleteBtn').on('click', function() {
    if (!ticketToDelete) return;
    const deleteBtn = $(this);
    deleteBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {{ _("Deleting...") }}');
    $.post(`/tickets/${ticketToDelete}/delete`, { csrf_token: '{{ csrf_token() }}' })
      .done(() => { 
        $('#deleteConfirmModal').modal('hide'); 
        window.location.reload(); 
      })
      .fail(() => {
        deleteBtn.prop('disabled', false).html('{{ _("Delete") }}');
        showFlash('❌ {{ _("Delete failed") }}', 'danger');
        $('#deleteConfirmModal').modal('hide');
      });
  });

  // Edit ticket handler - load modal content dynamically
  $(document).on('click', '.edit-ticket-btn', function() {
    const ticketId = $(this).data('id');
    const editBtn = $(this);
    
    // Show loading state
    editBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i>');
    
    // Load edit form via AJAX
    $.get(`/tickets/${ticketId}/edit`, function(html) {
      $('#editModalContent').html(html);
      $('#editModal').modal('show');
      editBtn.prop('disabled', false).html('<i class="fa fa-edit"></i>');
    }).fail(function() {
      showToast('❌ {{ _("Failed to load edit form") }}', 'danger');
      editBtn.prop('disabled', false).html('<i class="fa fa-edit"></i>');
    });
  });

  // Handle edit form submission
  $(document).on('submit', '#editModalContent form', function(e) {
    e.preventDefault();
    const form = $(this);
    const submitBtn = form.find('button[type="submit"]');
    const originalBtnText = submitBtn.html();
    
    // Disable button and show loading
    submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {{ _("Saving...") }}');
    
    $.ajax({
      url: form.attr('action'),
      type: 'POST',
      data: form.serialize(),
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(res) {
        if (res.success) {
          showToast(res.message, res.category || 'success');
          $('#editModal').modal('hide');
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast(res.message || '⚠️ Operation failed', res.category || 'warning');
          submitBtn.prop('disabled', false).html(originalBtnText);
        }
      },
      error: function(xhr) {
        let msg = xhr.responseJSON?.message || '❌ Unexpected server error';
        showToast(msg, 'danger');
        submitBtn.prop('disabled', false).html(originalBtnText);
      }
    });
  });

  // AJAX form handler for create
  $(document).on('submit', '#new-ticket-form', function(e) {
    e.preventDefault();
    const form = $(this);
    const modal = form.closest('.modal');
    const submitBtn = form.find('button[type="submit"]');
    const originalBtnText = submitBtn.html();
    
    // Disable button and show loading
    submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {{ _("Creating...") }}');
    
    $.ajax({
      url: form.attr('action'),
      type: 'POST',
      data: form.serialize(),
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(res) {
        if (res.success) {
          showToast(res.message, res.category || 'success');
          modal.modal('hide');
          // Don't reset here - let the show.bs.modal event handle it
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showToast(res.message || '⚠️ Operation failed', res.category || 'warning');
          submitBtn.prop('disabled', false).html(originalBtnText);
        }
      },
      error: function(xhr) {
        let msg = xhr.responseJSON?.message || '❌ Unexpected server error';
        showToast(msg, 'danger');
        submitBtn.prop('disabled', false).html(originalBtnText);
      }
    });
  });

  // View ticket handler
  $(document).on('click', '.view-ticket-btn', function(e) {
    e.preventDefault();
    const id = $(this).data('id');
    $.get(`/tickets/${id}/view`, function(html) {
      $('body').append(html);
      const modal = new bootstrap.Modal(document.getElementById('ticketViewModal'));
      modal.show();
      $('#ticketViewModal').on('hidden.bs.modal', () => $('#ticketViewModal').remove());
    });
  });

  // Flash message function
  function showFlash(msg, type) {
    const alert = $(`<div class="alert alert-${type} alert-dismissible fade show shadow-sm mt-2" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
    $('.container').prepend(alert);
    setTimeout(() => alert.alert('close'), 4000);
  }
});

// Toast notification function
function showToast(message, category="info") {
  const iconMap = {
    success: "fa-check-circle text-success",
    danger: "fa-exclamation-triangle text-danger",
    warning: "fa-exclamation-circle text-warning",
    info: "fa-info-circle text-info"
  };
  const icon = iconMap[category] || "fa-info-circle text-info";
  const toast = $(`
    <div class="toast align-items-center text-bg-${category} border-0 shadow-sm fade show mb-2 position-fixed top-0 end-0 me-3 mt-3" role="alert">
      <div class="d-flex">
        <div class="toast-body">
          <i class="fa ${icon} me-2"></i>${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `);
  $('body').append(toast);
  const bsToast = new bootstrap.Toast(toast[0], { delay: 3500 });
  bsToast.show();
  toast.on('hidden.bs.toast', () => toast.remove());
}
</script>

{% endblock %}
