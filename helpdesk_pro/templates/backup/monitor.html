{% extends "base.html" %}

{% block content %}

<style>
  .backup-summary-card {
    border-radius: 0.9rem;
    border: 1px solid rgba(148, 163, 184, 0.25);
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.94) 0%, rgba(224, 231, 255, 0.91) 50%, rgba(209, 213, 219, 0.85) 100%);
    color: #0f172a;
    overflow: hidden;
  }
  html[data-bs-theme="dark"] body .backup-summary-card {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.82) 0%, rgba(17, 24, 39, 0.78) 45%, rgba(30, 41, 59, 0.74) 100%);
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.35);
    backdrop-filter: blur(12px);
  }
  .backup-summary-card .metric {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .backup-summary-card .metric-count {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.45rem 1rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.95rem;
    box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.08);
  }
  html[data-bs-theme="dark"] body .backup-summary-card .metric-count {
    box-shadow: inset 0 0 0 1px rgba(241, 245, 249, 0.08);
  }
  .backup-summary-card .metric-label {
    text-transform: uppercase;
    font-size: 0.68rem;
    letter-spacing: 0.08em;
    opacity: 0.75;
  }
  .backup-summary-card .divider {
    width: 1px;
    height: 38px;
    background: rgba(148, 163, 184, 0.36);
  }
  @media (max-width: 767px) {
    .backup-summary-card .divider {
      display: none;
    }
  }
  .backup-section-card {
    border-radius: 1rem;
  }
  .badge-pill {
    border-radius: 999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
  }
  .table thead th {
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.06em;
  }
  .quick-actions label {
    font-size: 0.82rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
</style>

<div class="container-fluid px-4 py-3">
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <div>
      <h1 class="mb-1">
        <i class="fa fa-archive me-2"></i>{{ _("Storage Media Monitor") }}
      </h1>
      <p class="text-muted mb-0">{{ _("Track tape cartridges and external disks as they leave the library, monitor retention windows, and record custody history.") }}</p>
    </div>
    {% if module_access == "write" %}
    <div class="mt-3 mt-md-0">
      <button type="button" class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#registerMediaModal">
        <i class="fa fa-plus-circle me-2"></i>{{ _("Register Storage Medium") }}
      </button>
    </div>
    {% endif %}
  </div>

  <div class="card backup-summary-card shadow-sm border-0 mb-4">
    <div class="card-body py-3">
      <div class="d-flex flex-wrap align-items-center gap-4">
        <div class="metric">
          <span class="metric-count bg-primary-subtle text-primary-emphasis">
            <i class="fa fa-layer-group"></i> {{ media|length }}
          </span>
          <span class="metric-label">{{ _("Total Media") }}</span>
        </div>
        <div class="divider d-none d-md-block"></div>
        <div class="metric flex-wrap gap-2">
          {% for type_key, count in medium_type_summary.items() %}
            {% if type_key == "tape" %}
              {% set type_label = _("Tape Cartridges") %}
            {% elif type_key == "disk" %}
              {% set type_label = _("External Disks") %}
            {% else %}
              {% set type_label = type_key|capitalize %}
            {% endif %}
            <span class="badge-pill bg-success-subtle text-success-emphasis">
              {{ type_label }}: {{ count }}
            </span>
          {% endfor %}
        </div>
        <div class="divider d-none d-md-block"></div>
        <div class="metric flex-wrap gap-2">
          {% for key, label in tape_status_choices %}
          <span class="badge-pill bg-secondary-subtle text-secondary-emphasis">
            {{ label }}: {{ status_summary[key]|default(0) }}
          </span>
          {% endfor %}
        </div>
        <div class="divider d-none d-md-block"></div>
        <div class="metric flex-wrap gap-2">
          {% for key, label in location_type_choices %}
          <span class="badge-pill bg-info-subtle text-info-emphasis">
            {{ label }}: {{ location_summary[key]|default(0) }}
          </span>
          {% endfor %}
          <span class="badge-pill bg-warning-subtle text-warning-emphasis">
            {{ _("Unassigned") }}: {{ location_summary["unassigned"]|default(0) }}
          </span>
        </div>
        <div class="divider d-none d-md-block"></div>
        <div class="metric flex-wrap gap-2">
          <span class="badge-pill bg-danger-subtle text-danger-emphasis">
            {{ _("Retention expired") }}: {{ retention_summary.overdue }}
          </span>
          <span class="badge-pill bg-warning-subtle text-warning-emphasis">
            {{ _("Due within 7 days") }}: {{ retention_summary.due_soon }}
          </span>
          <span class="badge-pill bg-success-subtle text-success-emphasis">
            {{ _("Active retention") }}: {{ retention_summary.ok }}
          </span>
          <span class="badge-pill bg-secondary-subtle text-secondary-emphasis">
            {{ _("No retention set") }}: {{ retention_summary.unset }}
          </span>
        </div>
      </div>
    </div>
  </div>

{% if module_access == "write" %}
  <div class="alert alert-info border-0 shadow-sm mb-4 d-flex align-items-start gap-2">
    <i class="fa fa-lightbulb fs-4 mt-1"></i>
    <div>
      <strong class="d-block text-uppercase small">{{ _("Tip") }}</strong>
      <span>{{ _("Use the “Register Storage Medium” button to add new tapes or disks. Lifecycle policies help you group media by backup frequency across the inventory.") }}</span>
    </div>
  </div>
{% endif %}

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">{{ _("Storage Media Inventory") }}</h2>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('backup.monitor') }}"><i class="fa fa-rotate"></i></a>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>{{ _("Barcode / Label") }}</th>
              <th>{{ _("Type") }}</th>
              <th>{{ _("Status") }}</th>
              <th>{{ _("Location") }}</th>
              <th>{{ _("Retention") }}</th>
              <th>{{ _("Usage Tags") }}</th>
              <th>{{ _("Last Inventory") }}</th>
              <th>{{ _("Updated") }}</th>
              <th class="text-end">{{ _("Actions") }}</th>
            </tr>
          </thead>
          <tbody>
            {% for medium in media %}
            <tr>
              <td><a href="{{ url_for('backup.tape_detail', tape_id=medium.id) }}">{{ medium.barcode }}</a></td>
              <td>
                {% if medium.medium_type == 'disk' %}
                  <span class="badge bg-secondary-subtle text-secondary">{{ _("External Disk") }}</span>
                {% else %}
                  <span class="badge bg-primary-subtle text-primary">{{ _("Tape") }}</span>
                {% endif %}
                {% if medium.lto_generation %}
                  <div class="text-muted small">{{ medium.lto_generation }}</div>
                {% elif medium.model_name %}
                  <div class="text-muted small">{{ medium.model_name }}</div>
                {% endif %}
              </td>
              <td>
                {% set status_label = medium.status %}
                {% for key, label in tape_status_choices %}
                  {% if key == medium.status %}
                    {% set status_label = label %}
                  {% endif %}
                {% endfor %}
                <span class="badge bg-primary-subtle text-primary">{{ status_label }}</span>
              </td>
              <td>
                {% if medium.current_location %}
                  {% set loc_label = medium.current_location.location_type %}
                  {% for key, label in location_type_choices %}
                    {% if key == medium.current_location.location_type %}
                      {% set loc_label = label %}
                    {% endif %}
                  {% endfor %}
                  <span class="badge bg-info-subtle text-info">{{ loc_label }}</span>
                  {% if medium.current_location.site_name %}
                    <div class="text-muted small">{{ medium.current_location.site_name }}</div>
                  {% endif %}
                {% else %}
                  <span class="text-muted">{{ _("Unassigned") }}</span>
                {% endif %}
              </td>
              <td>
                {% if medium.retention_days %}
                  <div>{{ medium.retention_days }} {{ _("days") }}</div>
                  {% if medium.retention_until %}
                    {% set remaining = medium.retention_remaining_days() %}
                    {% if remaining is not none and remaining < 0 %}
                      <span class="badge bg-danger-subtle text-danger">{{ _("Expired") }}</span>
                    {% elif remaining is not none and remaining <= 7 %}
                      <span class="badge bg-warning-subtle text-warning">{{ _("Due in %(days)s d", days=remaining) }}</span>
                    {% else %}
                      <span class="text-muted small">{{ medium.retention_until.strftime("%Y-%m-%d") }}</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-secondary-subtle text-secondary">{{ _("Start date needed") }}</span>
                  {% endif %}
                {% else %}
                  <span class="text-muted">{{ _("Not set") }}</span>
                {% endif %}
              </td>
              <td>
                {% if medium.usage_tag_list() %}
                  {% for tag in medium.usage_tag_list() %}
                  <span class="badge bg-dark-subtle text-dark me-1">{{ tag }}</span>
                  {% endfor %}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if medium.last_inventory_at %}
                  {{ medium.last_inventory_at.strftime("%Y-%m-%d") }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>{{ medium.updated_at.strftime("%Y-%m-%d %H:%M") }}</td>
              <td class="text-end">
                {% if module_access == 'write' %}
                  <button type="button" class="btn btn-sm btn-outline-danger delete-tape-btn" data-bs-toggle="modal" data-bs-target="#confirmDeleteTape" data-action="{{ url_for('backup.delete_tape', tape_id=medium.id) }}" data-message="{{ _('Delete storage medium “%(barcode)s”? All associated locations and custody events will also be removed.', barcode=medium.barcode) }}">
                    <i class="fa fa-trash"></i>
                  </button>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="9" class="text-center py-4 text-muted">{{ _("No storage media registered yet.") }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">{{ _("Retention Alerts") }}</h2>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('backup.monitor') }}"><i class="fa fa-rotate"></i></a>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>{{ _("Medium") }}</th>
              <th>{{ _("Type") }}</th>
              <th>{{ _("Retention Ends") }}</th>
              <th>{{ _("Days Remaining") }}</th>
              <th>{{ _("Location") }}</th>
            </tr>
          </thead>
          <tbody>
            {% for medium in attention_media %}
            {% set remaining = medium.retention_remaining_days() %}
            <tr class="{% if remaining is not none and remaining < 0 %}table-danger{% elif remaining is not none and remaining <= 7 %}table-warning{% endif %}">
              <td><a href="{{ url_for('backup.tape_detail', tape_id=medium.id) }}">{{ medium.barcode }}</a></td>
              <td>{{ _("External Disk") if medium.medium_type == 'disk' else _("Tape") }}</td>
              <td>{{ medium.retention_until.strftime("%Y-%m-%d %H:%M") if medium.retention_until else "—" }}</td>
              <td>
                {% if remaining is not none %}
                  {% if remaining < 0 %}
                    {{ _("%(days)s overdue", days=remaining|abs) }}
                  {% else %}
                    {{ remaining }}
                  {% endif %}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if medium.current_location %}
                  {% set loc_label = medium.current_location.location_type %}
                  {% for key, label in location_type_choices %}
                    {% if key == medium.current_location.location_type %}
                      {% set loc_label = label %}
                    {% endif %}
                  {% endfor %}
                  {{ loc_label }}
                  {% if medium.current_location.site_name %}
                    <div class="text-muted small">{{ medium.current_location.site_name }}</div>
                  {% endif %}
                {% else %}
                  <span class="text-muted">{{ _("Unassigned") }}</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center py-3 text-muted">{{ _("No retention alerts. All media are within their retention window.") }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% if module_access == 'write' %}
<!-- Delete Tape Modal -->
<div class="modal fade" id="confirmDeleteTape" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="deleteTapeForm" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="fa fa-trash"></i> {{ _('Delete Storage Medium') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="deleteTapeMessage" class="mb-0"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-danger"><i class="fa fa-trash"></i> {{ _('Delete') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const tapeModal = document.getElementById('confirmDeleteTape');
  const tapeForm = document.getElementById('deleteTapeForm');
  const tapeMessage = document.getElementById('deleteTapeMessage');
  if (tapeModal && tapeForm && tapeMessage) {
    tapeModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;
      if (!button) return;
      tapeForm.setAttribute('action', button.getAttribute('data-action'));
      tapeMessage.textContent = button.getAttribute('data-message');
    });
  }

});
</script>
{% endif %}

{% if module_access == "write" %}
<!-- Register Storage Medium Modal -->
<div class="modal fade" id="registerMediaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <form action="{{ url_for('backup.create_tape') }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-plus-circle me-2"></i>{{ _("Register Storage Medium") }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label">{{ _("Barcode / Label") }}</label>
              <input name="barcode" class="form-control" required>
            </div>
            <div class="col-lg-6">
              <label class="form-label">{{ _("Medium Type") }}</label>
              <select name="medium_type" class="form-select">
                <option value="tape">{{ _("Tape Cartridge") }}</option>
                <option value="disk">{{ _("External Disk") }}</option>
              </select>
            </div>
            <div class="col-lg-4">
              <label class="form-label">{{ _("Lifecycle Policy") }}</label>
              <select name="lifecycle_policy" class="form-select">
                <option value="">{{ _("Select...") }}</option>
                {% for key, label in lifecycle_policy_choices %}
                <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-4">
              <label class="form-label">{{ _("Generation / Model") }}</label>
              <input name="lto_generation" class="form-control" placeholder="LTO-9 / 8TB USB3">
            </div>
            <div class="col-lg-4">
              <label class="form-label">{{ _("Serial Number") }}</label>
              <input name="serial_number" class="form-control">
            </div>
            <div class="col-lg-4">
              <label class="form-label">{{ _("Model") }}</label>
              <input name="model_name" class="form-control">
            </div>
            <div class="col-lg-4">
              <label class="form-label">{{ _("Manufacturer") }}</label>
              <input name="manufacturer" class="form-control">
            </div>
            <div class="col-lg-4">
              <label class="form-label">{{ _("Nominal TB") }}</label>
              <input name="nominal_capacity_tb" type="number" step="0.01" min="0" class="form-control">
            </div>
            <div class="col-lg-4">
              <label class="form-label">{{ _("Usable TB") }}</label>
              <input name="usable_capacity_tb" type="number" step="0.01" min="0" class="form-control">
            </div>
            <div class="col-lg-4">
              <label class="form-label">{{ _("Status") }}</label>
              <select name="status" class="form-select">
                {% for key, label in tape_status_choices %}
                <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-4">
              <label class="form-label">{{ _("Retention (days)") }}</label>
              <input name="retention_days" type="number" min="0" class="form-control" placeholder="30">
            </div>
            <div class="col-lg-4">
              <label class="form-label">{{ _("Retention Start") }}</label>
              <input name="retention_start_at" type="datetime-local" class="form-control">
            </div>
            <div class="col-lg-6">
              <label class="form-label">{{ _("Last Inventory Check") }}</label>
              <input name="last_inventory_at" type="date" class="form-control">
            </div>
            <div class="col-lg-6">
              <label class="form-label">{{ _("Usage Tags (comma separated)") }}</label>
              <input name="usage_tags" class="form-control" placeholder="Vault, Weekly, Finance">
            </div>
            <div class="col-12">
              <label class="form-label">{{ _("Notes") }}</label>
              <textarea name="notes" rows="3" class="form-control" placeholder="{{ _("e.g. Sent to Iron Mountain storage") }}"></textarea>
            </div>
          </div>
          <div class="alert alert-secondary border-0 bg-body-tertiary mt-3 mb-0 small">
            <i class="fa fa-info-circle me-2"></i>{{ _("Retention dates help you plan returns to the library. Set a start date when the medium leaves controlled storage.") }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _("Cancel") }}</button>
          <button type="submit" class="btn btn-primary"><i class="fa fa-save me-2"></i>{{ _("Register Medium") }}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
