{% extends "base.html" %}
{% block content %}
<style>
  .backup-detail-summary {
    border-radius: 1rem;
    border: 1px solid rgba(148, 163, 184, 0.25);
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.94) 0%, rgba(224, 231, 255, 0.91) 50%, rgba(209, 213, 219, 0.85) 100%);
  }
  html[data-bs-theme="dark"] body .backup-detail-summary {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.82) 0%, rgba(17, 24, 39, 0.78) 45%, rgba(30, 41, 59, 0.74) 100%);
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.35);
  }
  .badge-chip {
    border-radius: 999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
  }
  .table thead th {
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.06em;
  }
  .form-label {
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
</style>

<div class="container-fluid px-4 py-3">
  <nav aria-label="{{ _('Breadcrumb') }}">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('backup.monitor') }}">{{ _('Backup Monitor') }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ tape.barcode }}</li>
    </ol>
  </nav>

  <div class="d-flex align-items-center justify-content-between gap-2 mb-3 flex-wrap">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <h1 class="mb-0"><i class="fa fa-tag me-2"></i>{{ tape.barcode }}</h1>
      <span class="badge-chip bg-primary-subtle text-primary-emphasis">{{ tape.lto_generation }}</span>
    </div>
    {% if module_access == 'write' %}
    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteTapeModal">
      <i class="fa fa-trash"></i> {{ _('Delete Storage Medium') }}
    </button>
    {% endif %}
  </div>
  <p class="text-muted mb-4">{{ _("Detailed traceability for the selected storage medium, including retention status and custody history.") }}</p>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card backup-detail-summary shadow-sm border-0 h-100">
        <div class="card-body">
          <h2 class="h5">{{ _('Storage Medium Overview') }}</h2>
          <dl class="row mb-0">
            <dt class="col-5 text-muted">{{ _('Medium type') }}</dt>
            <dd class="col-7">
              {% if tape.medium_type == 'disk' %}
                <span class="badge bg-secondary-subtle text-secondary">{{ _('External Disk') }}</span>
              {% else %}
                <span class="badge bg-primary-subtle text-primary">{{ _('Tape Cartridge') }}</span>
              {% endif %}
              {% if tape.lto_generation %}
                <div class="text-muted small">{{ tape.lto_generation }}</div>
              {% elif tape.model_name %}
                <div class="text-muted small">{{ tape.model_name }}</div>
              {% endif %}
            </dd>
            <dt class="col-5 text-muted">{{ _('Manufacturer') }}</dt>
            <dd class="col-7">{{ tape.manufacturer or "—" }}</dd>
            <dt class="col-5 text-muted">{{ _('Serial number') }}</dt>
            <dd class="col-7">{{ tape.serial_number or "—" }}</dd>
            <dt class="col-5 text-muted">{{ _('Status') }}</dt>
            <dd class="col-7">
              {% set status_label = tape.status %}
              {% for key, label in tape_status_choices %}
                {% if key == tape.status %}
                  {% set status_label = label %}
                {% endif %}
              {% endfor %}
              <span class="badge bg-primary-subtle text-primary">{{ status_label }}</span>
            </dd>
            <dt class="col-5 text-muted">{{ _('Nominal capacity') }}</dt>
            <dd class="col-7">{{ tape.nominal_capacity_tb or "—" }} TB</dd>
            <dt class="col-5 text-muted">{{ _('Usable capacity') }}</dt>
            <dd class="col-7">{{ tape.usable_capacity_tb or "—" }} TB</dd>
            <dt class="col-5 text-muted">{{ _('Retention') }}</dt>
            <dd class="col-7">
              {% if tape.retention_days %}
                {{ tape.retention_days }} {{ _('days') }}
                {% if tape.retention_until %}
                  <div class="text-muted small">{{ _('Ends %(date)s', date=tape.retention_until.strftime("%Y-%m-%d %H:%M")) }}</div>
                  {% if retention_state %}
                    <span class="badge bg-info-subtle text-info">{{ retention_state }}</span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-warning-subtle text-warning">{{ _('Set retention start date') }}</span>
                {% endif %}
              {% else %}
                <span class="text-muted">{{ _('Not set') }}</span>
              {% endif %}
            </dd>
            <dt class="col-5 text-muted">{{ _('Last inventory check') }}</dt>
            <dd class="col-7">
              {% if tape.last_inventory_at %}
                {{ tape.last_inventory_at.strftime("%Y-%m-%d") }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </dd>
            <dt class="col-5 text-muted">{{ _('Current location') }}</dt>
            <dd class="col-7">
              {% if tape.current_location %}
                {% set loc_label = tape.current_location.location_type %}
                {% for key, label in location_type_choices %}
                  {% if key == tape.current_location.location_type %}
                    {% set loc_label = label %}
                  {% endif %}
                {% endfor %}
                <span class="badge bg-info-subtle text-info">{{ loc_label }}</span>
                {% if tape.current_location.site_name %}
                  <div class="text-muted small">{{ tape.current_location.site_name }}</div>
                {% endif %}
              {% else %}
                <span class="text-muted">{{ _('Unassigned') }}</span>
              {% endif %}
            </dd>
            <dt class="col-5 text-muted">{{ _('Usage tags') }}</dt>
            <dd class="col-7">
              {% if tape.usage_tag_list() %}
                {% for tag in tape.usage_tag_list() %}
                  <span class="badge bg-dark-subtle text-dark me-1">{{ tag }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>
    </div>
    {% if module_access == "write" %}
    <div class="col-md-8">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h2 class="h5">{{ _('Update Storage Medium') }}</h2>
          <form method="post" action="{{ url_for('backup.update_tape', tape_id=tape.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="row g-2">
              <div class="col-sm-4">
                <label class="form-label" for="medium_type">{{ _('Medium Type') }}</label>
                <select class="form-select" id="medium_type" name="medium_type">
                  <option value="tape" {% if tape.medium_type == 'tape' %}selected{% endif %}>{{ _('Tape Cartridge') }}</option>
                  <option value="disk" {% if tape.medium_type == 'disk' %}selected{% endif %}>{{ _('External Disk') }}</option>
                </select>
              </div>
              <div class="col-sm-4">
                <label class="form-label" for="lto_generation">{{ _('Generation / Model') }}</label>
                <input class="form-control" id="lto_generation" name="lto_generation" value="{{ tape.lto_generation }}">
              </div>
              <div class="col-sm-4">
                <label class="form-label" for="serial_number">{{ _('Serial Number') }}</label>
                <input class="form-control" id="serial_number" name="serial_number" value="{{ tape.serial_number }}">
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-sm-4">
                <label class="form-label" for="lifecycle_policy">{{ _('Lifecycle Policy') }}</label>
                <select class="form-select" id="lifecycle_policy" name="lifecycle_policy">
                  <option value="">{{ _('Select...') }}</option>
                  {% for key, label in lifecycle_policy_choices %}
                  <option value="{{ key }}" {% if tape.lifecycle_policy == key %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-sm-4">
                <label class="form-label" for="manufacturer">{{ _('Manufacturer') }}</label>
                <input class="form-control" id="manufacturer" name="manufacturer" value="{{ tape.manufacturer }}">
              </div>
              <div class="col-sm-4">
                <label class="form-label" for="nominal_capacity_tb">{{ _('Nominal TB') }}</label>
                <input class="form-control" type="number" step="0.01" id="nominal_capacity_tb" name="nominal_capacity_tb" value="{{ tape.nominal_capacity_tb }}">
              </div>
              <div class="col-sm-4">
                <label class="form-label" for="usable_capacity_tb">{{ _('Usable TB') }}</label>
                <input class="form-control" type="number" step="0.01" id="usable_capacity_tb" name="usable_capacity_tb" value="{{ tape.usable_capacity_tb }}">
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-sm-4">
                <label class="form-label" for="status">{{ _('Status') }}</label>
                <select class="form-select" id="status" name="status">
                  {% for key, label in tape_status_choices %}
                  <option value="{{ key }}" {% if key == tape.status %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-sm-4">
                <label class="form-label" for="retention_days">{{ _('Retention (days)') }}</label>
                <input class="form-control" type="number" min="0" id="retention_days" name="retention_days" value="{{ tape.retention_days }}">
              </div>
              <div class="col-sm-4">
                <label class="form-label" for="retention_start_at">{{ _('Retention Start') }}</label>
                <input class="form-control" type="datetime-local" id="retention_start_at" name="retention_start_at" value="{{ tape.retention_start_at.strftime('%Y-%m-%dT%H:%M') if tape.retention_start_at }}">
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-sm-6">
                <label class="form-label" for="last_inventory_at">{{ _('Last Inventory Check') }}</label>
                <input class="form-control" type="date" id="last_inventory_at" name="last_inventory_at" value="{{ tape.last_inventory_at.strftime('%Y-%m-%d') if tape.last_inventory_at }}">
              </div>
              <div class="col-sm-6">
                <label class="form-label" for="model_name">{{ _('Model') }}</label>
                <input class="form-control" id="model_name" name="model_name" value="{{ tape.model_name }}">
              </div>
            </div>
            <div class="mt-2">
              <label class="form-label" for="usage_tags">{{ _('Usage Tags (comma separated)') }}</label>
              <input class="form-control" id="usage_tags" name="usage_tags" value="{{ tape.usage_tags }}">
            </div>
            <div class="mt-2">
              <label class="form-label" for="notes">{{ _('Notes') }}</label>
              <textarea class="form-control" id="notes" name="notes" rows="3">{{ tape.notes }}</textarea>
            </div>
            <div class="mt-3">
              <button class="btn btn-primary" type="submit">
                <i class="fa fa-save me-1"></i>{{ _('Save Changes') }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">{{ _('Location History') }}</h2>
          {% if module_access == 'write' %}
          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#locationModal">
            <i class="fa fa-map-marker-alt me-1"></i>{{ _('Add Location Entry') }}
          </button>
          {% endif %}
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>{{ _('Location') }}</th>
                  <th>{{ _('Details') }}</th>
                  <th>{{ _('Check-in') }}</th>
                  <th>{{ _('Check-out') }}</th>
                </tr>
              </thead>
              <tbody>
                {% for location in tape.locations %}
                <tr{% if location.is_current %} class="table-primary"{% endif %}>
                  <td>
                    {% set loc_label = location.location_type %}
                    {% for key, label in location_type_choices %}
                      {% if key == location.location_type %}
                        {% set loc_label = label %}
                      {% endif %}
                    {% endfor %}
                    <strong>{{ loc_label }}</strong>
                    {% if location.is_current %}
                      <span class="badge bg-success ms-1">{{ _('Current') }}</span>
                    {% endif %}
                    <div class="text-muted small">{{ location.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                  </td>
                  <td>
                    {% if location.site_name %}
                      <div><strong>{{ _('Site') }}:</strong> {{ location.site_name }}</div>
                    {% endif %}
                    {% if location.shelf_code %}
                      <div><strong>{{ _('Shelf/Slot') }}:</strong> {{ location.shelf_code }}</div>
                    {% endif %}
                    {% if location.locker_code %}
                      <div><strong>{{ _('Locker Code') }}:</strong> {{ location.locker_code }}</div>
                    {% endif %}
                    {% if location.provider_name %}
                      <div><strong>{{ _('Provider') }}:</strong> {{ location.provider_name }}{% if location.provider_contact %} ({{ location.provider_contact }}){% endif %}</div>
                    {% endif %}
                    {% if location.custody_holder %}
                      <div><strong>{{ _('Holder') }}:</strong> {{ location.custody_holder }}</div>
                    {% endif %}
                    {% if location.notes %}
                      <div class="text-muted small">{{ location.notes }}</div>
                    {% endif %}
                  </td>
                  <td>{{ location.check_in_at.strftime('%Y-%m-%d %H:%M') if location.check_in_at else "—" }}</td>
                  <td>{{ location.check_out_at.strftime('%Y-%m-%d %H:%M') if location.check_out_at else "—" }}</td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-3">{{ _('No location history yet.') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">{{ _('Custody Chain') }}</h2>
          {% if module_access == 'write' %}
          <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#custodyModal">
            <i class="fa fa-user-shield me-1"></i>{{ _('Record Custody Event') }}
          </button>
          {% endif %}
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>{{ _('Timestamp') }}</th>
                  <th>{{ _('Action') }}</th>
                  <th>{{ _('Handed over by') }}</th>
                  <th>{{ _('Received by') }}</th>
                </tr>
              </thead>
              <tbody>
                {% for event in tape.custody_events %}
                <tr>
                  <td>{{ event.event_time.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>{{ event.event_type|capitalize }}</td>
                  <td>
                    {{ event.handed_over_by or "—" }}
                    {% if event.handed_over_signature %}
                      <div class="text-muted small">{{ _('Signature') }}: {{ event.handed_over_signature }}</div>
                    {% endif %}
                  </td>
                  <td>
                    {{ event.received_by or "—" }}
                    {% if event.received_signature %}
                      <div class="text-muted small">{{ _('Signature') }}: {{ event.received_signature }}</div>
                    {% endif %}
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-3">{{ _('No custody events recorded yet.') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">{{ _('Audit Trail') }}</h2>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th>{{ _('Timestamp') }}</th>
              <th>{{ _('Field') }}</th>
              <th>{{ _('Old value') }}</th>
              <th>{{ _('New value') }}</th>
              <th>{{ _('Changed by') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for row in audit_rows %}
            <tr>
              <td>{{ row.timestamp }}</td>
              <td>{{ row.field }}</td>
              <td>{{ row.old }}</td>
              <td>{{ row.new }}</td>
              <td>{{ row.by }}</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center py-3 text-muted">{{ _('No audit entries yet.') }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% if module_access == 'write' %}
<div class="modal fade" id="deleteTapeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('backup.delete_tape', tape_id=tape.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="fa fa-trash"></i> {{ _('Delete Storage Medium') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">{{ _('Delete storage medium “%(barcode)s”? All related locations and custody records will be removed.', barcode=tape.barcode) }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-danger"><i class="fa fa-trash"></i> {{ _('Delete') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% if module_access == 'write' %}
<!-- Add Location Modal -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('backup.add_location', tape_id=tape.id) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-map-marker-alt me-2"></i>{{ _('Add Location Entry') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ _('Type') }}</label>
              <select name="location_type" class="form-select">
                {% for key, label in location_type_choices %}
                <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Site / Vault / Address') }}</label>
              <input name="site_name" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Shelf / Slot Code') }}</label>
              <input name="shelf_code" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Locker / Deposit Code') }}</label>
              <input name="locker_code" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Provider / Courier') }}</label>
              <input name="provider_name" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Contact details') }}</label>
              <input name="provider_contact" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Custody holder') }}</label>
              <input name="custody_holder" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Reference / Ticket') }}</label>
              <input name="custody_reference" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Check-in') }}</label>
              <input name="check_in_at" type="datetime-local" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Check-out') }}</label>
              <input name="check_out_at" type="datetime-local" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">{{ _('Notes') }}</label>
              <textarea name="notes" rows="3" class="form-control"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary"><i class="fa fa-map-marker-alt me-2"></i>{{ _('Add Location Entry') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Custody Event Modal -->
<div class="modal fade" id="custodyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('backup.add_custody_event', tape_id=tape.id) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-user-shield me-2"></i>{{ _('Record Custody Event') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ _('Timestamp') }}</label>
              <input name="event_time" type="datetime-local" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Event type') }}</label>
              <input name="event_type" class="form-control" placeholder="Transfer / Pickup / Return">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Handed over by') }}</label>
              <input name="handed_over_by" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Signature / ID') }}</label>
              <input name="handed_over_signature" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Received by') }}</label>
              <input name="received_by" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ _('Signature / ID') }}</label>
              <input name="received_signature" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">{{ _('Notes') }}</label>
              <textarea name="notes" rows="3" class="form-control"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-success"><i class="fa fa-user-shield me-2"></i>{{ _('Add Custody Entry') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

</div>
{% endblock %}
