{% extends "base.html" %}
{% block content %}
<style>
  .backup-job-summary {
    border-radius: 1rem;
    border: 1px solid rgba(148, 163, 184, 0.25);
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.94) 0%, rgba(224, 231, 255, 0.91) 50%, rgba(209, 213, 219, 0.85) 100%);
  }
  html[data-bs-theme="dark"] body .backup-job-summary {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.82) 0%, rgba(17, 24, 39, 0.78) 45%, rgba(30, 41, 59, 0.74) 100%);
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.35);
  }
  .badge-chip {
    border-radius: 999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
  }
  .form-label {
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .table thead th {
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.06em;
  }
</style>

<div class="container-fluid px-4 py-3">
  <nav aria-label="{{ _('Breadcrumb') }}">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('backup.monitor') }}">{{ _('Backup Monitor') }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ job.name }}</li>
    </ol>
  </nav>

  <div class="d-flex align-items-center justify-content-between gap-2 mb-3 flex-wrap">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <h1 class="mb-0"><i class="fa fa-clipboard-check me-2"></i>{{ job.name }}</h1>
      <span class="badge-chip bg-secondary-subtle text-secondary-emphasis">{{ job.job_date.strftime("%Y-%m-%d %H:%M") }}</span>
    </div>
    {% if module_access == 'write' %}
    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteJobModal">
      <i class="fa fa-trash"></i> {{ _('Delete Job') }}
    </button>
    {% endif %}
  </div>
  <p class="text-muted mb-4">{{ _("Backup job overview with retention, verification outcome, linked tapes, and audit trail.") }}</p>

  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card backup-job-summary shadow-sm border-0 h-100">
        <div class="card-body">
          <h2 class="h5">{{ _('Job Summary') }}</h2>
          <dl class="row mb-0">
            <dt class="col-5 text-muted">{{ _('Job date') }}</dt>
            <dd class="col-7">{{ job.job_date.strftime("%Y-%m-%d %H:%M") }}</dd>
            <dt class="col-5 text-muted">{{ _('Retention') }}</dt>
            <dd class="col-7">{{ job.retention_days }} {{ _('days') }}</dd>
            <dt class="col-5 text-muted">{{ _('Expires on') }}</dt>
            <dd class="col-7">
              {% if job.expires_at %}
                {{ job.expires_at.strftime("%Y-%m-%d") }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </dd>
            <dt class="col-5 text-muted">{{ _('Total files') }}</dt>
            <dd class="col-7">{{ job.total_files or "—" }}</dd>
            <dt class="col-5 text-muted">{{ _('Total size (bytes)') }}</dt>
            <dd class="col-7">{{ job.total_size_bytes or "—" }}</dd>
            <dt class="col-5 text-muted">{{ _('Verification result') }}</dt>
            <dd class="col-7">{{ job.verify_result|default(_("Pending"))|capitalize }}</dd>
            <dt class="col-5 text-muted">{{ _('Source system') }}</dt>
            <dd class="col-7">{{ job.source_system or "—" }}</dd>
            <dt class="col-5 text-muted">{{ _('Responsible technician') }}</dt>
            <dd class="col-7">{{ job.responsible_user.username if job.responsible_user else "—" }}</dd>
          </dl>
        </div>
      </div>
    </div>
    {% if module_access == "write" %}
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h2 class="h5">{{ _('Update Backup Job') }}</h2>
          <form method="post" action="{{ url_for('backup.update_job', job_id=job.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="row g-2">
              <div class="col-sm-6">
                <label class="form-label" for="name">{{ _('Job Name') }}</label>
                <input class="form-control" id="name" name="name" value="{{ job.name }}">
              </div>
              <div class="col-sm-6">
                <label class="form-label" for="job_date">{{ _('Job Date') }}</label>
                <input class="form-control" type="datetime-local" id="job_date" name="job_date" value="{{ job.job_date.strftime('%Y-%m-%dT%H:%M') }}">
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-sm-4">
                <label class="form-label" for="retention_days">{{ _('Retention (days)') }}</label>
                <input class="form-control" type="number" min="1" id="retention_days" name="retention_days" value="{{ job.retention_days }}">
              </div>
              <div class="col-sm-4">
                <label class="form-label" for="total_files">{{ _('Total files') }}</label>
                <input class="form-control" type="number" min="0" id="total_files" name="total_files" value="{{ job.total_files }}">
              </div>
              <div class="col-sm-4">
                <label class="form-label" for="total_size_bytes">{{ _('Total size (bytes)') }}</label>
                <input class="form-control" type="number" min="0" id="total_size_bytes" name="total_size_bytes" value="{{ job.total_size_bytes }}">
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-sm-6">
                <label class="form-label" for="verify_result">{{ _('Verify Result') }}</label>
                <select class="form-select" id="verify_result" name="verify_result">
                  <option value="">{{ _('Select...') }}</option>
                  {% for key, label in verify_result_choices %}
                  <option value="{{ key }}" {% if key == job.verify_result %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-sm-6">
                <label class="form-label" for="source_system">{{ _('Source System') }}</label>
                <input class="form-control" id="source_system" name="source_system" value="{{ job.source_system }}">
              </div>
            </div>
            <div class="mt-2">
              <label class="form-label" for="responsible_user_id">{{ _('Responsible Technician') }}</label>
              <select class="form-select" id="responsible_user_id" name="responsible_user_id">
                <option value="">{{ _('Unassigned') }}</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if job.responsible_user_id == user.id %}selected{% endif %}>{{ user.username }} ({{ user.role|capitalize }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="mt-2">
              <label class="form-label" for="tape_ids">{{ _('Tape Cartridges') }}</label>
              <select class="form-select" id="tape_ids" name="tape_ids" multiple>
                {% set current_ids = job.tapes|map(attribute='id')|list %}
                {% for tape in tapes %}
                <option value="{{ tape.id }}" {% if tape.id in current_ids %}selected{% endif %}>{{ tape.barcode }} — {{ tape.lto_generation }}</option>
                {% endfor %}
              </select>
              <small class="text-muted">{{ _('Select multiple tapes to represent spanning jobs.') }}</small>
            </div>
            <div class="mt-2">
              <label class="form-label" for="notes">{{ _('Notes') }}</label>
              <textarea class="form-control" id="notes" name="notes" rows="3">{{ job.notes }}</textarea>
            </div>
            <div class="mt-3">
              <button class="btn btn-primary" type="submit">
                <i class="fa fa-save me-1"></i>{{ _('Save Changes') }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-body-tertiary">
      <h2 class="h5 mb-0">{{ _('Associated Tape Cartridges') }}</h2>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>{{ _('Barcode') }}</th>
              <th>{{ _('LTO Generation') }}</th>
              <th>{{ _('Status') }}</th>
              <th>{{ _('Current location') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for tape in job.tapes %}
            <tr>
              <td><a href="{{ url_for('backup.tape_detail', tape_id=tape.id) }}">{{ tape.barcode }}</a></td>
              <td>{{ tape.lto_generation }}</td>
              <td>{{ tape.status|capitalize }}</td>
              <td>
                {% if tape.current_location %}
                  {{ tape.current_location.site_name or tape.current_location.location_type }}
                {% else %}
                  <span class="text-muted">{{ _('Unassigned') }}</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="4" class="text-center text-muted py-3">{{ _('No tapes linked to this job yet.') }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-header bg-body-tertiary">
      <h2 class="h5 mb-0">{{ _('Audit Trail') }}</h2>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>{{ _('Timestamp') }}</th>
              <th>{{ _('Field') }}</th>
              <th>{{ _('Old value') }}</th>
              <th>{{ _('New value') }}</th>
              <th>{{ _('Changed by') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in audit_entries %}
            <tr>
              <td>{{ entry.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
              <td>{{ entry.field_name or _('Event') }}</td>
              <td>{{ entry.old_value or "—" }}</td>
              <td>{{ entry.new_value or "—" }}</td>
              <td>{{ entry.changed_by_username or "—" }}</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center text-muted py-3">{{ _('No audit entries yet.') }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% if module_access == 'write' %}
<div class="modal fade" id="deleteJobModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('backup.delete_job', job_id=job.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="fa fa-trash"></i> {{ _('Delete Backup Job') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">{{ _('Delete job “%(name)s”? Tape assignments will be removed but cartridges remain available for new jobs.', name=job.name) }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-danger"><i class="fa fa-trash"></i> {{ _('Delete') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

</div>
{% endblock %}
