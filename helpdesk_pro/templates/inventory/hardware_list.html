{% extends "base.html" %}
{% block content %}

<style>
  .inventory-summary-card {
    border-radius: 0.9rem;
    border: 1px solid rgba(148, 163, 184, 0.25);
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.94) 0%, rgba(226, 232, 240, 0.9) 50%, rgba(209, 213, 219, 0.85) 100%);
    color: #0f172a;
    overflow: hidden;
  }
  body[data-bs-theme="dark"] .inventory-summary-card {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.82) 0%, rgba(17, 24, 39, 0.78) 50%, rgba(30, 41, 59, 0.74) 100%);
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.35);
    backdrop-filter: blur(12px);
  }
  .inventory-summary-card .metric {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .inventory-summary-card .metric-count {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 1rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.95rem;
    box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.08);
  }
  body[data-bs-theme="dark"] .inventory-summary-card .metric-count {
    box-shadow: inset 0 0 0 1px rgba(241, 245, 249, 0.08);
  }
  .inventory-summary-card .metric-label {
    text-transform: uppercase;
    font-size: 0.68rem;
    letter-spacing: 0.08em;
    opacity: 0.75;
  }
  .inventory-summary-card .divider {
    width: 1px;
    height: 36px;
    background: rgba(148, 163, 184, 0.36);
  }
  @media (max-width: 767px) {
    .inventory-summary-card .divider {
      display: none;
    }
  }
  .dt-searchBuilder {
    border-radius: 0.85rem;
    padding: 1rem 1.25rem;
    border: 1px solid rgba(148, 163, 184, 0.2);
    background: rgba(15, 23, 42, 0.02);
  }
  body[data-bs-theme="dark"] .dt-searchBuilder {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(148, 163, 184, 0.35);
  }
  .dt-searchBuilder button.btn {
    border-radius: 0.5rem;
  }
  body[data-bs-theme="dark"] .dt-searchBuilder button.btn,
  body[data-bs-theme="light"] .dt-searchBuilder .btn-outline-secondary,
  body[data-bs-theme="light"] .dt-searchBuilder .btn-outline-primary,
  body[data-bs-theme="light"] .dt-searchBuilder .btn-outline-info {
    color: #f8fafc;
  }
  .badge-soft {
    border-radius: 999px;
    padding: 0.25rem 0.7rem;
    font-size: 0.75rem;
  }
  .datatable-nowrap th,
  .datatable-nowrap td {
    white-space: nowrap;
  }
  .dataTables_wrapper .dataTables_scroll {
    overflow: auto;
  }
</style>

{% set total_assets = assets|length %}
{% set assigned_count = assets|selectattr('assignee', 'ne', None)|list|length %}
{% set unassigned_count = total_assets - assigned_count %}
{% set in_service = status_summary.get('In Service', 0) %}
{% set in_stock = status_summary.get('In Stock', 0) %}
{% set under_maintenance = status_summary.get('Under Maintenance', 0) %}

<div class="card inventory-summary-card border-0 shadow-sm mb-3">
  <div class="card-body py-3">
    <div class="d-flex flex-wrap align-items-center gap-4">
      <div class="metric">
        <span class="metric-count bg-primary-subtle text-primary-emphasis">
          <i class="fa fa-boxes-stacked"></i> {{ total_assets }}
        </span>
        <span class="metric-label">{{ _('Total Hardware Assets') }}</span>
      </div>
      <div class="divider d-none d-md-block"></div>
      <div class="metric">
        <span class="metric-count bg-success-subtle text-success-emphasis">
          <i class="fa fa-user-check"></i> {{ assigned_count }}
        </span>
        <span class="metric-label">{{ _('Assigned') }}</span>
      </div>
      <div class="metric">
        <span class="metric-count bg-secondary-subtle text-secondary-emphasis">
          <i class="fa fa-inbox"></i> {{ unassigned_count }}
        </span>
        <span class="metric-label">{{ _('In Inventory') }}</span>
      </div>
      <div class="metric">
        <span class="metric-count bg-info-subtle text-info-emphasis">
          <i class="fa fa-screwdriver-wrench"></i> {{ under_maintenance }}
        </span>
        <span class="metric-label">{{ _('Maintenance') }}</span>
      </div>
      <div class="metric">
        <span class="metric-count bg-success-subtle text-success-emphasis">
          <i class="fa fa-plug"></i> {{ in_service }}
        </span>
        <span class="metric-label">{{ _('In Service') }}</span>
      </div>
      <div class="metric">
        <span class="metric-count bg-warning-subtle text-warning-emphasis">
          <i class="fa fa-warehouse"></i> {{ in_stock }}
        </span>
        <span class="metric-label">{{ _('In Stock') }}</span>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="fa fa-microchip"></i> {{ _('Hardware Inventory') }}</h4>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#hardwareCreateModal">
    <i class="fa fa-plus"></i> {{ _('New Hardware Asset') }}
  </button>
</div>

<table id="hardwareTable" class="table table-striped table-hover align-middle w-100 datatable-nowrap">
  <thead class="table-dark">
    <tr>
      <th>{{ _('Asset Tag') }}</th>
      <th>{{ _('Custom Serial') }}</th>
      <th>{{ _('Serial Number') }}</th>
      <th>{{ _('Category') }}</th>
      <th>{{ _('Type') }}</th>
      <th>{{ _('Manufacturer') }}</th>
      <th>{{ _('Model') }}</th>
      <th>{{ _('CPU') }}</th>
      <th>{{ _('RAM') }}</th>
      <th>{{ _('Storage') }}</th>
      <th>{{ _('GPU') }}</th>
      <th>{{ _('Operating System') }}</th>
      <th>{{ _('Status') }}</th>
      <th>{{ _('Condition') }}</th>
      <th>{{ _('Location') }}</th>
      <th>{{ _('Rack/Room') }}</th>
      <th>{{ _('IP Address') }}</th>
      <th>{{ _('MAC Address') }}</th>
      <th>{{ _('Hostname') }}</th>
      <th>{{ _('Purchase Date') }}</th>
      <th>{{ _('Warranty End') }}</th>
      <th>{{ _('Support Vendor') }}</th>
      <th>{{ _('Support Contract') }}</th>
      <th>{{ _('Assigned To') }}</th>
      <th>{{ _('Assigned On') }}</th>
      <th>{{ _('Accessories') }}</th>
      <th>{{ _('Power Supply') }}</th>
      <th>{{ _('BIOS') }}</th>
      <th>{{ _('Firmware') }}</th>
      <th>{{ _('Notes') }}</th>
      <th>{{ _('Actions') }}</th>
    </tr>
  </thead>
  <tbody>
    {% for asset in assets %}
    <tr data-asset-id="{{ asset.id }}">
      <td class="fw-semibold">{{ asset.asset_tag }}</td>
      <td>{{ asset.custom_tag or '—' }}</td>
      <td>{{ asset.serial_number or '—' }}</td>
      <td>{{ asset.category or '—' }}</td>
      <td>{{ asset.type or '—' }}</td>
      <td>{{ asset.manufacturer or '—' }}</td>
      <td>{{ asset.model or '—' }}</td>
      <td>{{ asset.cpu or '—' }}</td>
      <td>{{ asset.ram_gb or '—' }}</td>
      <td>{{ asset.storage or '—' }}</td>
      <td>{{ asset.gpu or '—' }}</td>
      <td>{{ asset.operating_system or '—' }}</td>
      <td>
        {% if asset.status == 'In Service' %}
          <span class="badge-soft bg-success-subtle text-success-emphasis">{{ _('In Service') }}</span>
        {% elif asset.status == 'In Stock' %}
          <span class="badge-soft bg-primary-subtle text-primary-emphasis">{{ _('In Stock') }}</span>
        {% elif asset.status == 'Under Maintenance' %}
          <span class="badge-soft bg-warning-subtle text-warning-emphasis">{{ _('Under Maintenance') }}</span>
        {% elif asset.status == 'Retired' %}
          <span class="badge-soft bg-secondary-subtle text-secondary-emphasis">{{ _('Retired') }}</span>
        {% elif asset.status == 'Disposed' %}
          <span class="badge-soft bg-danger-subtle text-danger-emphasis">{{ _('Disposed') }}</span>
        {% else %}
          <span class="badge-soft bg-light text-body-secondary">{{ asset.status or _('Unknown') }}</span>
        {% endif %}
      </td>
      <td>{{ asset.condition or '—' }}</td>
      <td>{{ asset.location or '—' }}</td>
      <td>{{ asset.rack or '—' }}</td>
      <td>{{ asset.ip_address or '—' }}</td>
      <td>{{ asset.mac_address or '—' }}</td>
      <td>{{ asset.hostname or '—' }}</td>
      <td data-order="{{ asset.purchase_date.isoformat() if asset.purchase_date else '' }}" data-search="{{ asset.purchase_date.isoformat() if asset.purchase_date else '' }}">
        {{ asset.purchase_date.strftime('%Y-%m-%d') if asset.purchase_date else '—' }}
      </td>
      <td data-order="{{ asset.warranty_end.isoformat() if asset.warranty_end else '' }}" data-search="{{ asset.warranty_end.isoformat() if asset.warranty_end else '' }}">
        {{ asset.warranty_end.strftime('%Y-%m-%d') if asset.warranty_end else '—' }}
      </td>
      <td>{{ asset.support_vendor or '—' }}</td>
      <td>{{ asset.support_contract or '—' }}</td>
      <td>{{ asset.assignee.username if asset.assignee else '—' }}</td>
      <td data-order="{{ asset.assigned_on.isoformat() if asset.assigned_on else '' }}" data-search="{{ asset.assigned_on.isoformat() if asset.assigned_on else '' }}">
        {{ asset.assigned_on.strftime('%Y-%m-%d') if asset.assigned_on else '—' }}
      </td>
      <td>{{ asset.accessories or '—' }}</td>
      <td>{{ asset.power_supply or '—' }}</td>
      <td>{{ asset.bios_version or '—' }}</td>
      <td>{{ asset.firmware_version or '—' }}</td>
      <td class="text-truncate" style="max-width: 220px;">{{ (asset.notes or '')[:120] ~ ('…' if asset.notes and asset.notes|length > 120 else '') }}</td>
      <td class="text-nowrap">
        <button type="button"
                class="btn btn-sm btn-outline-primary edit-hardware-btn"
                data-id="{{ asset.id }}"
                data-update-url="{{ url_for('inventory.update_hardware', asset_id=asset.id) }}">
          <i class="fa fa-edit"></i>
        </button>
        <button type="button"
                class="btn btn-sm btn-outline-danger delete-hardware-btn ms-1"
                data-id="{{ asset.id }}"
                data-delete-url="{{ url_for('inventory.delete_hardware', asset_id=asset.id) }}"
                data-name="{{ asset.asset_tag }}">
          <i class="fa fa-trash"></i>
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Create Modal -->
<div class="modal fade" id="hardwareCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <form id="hardware-create-form" action="{{ url_for('inventory.create_hardware') }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-plus-circle me-2"></i>{{ _('New Hardware Asset') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">{{ _('Asset Tag') }}</label>
              <input name="asset_tag" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Custom Serial') }}</label>
              <input name="custom_tag" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Serial Number') }}</label>
              <input name="serial_number" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Category') }}</label>
              <select name="category" class="form-select">
                <option value="">{{ _('Select...') }}</option>
                {% for item in categories %}
                  <option value="{{ item }}">{{ _(item) }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Type') }}</label>
              <select name="type" class="form-select">
                <option value="">{{ _('Select...') }}</option>
                {% for item in hardware_types %}
                  <option value="{{ item }}">{{ _(item) }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Manufacturer') }}</label>
              <input name="manufacturer" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Model') }}</label>
              <input name="model" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('CPU') }}</label>
              <input name="cpu" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('RAM') }}</label>
              <input name="ram_gb" class="form-control" placeholder="32 GB">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Storage') }}</label>
              <input name="storage" class="form-control" placeholder="1 TB SSD">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('GPU') }}</label>
              <input name="gpu" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Operating System') }}</label>
              <input name="operating_system" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Status') }}</label>
              <select name="status" class="form-select">
                <option value="">{{ _('Select...') }}</option>
                {% for item in statuses %}
                  <option value="{{ item }}">{{ _(item) }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Condition') }}</label>
              <select name="condition" class="form-select">
                <option value="">{{ _('Select...') }}</option>
                {% for item in conditions %}
                  <option value="{{ item }}">{{ _(item) }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Location') }}</label>
              <input name="location" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Rack/Room') }}</label>
              <input name="rack" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('IP Address') }}</label>
              <input name="ip_address" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('MAC Address') }}</label>
              <input name="mac_address" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Hostname') }}</label>
              <input name="hostname" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Purchase Date') }}</label>
              <input name="purchase_date" type="date" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Warranty End') }}</label>
              <input name="warranty_end" type="date" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Support Vendor') }}</label>
              <input name="support_vendor" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Support Contract') }}</label>
              <input name="support_contract" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Accessories') }}</label>
              <input name="accessories" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Power Supply') }}</label>
              <input name="power_supply" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('BIOS Version') }}</label>
              <input name="bios_version" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Firmware Version') }}</label>
              <input name="firmware_version" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Assigned To') }}</label>
              <select name="assigned_to" class="form-select">
                <option value="">{{ _('Unassigned') }}</option>
                {% for user in users %}
                  <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Assigned On') }}</label>
              <input name="assigned_on" type="date" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">{{ _('Notes') }}</label>
              <textarea name="notes" rows="3" class="form-control"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-success">
            <i class="fa fa-save"></i> {{ _('Save') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="hardwareEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <form id="hardware-edit-form" action="#" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-pen-to-square me-2"></i>{{ _('Edit Hardware Asset') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">{{ _('Asset Tag') }}</label>
              <input name="asset_tag" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Custom Serial') }}</label>
              <input name="custom_tag" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Serial Number') }}</label>
              <input name="serial_number" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Category') }}</label>
              <select name="category" class="form-select">
                <option value="">{{ _('Select...') }}</option>
                {% for item in categories %}
                  <option value="{{ item }}">{{ _(item) }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Type') }}</label>
              <select name="type" class="form-select">
                <option value="">{{ _('Select...') }}</option>
                {% for item in hardware_types %}
                  <option value="{{ item }}">{{ _(item) }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Manufacturer') }}</label>
              <input name="manufacturer" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Model') }}</label>
              <input name="model" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('CPU') }}</label>
              <input name="cpu" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('RAM') }}</label>
              <input name="ram_gb" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Storage') }}</label>
              <input name="storage" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('GPU') }}</label>
              <input name="gpu" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Operating System') }}</label>
              <input name="operating_system" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Status') }}</label>
              <select name="status" class="form-select">
                <option value="">{{ _('Select...') }}</option>
                {% for item in statuses %}
                  <option value="{{ item }}">{{ _(item) }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Condition') }}</label>
              <select name="condition" class="form-select">
                <option value="">{{ _('Select...') }}</option>
                {% for item in conditions %}
                  <option value="{{ item }}">{{ _(item) }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Location') }}</label>
              <input name="location" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Rack/Room') }}</label>
              <input name="rack" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('IP Address') }}</label>
              <input name="ip_address" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('MAC Address') }}</label>
              <input name="mac_address" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Hostname') }}</label>
              <input name="hostname" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Purchase Date') }}</label>
              <input name="purchase_date" type="date" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Warranty End') }}</label>
              <input name="warranty_end" type="date" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Support Vendor') }}</label>
              <input name="support_vendor" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Support Contract') }}</label>
              <input name="support_contract" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Accessories') }}</label>
              <input name="accessories" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Power Supply') }}</label>
              <input name="power_supply" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('BIOS Version') }}</label>
              <input name="bios_version" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">{{ _('Firmware Version') }}</label>
              <input name="firmware_version" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Assigned To') }}</label>
              <select name="assigned_to" class="form-select">
                <option value="">{{ _('Unassigned') }}</option>
                {% for user in users %}
                  <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">{{ _('Assigned On') }}</label>
              <input name="assigned_on" type="date" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">{{ _('Notes') }}</label>
              <textarea name="notes" rows="3" class="form-control"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-save"></i> {{ _('Update') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="hardwareDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="hardware-delete-form" action="#" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header modal-header-gradient text-white">
          <h5 class="modal-title"><i class="fa fa-trash me-2"></i>{{ _('Delete Hardware Asset') }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">{{ _('Are you sure you want to delete') }} <strong id="hardware-delete-name"></strong>?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-danger">
            <i class="fa fa-trash"></i> {{ _('Delete') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(function() {
  const hardwareTable = $('#hardwareTable').DataTable({
    order: [[0, 'asc']],
    pageLength: 25,
    language: { url: "{{ url_for('static', filename='datatables/' + g.locale + '.json') }}" },
    scrollX: true,
    scrollCollapse: true,
    autoWidth: false,
    dom: "<'row mb-2'<'col-md-6 d-flex align-items-center gap-2'lB><'col-md-6 text-end'f>>" +
         "<'row'<'col-sm-12'tr>>" +
         "<'row mt-3'<'col-12'Q>>" +
         "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
    buttons: [
      { extend: 'excelHtml5', text: '<i class=\"fa fa-file-excel\"></i> {{ _("Excel") }}', className: 'btn btn-success btn-sm mx-1' },
      { extend: 'print', text: '<i class=\"fa fa-print\"></i> {{ _("Print") }}', className: 'btn btn-secondary btn-sm mx-1' },
      { extend: 'searchBuilder', text: '<i class=\"fa fa-filter\"></i> {{ _("Advanced Filters") }}', className: 'btn btn-secondary btn-sm mx-1' }
    ],
    columnDefs: [
      { targets: [19, 20, 23], type: 'date', searchBuilderType: 'date' }
    ],
    searchBuilder: {
      columns: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27]
    }
  });

  function submitForm($form, modalId) {
    const submitBtn = $form.find('button[type="submit"]');
    const originalHtml = submitBtn.html();
    submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> {{ _("Saving...") }}');

    $.ajax({
      url: $form.attr('action'),
      type: 'POST',
      data: $form.serialize(),
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function(res) {
        if (!res || res.success === false) {
          const msg = (res && res.message) ? res.message : '❌ {{ _("Unexpected error while saving.") }}';
          const category = (res && res.category) ? res.category : 'danger';
          showToast(msg, category);
          submitBtn.prop('disabled', false).html(originalHtml);
          return;
        }
        if (modalId) {
          const modalEl = document.getElementById(modalId);
          if (modalEl) {
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) modalInstance.hide();
          }
        }
        showToast(res.message || '{{ _("Operation completed successfully") }}', res.category || 'success');
        setTimeout(() => window.location.reload(), 400);
      },
      error: function(xhr) {
        const data = xhr.responseJSON || {};
        const msg = data.message || '❌ {{ _("Unexpected error while saving.") }}';
        const category = data.category || 'danger';
        showToast(msg, category);
        submitBtn.prop('disabled', false).html(originalHtml);
      }
    });
  }

  $('#hardware-create-form').on('submit', function(e) {
    e.preventDefault();
    submitForm($(this), 'hardwareCreateModal');
  });

  $('#hardware-edit-form').on('submit', function(e) {
    e.preventDefault();
    submitForm($(this), 'hardwareEditModal');
  });

  $('#hardware-delete-form').on('submit', function(e) {
    e.preventDefault();
    submitForm($(this), 'hardwareDeleteModal');
  });

  const hardCreate = document.getElementById('hardwareCreateModal');
  if (hardCreate) {
    hardCreate.addEventListener('hidden.bs.modal', function() {
      const form = this.querySelector('form');
      if (form) form.reset();
    });
  }

  function populateHardwareForm(asset, updateUrl) {
    const form = $('#hardware-edit-form');
    form.attr('action', updateUrl);
    form.find('[name="asset_tag"]').val(asset.asset_tag);
    form.find('[name="custom_tag"]').val(asset.custom_tag);
    form.find('[name="serial_number"]').val(asset.serial_number);
    form.find('[name="category"]').val(asset.category);
    form.find('[name="type"]').val(asset.type);
    form.find('[name="manufacturer"]').val(asset.manufacturer);
    form.find('[name="model"]').val(asset.model);
    form.find('[name="cpu"]').val(asset.cpu);
    form.find('[name="ram_gb"]').val(asset.ram_gb);
    form.find('[name="storage"]').val(asset.storage);
    form.find('[name="gpu"]').val(asset.gpu);
    form.find('[name="operating_system"]').val(asset.operating_system);
    form.find('[name="status"]').val(asset.status);
    form.find('[name="condition"]').val(asset.condition);
    form.find('[name="location"]').val(asset.location);
    form.find('[name="rack"]').val(asset.rack);
    form.find('[name="ip_address"]').val(asset.ip_address);
    form.find('[name="mac_address"]').val(asset.mac_address);
    form.find('[name="hostname"]').val(asset.hostname);
    form.find('[name="purchase_date"]').val(asset.purchase_date);
    form.find('[name="warranty_end"]').val(asset.warranty_end);
    form.find('[name="support_vendor"]').val(asset.support_vendor);
    form.find('[name="support_contract"]').val(asset.support_contract);
    form.find('[name="accessories"]').val(asset.accessories);
    form.find('[name="power_supply"]').val(asset.power_supply);
    form.find('[name="bios_version"]').val(asset.bios_version);
    form.find('[name="firmware_version"]').val(asset.firmware_version);
    form.find('[name="assigned_to"]').val(asset.assigned_to || '');
    form.find('[name="assigned_on"]').val(asset.assigned_on);
    form.find('[name="notes"]').val(asset.notes);
  }

  function openHardwareEdit(btn) {
    const assetId = btn.data('id');
    if (!assetId) return;
    $.get(`/inventory/hardware/${assetId}/details`, function(res) {
      if (!res.success) {
        showToast(res.message || '{{ _("Failed to load hardware asset") }}', res.category || 'danger');
        return;
      }
      populateHardwareForm(res.asset, btn.data('update-url'));
      const modal = new bootstrap.Modal(document.getElementById('hardwareEditModal'));
      modal.show();
    }).fail(() => {
      showToast('{{ _("Failed to load hardware asset.") }}', 'danger');
    });
  }

  $(document).on('click', '.edit-hardware-btn', function() {
    openHardwareEdit($(this));
  });

  $('#hardwareTable tbody').on('dblclick', 'tr', function() {
    const btn = $(this).find('.edit-hardware-btn');
    if (btn.length) {
      openHardwareEdit(btn);
    }
  });

  $(document).on('click', '.delete-hardware-btn', function() {
    const btn = $(this);
    const modalEl = document.getElementById('hardwareDeleteModal');
    const modal = new bootstrap.Modal(modalEl);
    $('#hardware-delete-form').attr('action', btn.data('delete-url'));
    $('#hardware-delete-name').text(btn.data('name'));
    modal.show();
  });
});
</script>

{% endblock %}
