<!doctype html>
<html lang="{{ g.locale or 'en' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ _('Task Scheduler') }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
      body {
        min-height: 100vh;
        background: radial-gradient(circle at top, rgba(13,110,253,0.15), transparent 60%), #0f172a;
        color: #0f172a;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
      }
      .share-shell {
        max-width: 720px;
        width: 100%;
      }
      .share-card {
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.3);
        box-shadow: 0 1.5rem 3rem rgba(15, 23, 42, 0.35);
        background: rgba(255, 255, 255, 0.98);
      }
      .share-card.dark {
        background: rgba(15, 23, 42, 0.85);
        color: #e2e8f0;
      }
      .badge-soft {
        border-radius: 999px;
        padding: 0.25rem 0.7rem;
        font-size: 0.75rem;
      }
      .slot-list {
        max-height: 220px;
        overflow-y: auto;
      }
      .slot-list .slot-entry {
        color: #f8fafc;
        border-bottom: 1px solid rgba(248, 250, 252, 0.15);
      }
      .slot-list .slot-entry .slot-time {
        color: rgba(248, 250, 252, 0.9);
      }
      .upcoming-title {
        color: #f8fafc;
      }
    </style>
  </head>
  <body>
    {% set page_csrf = csrf_token() %}
    {% set task_closed = task.status == 'Closed' %}
    <div class="share-shell">
      <div class="share-card dark p-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
          <div>
            <h1 class="h4 mb-1">{{ task.title }}</h1>
            <p class="text-white-75 mb-0">{{ _('Estimated duration') }}: <strong>{{ task.estimated_duration_label }}</strong></p>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <span class="badge-soft bg-{{ 'success' if task.status == 'Shared' else 'secondary' }}-subtle text-{{ 'success' if task.status == 'Shared' else 'secondary' }}-emphasis">
              {% if task.status == 'Shared' %}
                {{ _('Shared') }}
              {% else %}
                {{ _('Closed') }}
              {% endif %}
            </span>
            <span class="badge-soft bg-info-subtle text-info-emphasis">
              {% if share_token.visibility == 'public' %}
                <i class="fa fa-earth-americas"></i> {{ _('Public') }}
              {% else %}
                <i class="fa fa-lock"></i> {{ _('Login required') }}
              {% endif %}
            </span>
          </div>
        </div>
        <div class="mb-3">
          {% if task.description %}
            <div class="small text-white-75">{{ task.description|safe }}</div>
          {% else %}
            <div class="small text-white-50">{{ _('No description supplied.') }}</div>
          {% endif %}
        </div>

        {% if inactive_message %}
          <div class="alert alert-warning mb-0">
            <i class="fa fa-triangle-exclamation"></i> {{ inactive_message }}
          </div>
        {% elif task_closed %}
          <div class="alert alert-danger mb-4">
            <i class="fa fa-circle-xmark"></i> {{ _('This task is closed. Submissions are no longer accepted.') }}
          </div>
        {% else %}
          <div id="shareAlert" class="alert d-none mb-3"></div>
          <form id="shareSlotForm" method="post" action="{{ url_for('task_scheduler.share_slot_create', token=share_token.token) }}" class="row g-3">
            <input type="hidden" name="csrf_token" value="{{ page_csrf }}">
            <div class="col-12">
              <label class="form-label">{{ _('Your name') }}</label>
              <input type="text" class="form-control" name="username" placeholder="John Doe" required>
            </div>
            <div class="col-md-7">
              <label class="form-label">{{ _('Preferred start (Europe/Athens)') }}</label>
              <input type="datetime-local" class="form-control" name="start_at" id="publicSlotStart" required>
            </div>
            <div class="col-md-5">
              <label class="form-label">{{ _('Comment (optional)') }}</label>
              <input type="text" class="form-control" name="comment" placeholder="{{ _('Short note') }}">
            </div>
            <div class="col-12">
              <div id="publicSlotMessage" class="small text-muted"></div>
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100">
                <i class="fa fa-check"></i> {{ _('Reserve slot') }}
              </button>
            </div>
          </form>
        {% endif %}

        <hr class="my-4">
        <div>
          <h2 class="h6 text-uppercase upcoming-title">{{ _('Upcoming slots') }}</h2>
          {% set upcoming = task.slots|sort(attribute='start_at') %}
          {% if upcoming %}
            <div class="slot-list mt-2">
              {% for slot in upcoming[:5] %}
                <div class="d-flex justify-content-between align-items-center slot-entry py-2">
                  <span>{{ slot.display_name }}</span>
                  <span class="slot-time small">{{ format_local(slot.start_at) }}</span>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted small mb-0">{{ _('No bookings yet.') }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
      const shareConfig = {
        checkUrl: "{{ url_for('task_scheduler.share_slot_check', token=share_token.token) }}",
        submitUrl: "{{ url_for('task_scheduler.share_slot_create', token=share_token.token) }}"
      };

      function showShareAlert(message, category) {
        const alertEl = document.getElementById('shareAlert');
        if (!alertEl) return;
        alertEl.className = 'alert alert-' + (category || 'info');
        alertEl.textContent = message;
        alertEl.classList.remove('d-none');
      }

      function setMessage(text, type) {
        const el = document.getElementById('publicSlotMessage');
        if (!el) return;
        el.className = 'small';
        if (type) el.classList.add('text-' + type);
        el.textContent = text;
      }

      document.addEventListener('DOMContentLoaded', function() {
        const startInput = document.getElementById('publicSlotStart');
        if (startInput) {
          startInput.addEventListener('change', function() {
            if (!this.value) return;
            setMessage('{{ _("Checking availability...") }}', 'muted');
            $.get(shareConfig.checkUrl, { start_at: this.value })
              .done(res => setMessage(res.message, 'success'))
              .fail(xhr => {
                const res = xhr.responseJSON || {};
                let text = res.message || '{{ _("Slot unavailable.") }}';
                if (res.suggestions && res.suggestions.length) {
                  text += ' {{ _("Try:") }} ' + res.suggestions.join(', ');
                }
                setMessage(text, 'danger');
              });
          });
        }

        const form = document.getElementById('shareSlotForm');
        if (form) {
          form.addEventListener('submit', function(ev) {
            ev.preventDefault();
            const formData = $(form).serialize();
            $.ajax({
              url: shareConfig.submitUrl,
              type: 'POST',
              data: formData,
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              success(res) {
                showShareAlert(res.message || '{{ _("Slot confirmed.") }}', 'success');
                form.reset();
                setMessage('', '');
              },
              error(xhr) {
                const res = xhr.responseJSON || {};
                let text = res.message || '{{ _("Submission failed.") }}';
                if (res.suggestions && res.suggestions.length) {
                  text += ' {{ _("Try:") }} ' + res.suggestions.join(', ');
                }
                showShareAlert(text, 'danger');
              }
            });
          });
        }
      });
    </script>
  </body>
</html>
