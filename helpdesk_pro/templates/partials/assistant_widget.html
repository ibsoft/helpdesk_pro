{% set cfg = assistant_widget_config %}
<style>
  .assistant-widget {
    position: fixed;
    bottom: 24px;
    z-index: 1080;
    display: flex;
    flex-direction: column-reverse;
    align-items: flex-end;
    gap: 0.75rem;
    pointer-events: none;
  }
  .assistant-widget.assistant-pos-left {
    left: 1.5rem;
    align-items: flex-start;
  }
  .assistant-widget.assistant-pos-right {
    right: 1.5rem;
  }
  .assistant-widget .assistant-fab {
    width: 58px;
    height: 58px;
    border-radius: 29px 29px 8px 29px;
    font-size: 1.4rem;
    box-shadow: 0 12px 24px rgba(13,110,253,0.25);
    pointer-events: auto;
  }
  .assistant-widget.assistant-pos-left .assistant-fab {
    border-radius: 29px 8px 29px 29px;
  }
  .assistant-panel {
    width: min(360px, 95vw);
    max-height: var(--assistant-max-height, 70vh);
    display: flex;
    flex-direction: column;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 18px 36px rgba(15, 23, 42, 0.25);
    pointer-events: auto;
    transform: translateY(20px);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s ease, transform 0.25s ease, visibility 0.25s;
  }
  .assistant-widget.assistant-open .assistant-panel {
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
  }
  .assistant-widget.assistant-fullscreen {
    position: fixed;
    inset: 0;
    margin: 0;
    width: 100vw;
    height: 100vh;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 1090;
    background: rgba(15, 23, 42, 0.25);
    backdrop-filter: blur(10px);
  }
  .assistant-widget.assistant-fullscreen .assistant-panel {
    width: min(720px, 96vw);
    height: min(92vh, 720px);
    max-height: none;
    margin-top: 1.5rem;
  }
  .assistant-widget.assistant-fullscreen .assistant-messages {
    flex: 1 1 auto;
  }
  .assistant-messages {
    flex: 1 1 auto;
    padding: 1rem;
    overflow-y: auto;
    background: rgba(15, 23, 42, 0.03);
  }
  html[data-bs-theme="dark"] body .assistant-messages {
    background: rgba(15, 23, 42, 0.7);
  }
  .assistant-message {
    max-width: 90%;
    margin-bottom: 0.75rem;
    padding: 0.6rem 0.9rem;
    border-radius: 0.85rem;
    line-height: 1.45;
    font-size: 0.95rem;
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
  }
  .assistant-message-user {
    margin-left: auto;
    background: linear-gradient(135deg, #6366f1, #3b82f6);
    color: #fff;
  }
  .assistant-message-assistant {
    background: #ffffff;
    border: 1px solid rgba(148, 163, 184, 0.25);
  }
  html[data-bs-theme="dark"] body .assistant-message-assistant {
    background: rgba(15, 23, 42, 0.85);
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.35);
  }
  .assistant-message-system {
    font-size: 0.85rem;
    color: #475569;
    background: transparent;
    box-shadow: none;
    border: none;
    text-align: center;
  }
  .assistant-message {
    position: relative;
  }
  .assistant-message .assistant-message-inner {
    display: block;
  }
  .assistant-message .assistant-copy-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    color: #475569;
    background: rgba(255, 255, 255, 0.85);
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.18);
    opacity: 0.25;
    transform: translateY(-4px);
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  html[data-bs-theme="dark"] body .assistant-message .assistant-copy-btn {
    background: rgba(30, 41, 59, 0.85);
    color: #cbd5f5;
  }
  .assistant-message:hover .assistant-copy-btn,
  .assistant-message:focus-within .assistant-copy-btn {
    opacity: 1;
    transform: translateY(0);
  }
  .assistant-message .assistant-copy-btn.copied {
    color: #22c55e;
  }
  .assistant-form {
    display: flex;
    gap: 0.5rem;
    align-items: stretch;
  }
  .assistant-form textarea {
    resize: none;
    min-height: 90px;
    background: rgba(15, 23, 42, 0.03);
    border-radius: 0.85rem;
    border: 1px solid rgba(148,163,184,0.4);
  }
  html[data-bs-theme="dark"] body .assistant-form textarea {
    background: rgba(15, 23, 42, 0.6);
    color: #e2e8f0;
    border-color: rgba(148,163,184,0.35);
  }
  .assistant-input-actions {
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
  }
  .assistant-input-actions .btn {
    width: 46px;
    height: 46px;
    border-radius: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18);
  }
  .assistant-mic-btn {
    background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(99,102,241,0.25));
    color: #1e293b;
    border: 1px solid rgba(99,102,241,0.35);
  }
  .assistant-mic-btn.active {
    background: linear-gradient(135deg, rgba(34,197,94,0.85), rgba(16,185,129,0.85));
    color: #ffffff;
  }
  html[data-bs-theme="dark"] body .assistant-mic-btn {
    color: #e2e8f0;
    border-color: rgba(165,180,252,0.35);
  }
  .assistant-mic-btn.assistant-mic-btn-disabled {
    background: linear-gradient(135deg, rgba(148,163,184,0.15), rgba(148,163,184,0.25));
    color: #475569;
    border-color: rgba(148,163,184,0.35);
  }
  html[data-bs-theme="dark"] body .assistant-mic-btn.assistant-mic-btn-disabled {
    color: #94a3b8;
    border-color: rgba(71,85,105,0.45);
  }
  .assistant-spinner {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.85rem;
    color: #64748b;
  }
  html[data-bs-theme="dark"] body .assistant-spinner {
    color: #cbd5f5;
  }
  .assistant-badge {
    position: absolute;
    top: -6px;
    right: -6px;
  }
  .assistant-documents {
    border: 1px dashed rgba(148, 163, 184, 0.45);
    border-radius: 0.85rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    background: rgba(148, 163, 184, 0.1);
  }
  html[data-bs-theme="dark"] body .assistant-documents {
    border-color: rgba(148, 163, 184, 0.35);
    background: rgba(30, 41, 59, 0.35);
  }
  .assistant-documents.d-none {
    display: none !important;
  }
  .assistant-documents-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    color: #334155;
  }
  html[data-bs-theme="dark"] body .assistant-documents-header {
    color: #cbd5f5;
  }
  .assistant-document-list {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    max-height: 120px;
    overflow-y: auto;
  }
  .assistant-document-pill {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.6rem;
    padding: 0.45rem 0.7rem;
    border-radius: 0.7rem;
    background: rgba(255, 255, 255, 0.65);
    border: 1px solid rgba(148, 163, 184, 0.35);
    font-size: 0.85rem;
  }
  html[data-bs-theme="dark"] body .assistant-document-pill {
    background: rgba(15, 23, 42, 0.7);
    border-color: rgba(148, 163, 184, 0.3);
    color: #e2e8f0;
  }
  .assistant-document-name {
    flex: 1 1 auto;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .assistant-document-actions {
    display: inline-flex;
    gap: 0.35rem;
  }
  .assistant-document-actions .btn-icon {
    width: 28px;
    height: 28px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: rgba(99, 102, 241, 0.1);
    color: #4338ca;
  }
  html[data-bs-theme="dark"] body .assistant-document-actions .btn-icon {
    background: rgba(79, 70, 229, 0.35);
    color: #cbd5f5;
  }
  .assistant-document-status {
    font-size: 0.75rem;
    padding: 0.15rem 0.45rem;
    border-radius: 999px;
    background: rgba(34, 197, 94, 0.15);
    color: #166534;
    border: 1px solid rgba(34, 197, 94, 0.25);
    margin-right: 0.4rem;
  }
  html[data-bs-theme="dark"] body .assistant-document-status {
    color: #bbf7d0;
    background: rgba(22, 101, 52, 0.4);
    border-color: rgba(22, 101, 52, 0.35);
  }
  .assistant-document-status.pending {
    background: rgba(251, 191, 36, 0.15);
    color: #b45309;
    border-color: rgba(251, 191, 36, 0.35);
  }
  html[data-bs-theme="dark"] body .assistant-document-status.pending {
    color: #fde68a;
    background: rgba(180, 83, 9, 0.4);
    border-color: rgba(180, 83, 9, 0.4);
  }
  .assistant-upload-btn {
    background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(168, 85, 247, 0.2));
    color: #6b21a8;
    border: 1px solid rgba(168, 85, 247, 0.35);
  }
  html[data-bs-theme="dark"] body .assistant-upload-btn {
    color: #f5d0fe;
    border-color: rgba(192, 132, 252, 0.45);
  }
  .assistant-upload-btn.loading i {
    animation: assistant-rotate 1.2s linear infinite;
  }
  @keyframes assistant-rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  :root { --assistant-top-safety: 0.5cm; }
  .assistant-panel { max-height: calc(var(--assistant-max-height, 70vh) - var(--assistant-top-safety)); }

</style>

<div class="assistant-widget assistant-pos-{{ cfg.position }}" id="assistantWidgetRoot" data-provider="{{ cfg.provider }}">
  <button type="button" class="btn btn-danger assistant-fab position-relative" id="assistantToggle" aria-label="{{ cfg.button_label }}" title="{{ cfg.button_label }}">
    <i class="fa fa-comments"></i>
    <span class="badge bg-danger rounded-pill assistant-badge d-none" id="assistantUnreadBadge">1</span>
  </button>

  <div class="assistant-panel card" id="assistantPanel" aria-hidden="true">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <strong><i class="fa fa-robot text-primary"></i> {{ cfg.window_title }}</strong>
      </div>
      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-light" id="assistantFullscreenToggle" aria-label="{{ _('Toggle full screen') }}">
          <i class="fa fa-up-right-and-down-left-from-center"></i>
        </button>
        <button type="button" class="btn btn-light" id="assistantClose">
          <i class="fa fa-xmark"></i>
        </button>
      </div>
    </div>
    <div class="assistant-messages" id="assistantMessages">
      {% if cfg.welcome_message %}
        <div class="assistant-message assistant-message-assistant" data-raw="{{ cfg.welcome_message }}">
          <div class="assistant-message-inner">{{ cfg.welcome_message }}</div>
          <button type="button" class="assistant-copy-btn" aria-label="{{ _('Copy message') }}">
            <i class="fa fa-copy"></i>
          </button>
        </div>
      {% endif %}
    </div>
    <div class="card-footer">
      <div class="assistant-documents d-none" id="assistantDocuments">
        <div class="assistant-documents-header">
          <span><i class="fa fa-paperclip me-1"></i> {{ _('Attached documents') }}</span>
          <small class="text-muted">{{ _('Used as knowledge for this chat.') }}</small>
        </div>
        <div class="assistant-document-list" id="assistantDocumentList"></div>
      </div>
      <form class="assistant-form" id="assistantForm">
        <textarea class="form-control" placeholder="{{ _('Type your message...') }}" id="assistantInput"></textarea>
        <div class="assistant-input-actions">
          <label class="btn assistant-upload-btn" id="assistantUploadLabel" aria-label="{{ _('Attach document') }}" title="{{ _('Attach document') }}">
            <i class="fa fa-paperclip"></i>
            <input type="file" id="assistantFileInput" class="d-none" />
          </label>
          <button type="button" class="btn assistant-mic-btn" id="assistantMic" aria-label="{{ _('Start voice input') }}" title="{{ _('Start voice input (GR → EN fallback)') }}">
            <i class="fa fa-microphone"></i>
          </button>
          <button type="submit" class="btn btn-primary" id="assistantSend" aria-label="{{ _('Send message') }}">
            <i class="fa fa-paper-plane"></i>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function() {
  const config = {{ cfg|tojson }};
  const root = document.getElementById("assistantWidgetRoot");
  const panel = document.getElementById("assistantPanel");
  const toggleBtn = document.getElementById("assistantToggle");
  const closeBtn = document.getElementById("assistantClose");
  const fullscreenBtn = document.getElementById("assistantFullscreenToggle");
  const form = document.getElementById("assistantForm");
  const input = document.getElementById("assistantInput");
  const messagesEl = document.getElementById("assistantMessages");
  const sendBtn = document.getElementById("assistantSend");
  const unreadBadge = document.getElementById("assistantUnreadBadge");
  const micBtn = document.getElementById("assistantMic");
  const documentsSection = document.getElementById("assistantDocuments");
  const documentListEl = document.getElementById("assistantDocumentList");
  const fileInput = document.getElementById("assistantFileInput");
  const uploadLabel = document.getElementById("assistantUploadLabel");

  const copyButtonLabel = "{{ _('Copy message') }}";
  const copySuccessLabel = "{{ _('Copied!') }}";
  const speechNotSupportedLabel = "{{ _('Speech recognition is not supported in this browser.') }}";
  const speechStartLabel = "{{ _('Start voice input (GR → EN fallback)') }}";
  const speechStopLabel = "{{ _('Stop listening') }}";

  if (!root || !form) return;

  function updatePanelOffset() {
    const nav = document.querySelector(".navbar");
    const navHeight = nav ? nav.offsetHeight : 64;
    const available = Math.max(240, window.innerHeight - navHeight - 72);
    document.documentElement.style.setProperty("--assistant-max-height", `${available}px`);
  }
  updatePanelOffset();
  window.addEventListener("resize", updatePanelOffset);

  const escapeHTML = (value) => (value || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const escapeAttribute = (value) => (value || '')
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const renderAssistantContent = (value) => {
    const escaped = escapeHTML(value || '');
    const withMarkdownLinks = escaped.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (_, text, url) => {
      const cleanUrl = url.replace(/&amp;/g, '&');
      return `<a href="${escapeAttribute(cleanUrl)}" target="_blank" rel="noopener">${text}</a>`;
    });
    const withAngleLinks = withMarkdownLinks.replace(/&lt;(https?:\/\/[^&\s]+(?:&amp;[^\s;]+)*)&gt;/g, (_, url) => {
      const cleanUrl = url.replace(/&amp;/g, '&');
      const display = cleanUrl.replace(/&/g, '&amp;');
      return `<a href="${escapeAttribute(cleanUrl)}" target="_blank" rel="noopener">${display}</a>`;
    });
    return withAngleLinks.replace(/\n/g, "<br>");
  };

  const plainText = (value) => {
    const temp = document.createElement("div");
    temp.innerHTML = value;
    return temp.textContent || temp.innerText || "";
  };

  function handleCopy(bubble, button) {
    const raw = bubble?.dataset?.raw || "";
    const text = raw || plainText(bubble.querySelector(".assistant-message-inner")?.innerHTML || "");
    if (!text) return;

    const setCopiedState = () => {
      button.classList.add("copied");
      const originalHTML = button.dataset.icon || button.innerHTML;
      button.dataset.icon = originalHTML;
      button.innerHTML = '<i class="fa fa-check"></i>';
      button.setAttribute("title", copySuccessLabel);
      setTimeout(() => {
        button.classList.remove("copied");
        button.innerHTML = button.dataset.icon;
        button.setAttribute("title", copyButtonLabel);
      }, 1600);
      showToast(copySuccessLabel, "success");
    };

    if (navigator.clipboard?.writeText) {
      navigator.clipboard.writeText(text).then(setCopiedState).catch(() => {
        showToast("{{ _('Clipboard copy failed. Try again manually.') }}", "warning");
      });
    } else {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.setAttribute("readonly", "true");
      textarea.style.position = "absolute";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
        setCopiedState();
      } catch (err) {
        showToast("{{ _('Clipboard copy failed. Try again manually.') }}", "warning");
      }
      document.body.removeChild(textarea);
    }
  }

  function createCopyButton(bubble) {
    const button = document.createElement("button");
    button.type = "button";
    button.className = "assistant-copy-btn";
    button.innerHTML = '<i class="fa fa-copy"></i>';
    button.setAttribute("aria-label", copyButtonLabel);
    button.setAttribute("title", copyButtonLabel);
    button.addEventListener("click", (event) => {
      event.stopPropagation();
      handleCopy(bubble, button);
    });
    return button;
  }

  let currentSession = null;
  let history = [];
  let isOpen = false;
  let isFullscreen = false;
  let pending = false;
  let sessionReadyPromise = null;

  function toggle(open) {
    isOpen = typeof open === "boolean" ? open : !isOpen;
    root.classList.toggle("assistant-open", isOpen);
    panel.setAttribute("aria-hidden", isOpen ? "false" : "true");
    if (isOpen) {
      unreadBadge.classList.add("d-none");
      setTimeout(() => input.focus(), 150);
    }
  }

  function setUploadLoading(state) {
    if (!uploadLabel) return;
    uploadLabel.classList.toggle("loading", !!state);
  }

  function renderMessages(messages) {
    if (!messagesEl) return;
    messagesEl.innerHTML = "";
    const list = Array.isArray(messages) ? messages : [];
    if (!list.length) {
      if (config.welcome_message) {
        appendMessage("assistant", config.welcome_message, { copyText: config.welcome_message });
      }
      return;
    }
    list.forEach((msg) => {
      appendMessage(msg.role, msg.content, { copyText: msg.content });
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function renderDocuments(documents) {
    if (!documentsSection || !documentListEl) return;
    const list = Array.isArray(documents) ? documents : [];
    if (!list.length) {
      documentsSection.classList.add("d-none");
      documentListEl.innerHTML = "";
      return;
    }
    documentsSection.classList.remove("d-none");
    documentListEl.innerHTML = "";
    list.forEach((doc) => {
      const row = document.createElement("div");
      row.className = "assistant-document-pill";
      row.dataset.documentId = doc.id;

      const left = document.createElement("div");
      left.className = "d-flex align-items-center flex-grow-1 gap-2 overflow-hidden";

      const status = document.createElement("span");
      status.className = "assistant-document-status" + (doc.status && doc.status !== "ready" ? " pending" : "");
      status.textContent = (doc.status || "ready").replace(/_/g, " ").toUpperCase();

      const name = document.createElement("span");
      name.className = "assistant-document-name";
      name.textContent = doc.filename || "{{ _('Document') }}";

      left.appendChild(status);
      left.appendChild(name);
      row.appendChild(left);

      const actions = document.createElement("div");
      actions.className = "assistant-document-actions";

      if (doc.download_url) {
        const downloadLink = document.createElement("a");
        downloadLink.href = doc.download_url;
        downloadLink.className = "btn-icon";
        downloadLink.target = "_blank";
        downloadLink.rel = "noopener";
        downloadLink.setAttribute("aria-label", "{{ _('Download') }}");
        downloadLink.innerHTML = '<i class="fa fa-arrow-down"></i>';
        actions.appendChild(downloadLink);
      }

      const deleteBtn = document.createElement("button");
      deleteBtn.type = "button";
      deleteBtn.className = "btn-icon";
      deleteBtn.dataset.action = "delete";
      deleteBtn.dataset.documentId = doc.id;
      deleteBtn.setAttribute("aria-label", "{{ _('Remove document') }}");
      deleteBtn.innerHTML = '<i class="fa fa-trash"></i>';
      actions.appendChild(deleteBtn);

      row.appendChild(actions);
      documentListEl.appendChild(row);
    });
  }

  function updateFromSessionPayload(payload) {
    if (!payload) {
      return;
    }
    currentSession = payload;
    const messages = Array.isArray(payload.messages) ? payload.messages : [];
    history = messages.map(({ role, content }) => ({ role, content }));
    renderMessages(messages);
    renderDocuments(payload.documents);
  }

  function bootstrapSession(sessionId) {
    const body = sessionId ? { session_id: sessionId } : {};
    sessionReadyPromise = fetch("{{ url_for('assistant.api_create_or_fetch_session') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    })
      .then((resp) => resp.json())
      .then((data) => {
        if (!data.success) {
          showToast(data.message || "{{ _('Unable to start session.') }}", "danger");
          return;
        }
        updateFromSessionPayload(data.session);
      })
      .catch(() => {
        showToast("{{ _('Unable to start session.') }}", "danger");
      });
    return sessionReadyPromise;
  }

  function ensureSessionReady() {
    if (currentSession) {
      return Promise.resolve();
    }
    return sessionReadyPromise || bootstrapSession();
  }

  function updateFullscreenButton() {
    if (!fullscreenBtn) return;
    if (isFullscreen) {
      fullscreenBtn.innerHTML = '<i class="fa fa-down-left-and-up-right-to-center"></i>';
      fullscreenBtn.setAttribute("aria-label", "{{ _('Exit full screen') }}");
      fullscreenBtn.setAttribute("title", "{{ _('Exit full screen') }}");
    } else {
      fullscreenBtn.innerHTML = '<i class="fa fa-up-right-and-down-left-from-center"></i>';
      fullscreenBtn.setAttribute("aria-label", "{{ _('Enter full screen') }}");
      fullscreenBtn.setAttribute("title", "{{ _('Enter full screen') }}");
    }
  }

  function toggleFullscreen(forceState) {
    isFullscreen = typeof forceState === "boolean" ? forceState : !isFullscreen;
    if (isFullscreen && !isOpen) {
      toggle(true);
    }
    root.classList.toggle("assistant-fullscreen", isFullscreen);
    updateFullscreenButton();
  }

  function appendMessage(role, content, options = {}) {
    const bubble = document.createElement("div");
    if (role === "user") {
      bubble.className = "assistant-message assistant-message-user";
    } else if (role === "assistant") {
      bubble.className = "assistant-message assistant-message-assistant";
    } else {
      bubble.className = "assistant-message assistant-message-system";
    }

    bubble.dataset.role = role;
    const rawValue = typeof options.copyText === "string"
      ? options.copyText
      : typeof content === "string"
        ? content
        : "";
    if (rawValue) {
      bubble.dataset.raw = rawValue;
    }

    const inner = document.createElement("div");
    inner.className = "assistant-message-inner";
    inner.innerHTML = options.spinner
      ? `<span class="assistant-spinner"><span class="spinner-border spinner-border-sm"></span> ${escapeHTML(content)}</span>`
      : renderAssistantContent(content);
    bubble.appendChild(inner);

    if (!options.spinner && role !== "system") {
      bubble.appendChild(createCopyButton(bubble));
    }

    messagesEl.appendChild(bubble);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return bubble;
  }

  async function submitMessage(message) {
    if (!message || pending) return;
    await ensureSessionReady();
    if (!currentSession) {
      showToast("{{ _('Session not ready yet.') }}", "warning");
      return;
    }
    pending = true;
    sendBtn.disabled = true;
    input.value = "";

    appendMessage("user", message, { copyText: message });
    const waitingIndicator = appendMessage("assistant", "{{ _('Thinking...') }}", { spinner: true });

    try {
      const response = await fetch("{{ url_for('assistant.api_message') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, session_id: currentSession.id }),
      });
      const data = await response.json();
      waitingIndicator.remove();
      if (!response.ok || !data.success) {
        showToast(data.message || "{{ _('Assistant error') }}", "danger");
        renderMessages(history);
        return;
      }
      if (data.session) {
        updateFromSessionPayload(data.session);
      } else if (Array.isArray(data.history)) {
        history = data.history;
        renderMessages(history);
      }
      if (!isOpen) {
        unreadBadge.classList.remove("d-none");
      }
    } catch (error) {
      waitingIndicator.remove();
      showToast("{{ _('Connection error') }}", "danger");
      renderMessages(history);
    } finally {
      pending = false;
      sendBtn.disabled = false;
    }
  }

  toggleBtn.addEventListener("click", () => toggle(true));
  closeBtn.addEventListener("click", () => {
    if (isFullscreen) {
      toggleFullscreen(false);
    }
    toggle(false);
  });
  if (fullscreenBtn) {
    fullscreenBtn.addEventListener("click", () => toggleFullscreen());
    updateFullscreenButton();
  }

  form.addEventListener("submit", (event) => {
    event.preventDefault();
    const message = input.value.trim();
    submitMessage(message);
  });

  input.addEventListener("keydown", (event) => {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      submitMessage(input.value.trim());
    }
  });

  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && (isOpen || isFullscreen)) {
      if (isFullscreen) {
        toggleFullscreen(false);
      } else if (isOpen) {
        toggle(false);
      }
    }
  });

  if (fileInput) {
    fileInput.addEventListener("change", (event) => {
      const file = event.target.files && event.target.files[0];
      if (!file) {
        return;
      }
      ensureSessionReady().then(() => {
        if (!currentSession) {
          showToast("{{ _('Session not ready yet.') }}", "warning");
          setUploadLoading(false);
          return;
        }
        setUploadLoading(true);
        const formData = new FormData();
        formData.append("file", file);
        fetch(`{{ url_for('assistant.api_upload_document', session_id=0) }}`.replace("0", currentSession.id), {
          method: "POST",
          body: formData,
        })
          .then((resp) => resp.json())
          .then((data) => {
            if (!data.success) {
              showToast(data.message || "{{ _('Upload failed.') }}", "danger");
              return;
            }
            if (!currentSession) {
              currentSession = { documents: [] };
            }
            currentSession.documents = currentSession.documents || [];
            currentSession.documents = [
              ...currentSession.documents.filter((doc) => doc.id !== data.document.id),
              data.document,
            ];
            renderDocuments(currentSession.documents);
          })
          .catch(() => {
            showToast("{{ _('Upload failed.') }}", "danger");
          })
          .finally(() => {
            fileInput.value = "";
            setUploadLoading(false);
          });
      });
    });
  }

  if (documentListEl) {
    documentListEl.addEventListener("click", (event) => {
      const target = event.target.closest("[data-action]");
      if (!target) return;
      const action = target.dataset.action;
      const documentId = Number(target.dataset.documentId);
      if (!documentId || !currentSession) {
        return;
      }
      if (action === "delete") {
        fetch(
          `{{ url_for('assistant.api_delete_document', session_id=0, document_id=0) }}`.replace(
            "0/0",
            `${currentSession.id}/${documentId}`,
          ),
          { method: "DELETE" },
        )
          .then((resp) => resp.json())
          .then((data) => {
            if (!data.success) {
              showToast(data.message || "{{ _('Unable to remove document.') }}", "warning");
              return;
            }
            currentSession.documents = (currentSession.documents || []).filter((doc) => doc.id !== documentId);
            renderDocuments(currentSession.documents);
          })
          .catch(() => {
            showToast("{{ _('Unable to remove document.') }}", "warning");
          });
      }
    });
  }

  bootstrapSession();

  // Upgrade existing static messages with copy buttons if missing
  messagesEl.querySelectorAll(".assistant-message").forEach((bubble) => {
    if (!bubble.querySelector(".assistant-message-inner")) {
      const inner = document.createElement("div");
      inner.className = "assistant-message-inner";
      inner.innerHTML = bubble.innerHTML;
      bubble.innerHTML = "";
      bubble.appendChild(inner);
    }
    if (!bubble.dataset.raw) {
      bubble.dataset.raw = plainText(bubble.querySelector(".assistant-message-inner")?.innerHTML || "");
    }
    if (!bubble.querySelector(".assistant-copy-btn") && bubble.dataset.role !== "system") {
      bubble.appendChild(createCopyButton(bubble));
    }
  });

  // Speech recognition setup
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const speechLanguages = ["el-GR", "en-US"];
  let recognition = null;
  let recognitionLanguageIndex = 0;
  let isRecording = false;
  let transcriptBuffer = "";

  function resetMicState() {
    if (!micBtn) return;
    micBtn.classList.remove("active");
    micBtn.innerHTML = '<i class="fa fa-microphone"></i>';
    micBtn.setAttribute("title", speechStartLabel);
    micBtn.setAttribute("aria-label", speechStartLabel);
  }

  function setMicActive() {
    if (!micBtn) return;
    micBtn.classList.add("active");
    micBtn.innerHTML = '<i class="fa fa-stop"></i>';
    micBtn.setAttribute("title", speechStopLabel);
    micBtn.setAttribute("aria-label", speechStopLabel);
  }

  if (SpeechRecognition && micBtn) {
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isRecording = true;
      transcriptBuffer = "";
      setMicActive();
    };

    recognition.onresult = (event) => {
      let interimTranscript = "";
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const result = event.results[i];
        const transcript = result[0].transcript.trim();
        if (result.isFinal) {
          transcriptBuffer += transcript + " ";
        } else {
          interimTranscript += transcript + " ";
        }
      }
      if (interimTranscript && input) {
        input.placeholder = `${interimTranscript.trim()} …`;
      }
    };

    recognition.onerror = (event) => {
      if (recognitionLanguageIndex === 0 && event.error === "no-speech") {
        recognitionLanguageIndex = 1;
        recognition.lang = speechLanguages[recognitionLanguageIndex];
        try {
          recognition.start();
        } catch (startErr) {
          showToast("{{ _('Unable to start voice capture.') }}", "danger");
          resetMicState();
        }
        return;
      }
      showToast(event.error === "not-allowed" ? "{{ _('Microphone permission denied.') }}" : event.error, "warning");
      input.placeholder = "{{ _('Type your message...') }}";
      resetMicState();
    };

    recognition.onend = () => {
      isRecording = false;
      resetMicState();
      input.placeholder = "{{ _('Type your message...') }}";
      const finalText = transcriptBuffer.trim();
      if (!finalText && recognitionLanguageIndex === 0) {
        recognitionLanguageIndex = 1;
      }
      if (finalText) {
        if (input.value) {
          input.value = `${input.value.trim()} ${finalText}`.trim() + " ";
        } else {
          input.value = finalText + " ";
        }
        input.focus();
      }
    };

    function toggleRecognition() {
      if (!recognition) return;
      if (isRecording) {
        recognition.stop();
        return;
      }
      transcriptBuffer = "";
      recognitionLanguageIndex = 0;
      recognition.lang = speechLanguages[recognitionLanguageIndex];
      setMicActive();
      try {
        recognition.start();
      } catch (err) {
        showToast("{{ _('Unable to start voice capture.') }}", "danger");
        resetMicState();
      }
    }

    micBtn.addEventListener("click", toggleRecognition);
  } else if (micBtn) {
    micBtn.classList.add("assistant-mic-btn-disabled");
    micBtn.setAttribute("title", speechNotSupportedLabel);
    micBtn.setAttribute("aria-label", speechNotSupportedLabel);
    micBtn.addEventListener("click", () => showToast(speechNotSupportedLabel, "warning"));
  }
})();
</script>
