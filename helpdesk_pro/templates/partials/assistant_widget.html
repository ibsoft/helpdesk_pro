{% set cfg = assistant_widget_config %}
<style>
  .assistant-widget {
    position: fixed;
    bottom: 24px;
    z-index: 1080;
    display: flex;
    flex-direction: column-reverse;
    align-items: flex-end;
    gap: 0.75rem;
    pointer-events: none;
  }
  .assistant-widget.assistant-pos-left {
    left: 1.5rem;
    align-items: flex-start;
  }
  .assistant-widget.assistant-pos-right {
    right: 1.5rem;
  }
  .assistant-widget .assistant-fab {
    width: 58px;
    height: 58px;
    border-radius: 29px 29px 8px 29px;
    font-size: 1.4rem;
    box-shadow: 0 12px 24px rgba(13,110,253,0.25);
    pointer-events: auto;
  }
  .assistant-widget.assistant-pos-left .assistant-fab {
    border-radius: 29px 8px 29px 29px;
  }
  .assistant-panel {
    width: min(360px, 95vw);
    max-height: min(90vh, 1040px);
    display: flex;
    flex-direction: column;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 18px 36px rgba(15, 23, 42, 0.25);
    pointer-events: auto;
    transform: translateY(20px);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s ease, transform 0.25s ease, visibility 0.25s;
  }
  .assistant-widget.assistant-open .assistant-panel {
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
  }
  .assistant-messages {
    flex: 1 1 auto;
    padding: 1rem;
    overflow-y: auto;
    background: rgba(15, 23, 42, 0.03);
  }
  html[data-bs-theme="dark"] body .assistant-messages {
    background: rgba(15, 23, 42, 0.7);
  }
  .assistant-message {
    max-width: 90%;
    margin-bottom: 0.75rem;
    padding: 0.6rem 0.9rem;
    border-radius: 0.85rem;
    line-height: 1.45;
    font-size: 0.95rem;
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
  }
  .assistant-message-user {
    margin-left: auto;
    background: linear-gradient(135deg, #6366f1, #3b82f6);
    color: #fff;
  }
  .assistant-message-assistant {
    background: #ffffff;
    border: 1px solid rgba(148, 163, 184, 0.25);
  }
  html[data-bs-theme="dark"] body .assistant-message-assistant {
    background: rgba(15, 23, 42, 0.85);
    color: #e2e8f0;
    border-color: rgba(148, 163, 184, 0.35);
  }
  .assistant-message-system {
    font-size: 0.85rem;
    color: #475569;
    background: transparent;
    box-shadow: none;
    border: none;
    text-align: center;
  }
  .assistant-form {
    display: flex;
    gap: 0.5rem;
  }
  .assistant-form textarea {
    resize: none;
    min-height: 90px;
  }
  .assistant-spinner {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.85rem;
    color: #64748b;
  }
  html[data-bs-theme="dark"] body .assistant-spinner {
    color: #cbd5f5;
  }
  .assistant-badge {
    position: absolute;
    top: -6px;
    right: -6px;
  }
</style>

<div class="assistant-widget assistant-pos-{{ cfg.position }}" id="assistantWidgetRoot" data-provider="{{ cfg.provider }}">
  <button type="button" class="btn btn-danger assistant-fab position-relative" id="assistantToggle" aria-label="{{ cfg.button_label }}" title="{{ cfg.button_label }}">
    <i class="fa fa-comments"></i>
    <span class="badge bg-danger rounded-pill assistant-badge d-none" id="assistantUnreadBadge">1</span>
  </button>

  <div class="assistant-panel card" id="assistantPanel" aria-hidden="true">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <strong><i class="fa fa-robot text-primary"></i> {{ cfg.window_title }}</strong>
      </div>
      <button type="button" class="btn btn-sm btn-light" id="assistantClose">
        <i class="fa fa-xmark"></i>
      </button>
    </div>
    <div class="assistant-messages" id="assistantMessages">
      {% if cfg.welcome_message %}
        <div class="assistant-message assistant-message-assistant">
          {{ cfg.welcome_message }}
        </div>
      {% endif %}
    </div>
    <div class="card-footer">
      <form class="assistant-form" id="assistantForm">
        <textarea class="form-control" placeholder="{{ _('Type your message...') }}" id="assistantInput"></textarea>
        <button type="submit" class="btn btn-primary" id="assistantSend">
          <i class="fa fa-paper-plane"></i>
        </button>
      </form>
    </div>
  </div>
</div>

<script>
(function() {
  const config = {{ cfg|tojson }};
  const root = document.getElementById("assistantWidgetRoot");
  const panel = document.getElementById("assistantPanel");
  const toggleBtn = document.getElementById("assistantToggle");
  const closeBtn = document.getElementById("assistantClose");
  const form = document.getElementById("assistantForm");
  const input = document.getElementById("assistantInput");
  const messagesEl = document.getElementById("assistantMessages");
  const sendBtn = document.getElementById("assistantSend");
  const unreadBadge = document.getElementById("assistantUnreadBadge");

  if (!root || !form) return;

  const escapeHTML = (value) => (value || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  let history = [];
  let isOpen = false;
  let pending = false;

  function toggle(open) {
    isOpen = typeof open === "boolean" ? open : !isOpen;
    root.classList.toggle("assistant-open", isOpen);
    panel.setAttribute("aria-hidden", isOpen ? "false" : "true");
    if (isOpen) {
      unreadBadge.classList.add("d-none");
      setTimeout(() => input.focus(), 150);
    }
  }

  function appendMessage(role, content, options = {}) {
    const bubble = document.createElement("div");
    if (role === "user") {
      bubble.className = "assistant-message assistant-message-user";
    } else if (role === "assistant") {
      bubble.className = "assistant-message assistant-message-assistant";
    } else {
      bubble.className = "assistant-message assistant-message-system";
    }
    const safeContent = escapeHTML(content).replace(/\n/g, "<br>");
    bubble.innerHTML = options.spinner
      ? `<span class="assistant-spinner"><span class="spinner-border spinner-border-sm"></span> ${escapeHTML(content)}</span>`
      : safeContent;
    messagesEl.appendChild(bubble);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return bubble;
  }

  function submitMessage(message) {
    if (!message || pending) return;
    pending = true;
    sendBtn.disabled = true;
    input.value = "";

    appendMessage("user", message);
    history.push({ role: "user", content: message });

    const waitingIndicator = appendMessage("assistant", "{{ _('Thinking...') }}", { spinner: true });

    fetch("{{ url_for('assistant.api_message') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, history }),
    })
      .then(resp => resp.json())
      .then(data => {
        waitingIndicator.remove();
        if (!data.success) {
          showToast(data.message || "{{ _('Assistant error') }}", "danger");
          history.pop(); // remove last user message for retry
          appendMessage("assistant", "{{ _('Sorry, something went wrong.') }}");
          return;
        }
        history = data.history || history;
        appendMessage("assistant", data.reply || "");
        if (!isOpen) {
          unreadBadge.classList.remove("d-none");
        }
      })
      .catch(() => {
        waitingIndicator.remove();
        history.pop();
        appendMessage("assistant", "{{ _('Sorry, something went wrong.') }}");
        showToast("{{ _('Connection error') }}", "danger");
      })
      .finally(() => {
        pending = false;
        sendBtn.disabled = false;
      });
  }

  toggleBtn.addEventListener("click", () => toggle(true));
  closeBtn.addEventListener("click", () => toggle(false));

  form.addEventListener("submit", (event) => {
    event.preventDefault();
    const message = input.value.trim();
    submitMessage(message);
  });

  input.addEventListener("keydown", (event) => {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      submitMessage(input.value.trim());
    }
  });

  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && isOpen) {
      toggle(false);
    }
  });
})();
</script>
